<html><head></head><body>
<div id="_idContainer057">
<h1 class="chapter-number" id="_idParaDest-176"><a id="_idTextAnchor708"/><span class="koboSpan" id="kobo.1.1">10</span></h1>
<h1 id="_idParaDest-177"><a id="_idTextAnchor709"/><span class="koboSpan" id="kobo.2.1">Case Studies</span></h1>
<p><span class="koboSpan" id="kobo.3.1">Throughout this book, we’ve navigated the broad capabilities of NGINX, from delivering static content to implementing intricate load-balancing strategies. </span><span class="koboSpan" id="kobo.3.2">Your newfound knowledge extends from basic NGINX setup on servers to tailor-fit configurations for diverse web applications, enhanced by a variety of advanced modules that unlock </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">complex features.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">Now, it’s time to apply what we’ve learned through a series of real-world scenarios. </span><span class="koboSpan" id="kobo.5.2">Securing communications with HTTPS will be our foundational step, ensuring all interactions with your web services are encrypted by default. </span><span class="koboSpan" id="kobo.5.3">With this security measure in place, we’ll progress to setting up a complete WordPress site. </span><span class="koboSpan" id="kobo.5.4">Here, we’ll not only focus on getting your site live with NGINX but also on utilizing the secure channels we’ve established, integrating best practices for optimization and caching to </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">enhance performance.</span></span></p>
<p><span class="koboSpan" id="kobo.7.1">As we progress, the chapter will guide you in deploying a Nextcloud instance, illustrating how to establish a secure, private cloud </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">storage solution.</span></span></p>
<p><span class="koboSpan" id="kobo.9.1">This </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">chapter covers:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.11.1">SSL certificates and HTTPS </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">by default</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.13.1">Implementing HTTP/2</span></span></li>
<li><span class="koboSpan" id="kobo.14.1">Deploying WordPress, efficient </span><span class="No-Break"><span class="koboSpan" id="kobo.15.1">content management</span></span></li>
<li><span class="koboSpan" id="kobo.16.1">Deploying NextCloud, a robust personal </span><span class="No-Break"><span class="koboSpan" id="kobo.17.1">cloud service</span></span><a id="_idTextAnchor710"/><a id="_idTextAnchor711"/></li>
</ul>
<h1 id="_idParaDest-178"><a id="_idTextAnchor712"/><span class="koboSpan" id="kobo.18.1">Exploring SSL Certificates and HTTPS by default</span></h1>
<p><span class="koboSpan" id="kobo.19.1">Digital security is paramount, adopting a </span><em class="italic"><span class="koboSpan" id="kobo.20.1">security-first</span></em><span class="koboSpan" id="kobo.21.1"> approach is not just best practice—it’s essential. </span><span class="koboSpan" id="kobo.21.2">As such, plaintext transmission is no longer acceptable; SSL encryption is the </span><span class="No-Break"><span class="koboSpan" id="kobo.22.1">new standard.</span></span></p>
<p><span class="koboSpan" id="kobo.23.1">Recognizing this, we turn to </span><strong class="bold"><span class="koboSpan" id="kobo.24.1">acme.sh</span></strong><span class="koboSpan" id="kobo.25.1">, a </span><a id="_idIndexMarker518"/><span class="koboSpan" id="kobo.26.1">versatile tool favored for its flexibility in supporting a diverse range of certificate authorities and its capability to employ DNS APIs for the creation of wildcard certificates. </span><span class="koboSpan" id="kobo.26.2">To streamline our setup, we’ll craft a centralized NGINX configuration file for SSL, </span><strong class="source-inline"><span class="koboSpan" id="kobo.27.1">ssl.conf</span></strong><span class="koboSpan" id="kobo.28.1">, which will serve as a reusable component in all our secure site configurations. </span><span class="koboSpan" id="kobo.28.2">This foundation of SSL by default sets a robust stage for all web services </span><span class="No-Break"><span class="koboSpan" id="kobo.29.1">we deploy.</span></span></p>
<h2 id="_idParaDest-179"><a id="_idTextAnchor713"/><span class="koboSpan" id="kobo.30.1">Certificate Management with acme.sh</span></h2>
<p><span class="koboSpan" id="kobo.31.1">Step by step, we’ll learn </span><a id="_idIndexMarker519"/><span class="koboSpan" id="kobo.32.1">how to exploit acme.sh’ integration with </span><a id="_idIndexMarker520"/><span class="koboSpan" id="kobo.33.1">DNS APIs, simplifying the validation process for certificate issuance. </span><span class="koboSpan" id="kobo.33.2">By the end of this tutorial, you’ll have the knowledge you need to obtain your first signed </span><span class="No-Break"><span class="koboSpan" id="kobo.34.1">wildcard certificate.</span></span></p>
<p><span class="koboSpan" id="kobo.35.1">Let’s begin with the installation </span><span class="No-Break"><span class="koboSpan" id="kobo.36.1">of acme.sh:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.37.1">
root@nginx:~# curl https://get.acme.sh | sh</span></pre> <p><span class="koboSpan" id="kobo.38.1">Then add the alias “</span><strong class="source-inline"><span class="koboSpan" id="kobo.39.1">alias acme.sh=~/.acme.sh/acme.sh</span></strong><span class="koboSpan" id="kobo.40.1">” into the </span><span class="No-Break"><span class="koboSpan" id="kobo.41.1">file “/root/.bashrc”</span></span></p>
<p><span class="koboSpan" id="kobo.42.1">Verify acme.sh has been installed properly. </span><span class="koboSpan" id="kobo.42.2">First, make sure to close and reopen your terminal (or ssh session), as advised by the </span><span class="No-Break"><span class="koboSpan" id="kobo.43.1">installation script:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer052">
<span class="koboSpan" id="kobo.44.1"><img alt="Figure 10.1: acme.sh script inviting us to close and reopen the terminal session." src="image/B21787_10_1.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.45.1">Figure 10.1: acme.sh script inviting us to close and reopen the terminal session.</span></p>
<p><span class="koboSpan" id="kobo.46.1">Then run </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.47.1">acme.sh --version</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.48.1">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.49.1">
root@nginx:~# acme.sh --version
https://github.com/acmesh-official/acme.sh
v3.0.8</span></pre> <p><span class="koboSpan" id="kobo.50.1">Acme.sh has now been installed. </span><span class="koboSpan" id="kobo.50.2">We’ll be using acme.sh to generate a wildcard certificate but before we do so, let’s have a quick look at what is a wildcard certificate, why we want one, and how acme.sh will help us </span><span class="No-Break"><span class="koboSpan" id="kobo.51.1">generate one.</span></span></p>
<p><span class="koboSpan" id="kobo.52.1">Imagine the following: we own the domain </span><strong class="source-inline"><span class="koboSpan" id="kobo.53.1">example.com</span></strong><span class="koboSpan" id="kobo.54.1">. </span><span class="koboSpan" id="kobo.54.2">Using acme.sh, we’ll be generating one single certificate which will be valid for multiple domains. </span><span class="koboSpan" id="kobo.54.3">The first domain will be </span><strong class="source-inline"><span class="koboSpan" id="kobo.55.1">example.com</span></strong><span class="koboSpan" id="kobo.56.1"> and the second domain will be </span><strong class="source-inline"><span class="koboSpan" id="kobo.57.1">*.example.com</span></strong><span class="koboSpan" id="kobo.58.1">. </span><span class="koboSpan" id="kobo.58.2">There are many reasons why we want to </span><span class="No-Break"><span class="koboSpan" id="kobo.59.1">do this:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.60.1">First, to make things easier. </span><span class="koboSpan" id="kobo.60.2">No need to adapt the NGINX configuration to run on port 80 with specific folders. </span><span class="koboSpan" id="kobo.60.3">Once you have the certificate for your domain, you know you can use it for a subdomain, and reuse the same certificate for a </span><span class="No-Break"><span class="koboSpan" id="kobo.61.1">different subdomain.</span></span></li>
<li><span class="koboSpan" id="kobo.62.1">Second, to enhance the security of your infrastructure by preventing scanners. </span><span class="koboSpan" id="kobo.62.2">Each signed certificate is publicly available and you can find them with tools </span><span class="No-Break"><span class="koboSpan" id="kobo.63.1">like </span></span><a href="https://crt.sh"><span class="No-Break"><span class="koboSpan" id="kobo.64.1">https://crt.sh</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.65.1">.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.66.1">To generate </span><a id="_idIndexMarker521"/><span class="koboSpan" id="kobo.67.1">wildcard certificates, the fastest way is </span><a id="_idIndexMarker522"/><span class="koboSpan" id="kobo.68.1">through DNS API. </span><span class="koboSpan" id="kobo.68.2">This means that you will be creating a temporary subdomain to let the certificate authority know you own the domain. </span><span class="koboSpan" id="kobo.68.3">For example, you will be creating “yes-i-own-it-12345.example.com” and in exchange, the certificate authority will issue a certificate. </span><span class="koboSpan" id="kobo.68.4">We’ll learn how to do that automatically, by giving acme.sh the right to create temporary subdomains. </span><span class="koboSpan" id="kobo.68.5">Once set, your certificates will be renewed automatically, every </span><span class="No-Break"><span class="koboSpan" id="kobo.69.1">90 days.</span></span></p>
<p><span class="koboSpan" id="kobo.70.1">In this example, we will be using the Cloudflare API but know that acme.sh supports many more registrars, over a hundred registrars. </span><span class="koboSpan" id="kobo.70.2">The list is available in their official github repo, </span><span class="No-Break"><span class="koboSpan" id="kobo.71.1">here: </span></span><a href="https://github.com/acmesh-official/acme.sh/wiki/dnsapi"><span class="No-Break"><span class="koboSpan" id="kobo.72.1">https://github.com/acmesh-official/acme.sh/wiki/dnsapi</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.73.1">.</span></span></p>
<h2 id="_idParaDest-180"><a id="_idTextAnchor714"/><span class="koboSpan" id="kobo.74.1">acme.sh and the DNS API</span></h2>
<p><span class="koboSpan" id="kobo.75.1">Using </span><a id="_idIndexMarker523"/><span class="koboSpan" id="kobo.76.1">Cloudflare, let’s get the </span><span class="No-Break"><span class="koboSpan" id="kobo.77.1">API key:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer053">
<span class="koboSpan" id="kobo.78.1"><img alt="Figure 10.2: Obtaining the Cloudflare API key" src="image/B21787_10_2.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.79.1">Figure 10.2: Obtaining the Cloudflare API key</span></p>
<p><span class="koboSpan" id="kobo.80.1">As shown above, you can get the API key by going to </span><strong class="bold"><span class="koboSpan" id="kobo.81.1">Profile</span></strong><span class="koboSpan" id="kobo.82.1"> and then selecting </span><strong class="bold"><span class="koboSpan" id="kobo.83.1">View</span></strong><span class="koboSpan" id="kobo.84.1"> for </span><strong class="bold"><span class="koboSpan" id="kobo.85.1">Global </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.86.1">API Key</span></strong></span></p>
<p><span class="koboSpan" id="kobo.87.1">For this example, let’s</span><a id="_idIndexMarker524"/><span class="koboSpan" id="kobo.88.1"> say our API Key is </span><strong class="source-inline"><span class="koboSpan" id="kobo.89.1">abcd1234</span></strong><span class="koboSpan" id="kobo.90.1">. </span><span class="koboSpan" id="kobo.90.2">We will store it in </span><strong class="source-inline"><span class="koboSpan" id="kobo.91.1">/root/.acme.sh/account.conf</span></strong><span class="koboSpan" id="kobo.92.1"> alongside the email address used for your </span><span class="No-Break"><span class="koboSpan" id="kobo.93.1">Cloudflare account:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.94.1">
SAVED_CF_Key='abcd1234'
SAVED_CF_Email=my-cloudflare-account@personal.email</span></pre> <h2 id="_idParaDest-181"><a id="_idTextAnchor715"/><span class="koboSpan" id="kobo.95.1">Issuing a signed certificate</span></h2>
<p><span class="koboSpan" id="kobo.96.1">We’re now set to </span><a id="_idIndexMarker525"/><span class="koboSpan" id="kobo.97.1">have our first signed certificate. </span><span class="koboSpan" id="kobo.97.2">We’ve installed acme.sh and we’ve given acme.sh the right to access our domain </span><strong class="source-inline"><span class="koboSpan" id="kobo.98.1">example.com</span></strong><span class="koboSpan" id="kobo.99.1">. </span><span class="koboSpan" id="kobo.99.2">Our next step is to use acme.sh to issue </span><span class="No-Break"><span class="koboSpan" id="kobo.100.1">a certificate:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.101.1">
root@nginx:~# acme.sh --issue --dns dns_cf -d example.com -d *.example.com</span></pre> <p><span class="koboSpan" id="kobo.102.1">This command will make acme.sh contact Cloudflare to create temporary subdomains, then have a Certificate Authority (default: zerossl) sign the certificate it just generated, and will delete the </span><span class="No-Break"><span class="koboSpan" id="kobo.103.1">temporary subdomains.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer054">
<span class="koboSpan" id="kobo.104.1"><img alt="Figure 10.3: Confirmation that acme.sh generated and issued a signed certificate." src="image/B21787_10_3.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.105.1">Figure 10.3: Confirmation that acme.sh generated and issued a signed certificate.</span></p>
<p><span class="koboSpan" id="kobo.106.1">Congratulations on your</span><a id="_idIndexMarker526"/><span class="koboSpan" id="kobo.107.1"> first signed wildcard certificate! </span><span class="koboSpan" id="kobo.107.2">In the next subsection, we will be centralizing NGINX’ SSL configuration within one configuration, using our </span><span class="No-Break"><span class="koboSpan" id="kobo.108.1">existing certificate.</span></span></p>
<h2 id="_idParaDest-182"><a id="_idTextAnchor716"/><span class="koboSpan" id="kobo.109.1">Centralizing SSL Configuration with NGINX</span></h2>
<p><span class="koboSpan" id="kobo.110.1">In the last subsection, we’ve </span><a id="_idIndexMarker527"/><span class="koboSpan" id="kobo.111.1">learned how to obtain signed </span><a id="_idIndexMarker528"/><span class="koboSpan" id="kobo.112.1">certificates. </span><span class="koboSpan" id="kobo.112.2">We’re going to use these certificates in the NGINX configuration. </span><span class="koboSpan" id="kobo.112.3">The challenge we have is that depending on our setup, we might need to use the certificate in multiple places as it is valid for multiple subdomains. </span><span class="koboSpan" id="kobo.112.4">In order to avoid repetition, and to manage our configuration in the easiest way possible, we’ll write a configuration file that we will include later into other </span><span class="No-Break"><span class="koboSpan" id="kobo.113.1">configuration files.</span></span></p>
<p><span class="koboSpan" id="kobo.114.1">To begin, let’s write our file </span><strong class="source-inline"><span class="koboSpan" id="kobo.115.1">ssl.conf</span></strong><span class="koboSpan" id="kobo.116.1">. </span><span class="koboSpan" id="kobo.116.2">This file has to be stored within the NGINX configuration folder, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.117.1">/etc/nginx/</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.118.1">for example:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.119.1">
 ssl_certificate /root/.acme.sh/example.com/fullchain.cer;
 ssl_certificate_key /root/.acme.sh/example.com/example.com.key;
 ssl_protocols TLSv1.3;
 ssl_prefer_server_ciphers off;
 ssl_session_cache  builtin:1000  shared:SSL:10m;
 ssl_session_tickets on;
 ssl_stapling on;
 ssl_stapling_verify on;</span></pre> <p><span class="koboSpan" id="kobo.120.1">And that’s it! </span><span class="koboSpan" id="kobo.120.2">As we will deploy new projects, we will include this </span><strong class="source-inline"><span class="koboSpan" id="kobo.121.1">ssl.conf</span></strong><span class="koboSpan" id="kobo.122.1"> file to </span><span class="No-Break"><span class="koboSpan" id="kobo.123.1">save time.</span></span></p>
<p><span class="koboSpan" id="kobo.124.1">In the next section, we will </span><span class="No-Break"><span class="koboSpan" id="kobo.125.1">introduce HTTP/2.</span></span></p>
<h2 id="_idParaDest-183"><a id="_idTextAnchor717"/><span class="koboSpan" id="kobo.126.1">Implementing HTTP/2 with SSL</span></h2>
<p><strong class="bold"><span class="koboSpan" id="kobo.127.1">HTTP/2</span></strong><span class="koboSpan" id="kobo.128.1"> stands </span><a id="_idIndexMarker529"/><span class="koboSpan" id="kobo.129.1">as a significant evolution of the HTTP protocol, designed to enhance web performance and efficiency. </span><span class="koboSpan" id="kobo.129.2">With features like multiplexing, which allows for multiple requests and responses over a single connection, and header compression to minimize overhead, HTTP/2 makes web browsing noticeably faster and more resource-efficient. </span><span class="koboSpan" id="kobo.129.3">Another key feature is server push, where servers preemptively send resources to the client without waiting for a request, further optimizing </span><span class="No-Break"><span class="koboSpan" id="kobo.130.1">load times.</span></span></p>
<p><span class="koboSpan" id="kobo.131.1">Here’s how you can </span><a id="_idIndexMarker530"/><span class="koboSpan" id="kobo.132.1">enable</span><a id="_idIndexMarker531"/><span class="koboSpan" id="kobo.133.1"> HTTP/2 in your </span><span class="No-Break"><span class="koboSpan" id="kobo.134.1">server block:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.135.1">
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
…
}</span></pre> <p><span class="koboSpan" id="kobo.136.1">Be sure to activate HTTP/2 when setting up SSL, it is well-supported by modern browsers but requires a </span><span class="No-Break"><span class="koboSpan" id="kobo.137.1">secure connection.</span></span></p>
<p><span class="koboSpan" id="kobo.138.1">Although HTTP/3 offers promising advancements, it’s not quite ready for widespread production use just yet. </span><span class="koboSpan" id="kobo.138.2">We encourage you to keep an eye on its development as we believe it will be exciting to implement when it’s </span><span class="No-Break"><span class="koboSpan" id="kobo.139.1">fully ready.</span></span></p>
<p><span class="koboSpan" id="kobo.140.1">Coming next, we’ll walk through setting up a </span><strong class="bold"><span class="koboSpan" id="kobo.141.1">WordPress site</span></strong><span class="koboSpan" id="kobo.142.1"> with secure certificates and </span><span class="No-Break"><span class="koboSpan" id="kobo.143.1">HTTP/2 enabled.</span></span></p>
<h1 id="_idParaDest-184"><a id="_idTextAnchor718"/><span class="koboSpan" id="kobo.144.1">Deploying a WordPress site</span></h1>
<p><span class="koboSpan" id="kobo.145.1">WordPress</span><a id="_idIndexMarker532"/><span class="koboSpan" id="kobo.146.1"> is currently the most popular content management system on the entire web. </span><span class="koboSpan" id="kobo.146.2">According to Kinsta (</span><a href="https://kinsta.com/wordpress-market-share/"><span class="koboSpan" id="kobo.147.1">https://kinsta.com/wordpress-market-share/</span></a><span class="koboSpan" id="kobo.148.1">), its market share totals 42%. </span><span class="koboSpan" id="kobo.148.2">For a lot of web server administrators, setting up WordPress sites or blogs has become a common task, whether it is for personal or </span><span class="No-Break"><span class="koboSpan" id="kobo.149.1">profe</span><a id="_idTextAnchor719"/><span class="koboSpan" id="kobo.150.1">s</span><a id="_idTextAnchor720"/><span class="koboSpan" id="kobo.151.1">sional use.</span></span></p>
<h2 id="_idParaDest-185"><a id="_idTextAnchor721"/><span class="koboSpan" id="kobo.152.1">Preparing your server and obtaining WordPress</span></h2>
<p><span class="koboSpan" id="kobo.153.1">In this section, we will be getting your server ready for downloading and installing the WordPress application. </span><span class="koboSpan" id="kobo.153.2">There will be a few configuration files to go through to make sure WordPress </span><span class="No-Break"><span class="koboSpan" id="kobo.154.1">ru</span><a id="_idTextAnchor722"/><span class="koboSpan" id="kobo.155.1">n</span><a id="_idTextAnchor723"/><span class="koboSpan" id="kobo.156.1">s smoothly.</span></span></p>
<h3><span class="koboSpan" id="kobo.157.1">System requirements</span></h3>
<p><span class="koboSpan" id="kobo.158.1">The first step you need to go through</span><a id="_idIndexMarker533"/><span class="koboSpan" id="kobo.159.1"> to set up a WordPress site on a fresh new server is to make sure you have the necessary components installed and up to date: it is recommended that you run at least PHP 8.1 and MySQL Server 8. </span><span class="koboSpan" id="kobo.159.2">If you haven’t done so yet, running the following commands will provide a basic working environment with minimal PHP extensions. </span><span class="koboSpan" id="kobo.159.3">Under a Debian-based Linux </span><span class="No-Break"><span class="koboSpan" id="kobo.160.1">operating system:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.161.1">
# apt install mysql-server php8.1-fpm php8.1-mysql php8.1-gd php8.1-xml php8.1-mbstring php8.1-curl php8.1-zip</span></pre> <p><span class="koboSpan" id="kobo.162.1">If your server runs a Red Hat-based OS, such </span><span class="No-Break"><span class="koboSpan" id="kobo.163.1">as Fedora:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.164.1">
# dnf install mysql-server php8.1-fpm php8.1-mysqlnd php8.1-gd php8.1-xml php8.1-mbstring php8.1-curl php8.1-zip</span></pre> <p><span class="koboSpan" id="kobo.165.1">If you have an older version installed on your system, it is recommended that you upgrade to the latest available version using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.166.1">apt update &amp;&amp; apt upgrade</span></strong><span class="koboSpan" id="kobo.167.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.168.1">dnf upgrade --</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.169.1">refre</span><a id="_idTextAnchor724"/><span class="koboSpan" id="kobo.170.1">s</span><a id="_idTextAnchor725"/><span class="koboSpan" id="kobo.171.1">h</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.172.1"> commands.</span></span></p>
<h3><span class="koboSpan" id="kobo.173.1">PHP configuration</span></h3>
<p><span class="koboSpan" id="kobo.174.1">After making sure your server components </span><a id="_idIndexMarker534"/><span class="koboSpan" id="kobo.175.1">meet the minimum requirements, you should edit some of the settings, if you want WordPress to run smoothly. </span><span class="koboSpan" id="kobo.175.2">There are two main aspects of the PHP configuration you should look into. </span><span class="koboSpan" id="kobo.175.3">First, the default PHP configuration file (</span><strong class="source-inline"><span class="koboSpan" id="kobo.176.1">php.ini</span></strong><span class="koboSpan" id="kobo.177.1">) contains directives that you will probably want </span><span class="No-Break"><span class="koboSpan" id="kobo.178.1">to update:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.179.1">cgi.fix_pathinfo</span></strong><span class="koboSpan" id="kobo.180.1">: Set this value to </span><strong class="source-inline"><span class="koboSpan" id="kobo.181.1">0</span></strong><span class="koboSpan" id="kobo.182.1"> for security reasons, as we have seen in </span><a href="B21787_05.xhtml#_idTextAnchor557"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.183.1">Chapter 5</span></em></span></a><span class="No-Break"><span class="koboSpan" id="kobo.184.1">.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.185.1">post_max_size</span></strong><span class="koboSpan" id="kobo.186.1">: By default, the maximum size of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.187.1">POST</span></strong><span class="koboSpan" id="kobo.188.1"> request body is </span><strong class="source-inline"><span class="koboSpan" id="kobo.189.1">8</span></strong><span class="koboSpan" id="kobo.190.1"> megabytes. </span><span class="koboSpan" id="kobo.190.2">Increase the value if necessary; keep in mind that file uploads are usually performed via </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.191.1">POST</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.192.1"> requests.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.193.1">upload_max_filesize</span></strong><span class="koboSpan" id="kobo.194.1">: Set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.195.1">2</span></strong><span class="koboSpan" id="kobo.196.1"> megabytes by default, this will need to be increased if you want to allow uploading of </span><span class="No-Break"><span class="koboSpan" id="kobo.197.1">large files.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.198.1">date.timezone</span></strong><span class="koboSpan" id="kobo.199.1">: You will get a warning if you leave this blank as it is by default. </span><span class="koboSpan" id="kobo.199.2">Refer to </span><a href="https://php.net/manual/en/timezones.php"><span class="koboSpan" id="kobo.200.1">https://php.net/manual/en/timezones.php</span></a><span class="koboSpan" id="kobo.201.1"> to find out the proper value in </span><span class="No-Break"><span class="koboSpan" id="kobo.202.1">your situation.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.203.1">The second aspect of the configuration is the </span><a id="_idIndexMarker535"/><span class="koboSpan" id="kobo.204.1">PHP-FPM side. </span><span class="koboSpan" id="kobo.204.2">The main </span><strong class="source-inline"><span class="koboSpan" id="kobo.205.1">php-fpm.conf</span></strong><span class="koboSpan" id="kobo.206.1"> file does not require immediate changes, however, if you haven’t done so yet, you will need to create a </span><em class="italic"><span class="koboSpan" id="kobo.207.1">configuration pool</span></em><span class="koboSpan" id="kobo.208.1">: a set of configuration directives that apply to a particular website or application. </span><span class="koboSpan" id="kobo.208.2">This allows you to run the PHP processes under a specific user account, and optionally configure a specific network interface for communicating </span><span class="No-Break"><span class="koboSpan" id="kobo.209.1">with NGINX.</span></span></p>
<p><span class="koboSpan" id="kobo.210.1">Create a new pool by declaring its name </span><span class="No-Break"><span class="koboSpan" id="kobo.211.1">between brackets:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.212.1">
[wordpress]</span></pre> <p><span class="koboSpan" id="kobo.213.1">Append the following </span><span class="No-Break"><span class="koboSpan" id="kobo.214.1">configuration directives:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.215.1">
; Specify user account and group for the pool 
; We assume that you created a "wordpress" user and group  
user=wordpress 
group=wordpress 
; Network interface and listening port 
; Use 127.0.0.1 if Nginx runs on the same machine 
listen=127.0.0.1:9000 
; Only allow connections from local computer 
; Change this value if Nginx runs on a different machine 
allowed_clients=127.0.0.1</span></pre> <p><span class="koboSpan" id="kobo.216.1">Optionally, you may enable </span><em class="italic"><span class="koboSpan" id="kobo.217.1">chrooting</span></em><span class="koboSpan" id="kobo.218.1">: specify a root directory for the PHP processes of this pool. </span><span class="koboSpan" id="kobo.218.2">For example, if you set the chroot to </span><strong class="source-inline"><span class="koboSpan" id="kobo.219.1">/home/wordpress/www</span></strong><span class="koboSpan" id="kobo.220.1">, your PHP scripts will only be able to read files and directories within the specified path (any attempt to read or write a file or directory outside of </span><strong class="source-inline"><span class="koboSpan" id="kobo.221.1">/home/wordpress/www</span></strong><span class="koboSpan" id="kobo.222.1"> will systematically fail). </span><span class="koboSpan" id="kobo.222.2">It is highly recommended you enable this feature: should a security breach be discovered in the WordPress code, attackers would only be able to exploit files within the reach of your PHP process; the rest of your server would not </span><span class="No-Break"><span class="koboSpan" id="kobo.223.1">be compromised:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.224.1">
chroot /home/wordpress/www;</span></pre> <p><span class="koboSpan" id="kobo.225.1">Other configuration</span><a id="_idIndexMarker536"/><span class="koboSpan" id="kobo.226.1"> directives are documented at length in the default pool file supplied with PHP-FPM; their default values are suitable</span><a id="_idTextAnchor726"/> <a id="_idTextAnchor727"/><span class="koboSpan" id="kobo.227.1">in </span><span class="No-Break"><span class="koboSpan" id="kobo.228.1">most cases.</span></span></p>
<h3><span class="koboSpan" id="kobo.229.1">MySQL configuration</span></h3>
<p><span class="koboSpan" id="kobo.230.1">At the time of installing</span><a id="_idIndexMarker537"/><span class="koboSpan" id="kobo.231.1"> MySQL server, you were asked to set up administrator (</span><strong class="source-inline"><span class="koboSpan" id="kobo.232.1">root</span></strong><span class="koboSpan" id="kobo.233.1">) credentials. </span><span class="koboSpan" id="kobo.233.2">Since these credentials allow full access to the SQL server, including permissions on all databases, you should never use them in any of your PHP applications. </span><span class="koboSpan" id="kobo.233.3">The best practice is to create a separate MySQL user and to assign permissions on the database that will be used by </span><span class="No-Break"><span class="koboSpan" id="kobo.234.1">your application:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.235.1">Log in to your local MySQL server with the </span><span class="No-Break"><span class="koboSpan" id="kobo.236.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.237.1"> # mysql -u root -p</span></strong></pre></li> <li><span class="koboSpan" id="kobo.238.1">Create a new </span><span class="No-Break"><span class="koboSpan" id="kobo.239.1">SQL database:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.240.1">mysql&gt; CREATE DATABASE wordpress;</span></strong></pre></li> <li><span class="koboSpan" id="kobo.241.1">Create a SQL user and grant all permissions to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.242.1">wordpress</span></strong><span class="koboSpan" id="kobo.243.1"> database (don’t forget to specify a complex </span><span class="No-Break"><span class="koboSpan" id="kobo.244.1">enough password):</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.245.1">mysql&gt; GRANT ALL PRIVILEGES ON wordpress.* TO 'wordpress'@'localhost' IDENTIFIED BY 'password';</span></strong></pre></li> <li><span class="koboSpan" id="kobo.246.1">Now, run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.247.1">exit</span></strong><span class="koboSpan" id="kobo.248.1"> command to leave the MySQL console and try logging in to the server using the newly </span><span class="No-Break"><span class="koboSpan" id="kobo.249.1">created account:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.250.1">mysql&gt; exit </span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.251.1"># mysql -u wordpress -p </span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.252.1">mysql&gt; SHOW DATABASES;</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.253.1">You should see the </span><strong class="source-inline"><span class="koboSpan" id="kobo.254.1">wordpress</span></strong><span class="koboSpan" id="kobo.255.1"> database you crea</span><a id="_idTextAnchor728"/><span class="koboSpan" id="kobo.256.1">t</span><a id="_idTextAnchor729"/><span class="koboSpan" id="kobo.257.1">ed a </span><span class="No-Break"><span class="koboSpan" id="kobo.258.1">minute ago.</span></span></p></li> </ol>
<h3><span class="koboSpan" id="kobo.259.1">Downloading and extracting WordPress</span></h3>
<p><span class="koboSpan" id="kobo.260.1">The last step is to</span><a id="_idIndexMarker538"/><span class="koboSpan" id="kobo.261.1"> download the latest version of WordPress and extract it at the location specified earlier; in our example: </span><strong class="source-inline"><span class="koboSpan" id="kobo.262.1">/home/wordpress/www</span></strong><span class="koboSpan" id="kobo.263.1">. </span><span class="koboSpan" id="kobo.263.2">The latest</span><a id="_idIndexMarker539"/><span class="koboSpan" id="kobo.264.1"> version can always be found </span><span class="No-Break"><span class="koboSpan" id="kobo.265.1">at </span></span><a href="https://wordpress.org/latest.tar.gz"><span class="No-Break"><span class="koboSpan" id="kobo.266.1">https://wordpress.org/latest.tar.gz</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.267.1">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.268.1">
/home/wordpress/www# wget https://wordpress.org/latest.tar.gz
/home/wordpress/www# tar xzf latest.tar.gz
/home/wordpress/www# mv ./wordpress/* ./ &amp;&amp; rm -r ./wordpress</span></pre> <p><span class="koboSpan" id="kobo.269.1">Make sure the user and group are properly set, and give write permissions to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.270.1">wordpress</span></strong><span class="koboSpan" id="kobo.271.1"> user over the </span><span class="No-Break"><span class="koboSpan" id="kobo.272.1">application files:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.273.1">
/home/wordpress/www# chown -R wordpress ./
/home/wordpress/www# chgrp -R wordpress ./
/home/wordpress/www</span><a id="_idTextAnchor730"/><span class="koboSpan" id="kobo.274.1">#</span><a id="_idTextAnchor731"/><span class="koboSpan" id="kobo.275.1"> chmod -R 0644 ./</span></pre> <h2 id="_idParaDest-186"><a id="_idTextAnchor732"/><span class="koboSpan" id="kobo.276.1">NGINX configuration</span></h2>
<p><span class="koboSpan" id="kobo.277.1">Before you can begin</span><a id="_idIndexMarker540"/><span class="koboSpan" id="kobo.278.1"> setting up WordPress via the user-friendly web installer, you will need to finalize your NGINX server configuration. </span><span class="koboSpan" id="kobo.278.2">We will go down to every last detail in the </span><span class="No-Break"><span class="koboSpan" id="kobo.279.1">fo</span><a id="_idTextAnchor733"/><span class="koboSpan" id="kobo.280.1">l</span><a id="_idTextAnchor734"/><span class="koboSpan" id="kobo.281.1">lowing subsections.</span></span></p>
<h3><span class="koboSpan" id="kobo.282.1">HTTP block</span></h3>
<p><span class="koboSpan" id="kobo.283.1">We will be going down the</span><a id="_idIndexMarker541"/><span class="koboSpan" id="kobo.284.1"> blocks starting at the top level: the HTTP blocks, encompassing directives that have an effect on the entire server. </span><span class="koboSpan" id="kobo.284.2">This implies that the directives placed here will affect all of the websites served by this instance of NGINX. </span><span class="koboSpan" id="kobo.284.3">Open your NGINX main configuration file (</span><strong class="source-inline"><span class="koboSpan" id="kobo.285.1">nginx.conf</span></strong><span class="koboSpan" id="kobo.286.1">) and insert or update the </span><span class="No-Break"><span class="koboSpan" id="kobo.287.1">following directives:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.288.1">
# Sets the user and group under which the worker processes  
# will run. </span><span class="koboSpan" id="kobo.288.2">The following values are valid assuming your server  
# will only be hosting one website.  
user wordpress wordpress; 
worker_processes 8; # 1 process per core 
pid /var/run/nginx.pid; 
 
events { 
# Edit this value depending on your server hardware 
   worker_connections 768; 
} 
 
http { 
   # Core settings affecting I/O 
   sendfile on; 
   tcp_nopush on; 
   tcp_nodelay on; 
 
   # Default Nginx values 
   keepalive_timeout 65; 
   types_hash_max_size 2048; 
   include /etc/nginx/mime.types; 
   default_type application/octet-stream; 
 
   # Set access and error log paths 
   access_log /var/log/nginx/access.log; 
   error_log /var/log/nginx/error.log; 
 
   # Enable gzipping of files matching the given mime types 
   gzip on; 
    
   gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript; 
    
   # Include virtual host configuration files; 
   # Edit path accordingly 
   include /etc/nginx/</span><a id="_idTextAnchor735"/><span class="koboSpan" id="kobo.289.1">s</span><a id="_idTextAnchor736"/><span class="koboSpan" id="kobo.290.1">ites-enabled/*; 
}</span></pre> <h3><span class="koboSpan" id="kobo.291.1">Server block</span></h3>
<p><span class="koboSpan" id="kobo.292.1">The following step will </span><a id="_idIndexMarker542"/><span class="koboSpan" id="kobo.293.1">require you to create a new file in the directory specified earlier. </span><span class="koboSpan" id="kobo.293.2">For example, create a file called </span><strong class="source-inline"><span class="koboSpan" id="kobo.294.1">wordpress.conf</span></strong><span class="koboSpan" id="kobo.295.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.296.1">/etc/nginx/sites-available/</span></strong><span class="koboSpan" id="kobo.297.1"> folder. </span><span class="koboSpan" id="kobo.297.2">Define your virtual host configuration by inserting or updating the </span><span class="No-Break"><span class="koboSpan" id="kobo.298.1">following directives:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.299.1">
server {
#Default server on port 80
  Listen [::]:80 default_server;
  listen 80 default_server;
  server_name _;
#Always redirect to https
  return 301 https://$host$request_uri;
}
server { 
   # Listen on all network interfaces on port 443 SSL and HTTP2 
   listen 443 ssl http2;
   listen [::]:443 ssl http2;
   #Include ssl.conf created earlier
   include ssl.conf
 
   # Specify the host name(s) that will match the site 
   # The following value allows both www. </span><span class="koboSpan" id="kobo.299.2">and no subdomain 
   server_name .example.com; 
    
   # Set the path of your WordPress files 
   root /home/wordpress/www; 
 
   # Automatically load index.php 
   index index.php; 
    
   # Saves client request body into files, cleaning up afterwards 
   client_body_in_file_only clean; 
   client_body_buffer_size 32K; 
 
   # Allow uploaded files up to 300 megabytes 
   client_max_body_size 300M; 
    
   # Automatically close connections if no data is  
   # transmitted to the client for a period of 10 seconds 
   send_timeout 10s; 
    
   # The rest of the configuration (location blocks)  
   # is foun</span><a id="_idTextAnchor737"/><span class="koboSpan" id="kobo.300.1">d below 
   [...] 
}</span></pre> <p><span class="koboSpan" id="kobo.301.1">Once done, create a symlink for /etc/NGINX/sites-available/wordpress.conf in /etc/NGINX/sites-enabled/ with the following command: </span><strong class="source-inline"><span class="koboSpan" id="kobo.302.1">ln -s /</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.303.1">etc/nginx/sites-available/wordpress.conf /etc</span><a id="_idTextAnchor738"/><span class="koboSpan" id="kobo.304.1">/nginx/sites-enabled/</span></strong></span></p>
<h3><span class="koboSpan" id="kobo.305.1">Location blocks</span></h3>
<p><span class="koboSpan" id="kobo.306.1">Finally, set up</span><a id="_idIndexMarker543"/><span class="koboSpan" id="kobo.307.1"> your </span><strong class="source-inline"><span class="koboSpan" id="kobo.308.1">location</span></strong><span class="koboSpan" id="kobo.309.1"> blocks—directives that apply to specific locations on </span><span class="No-Break"><span class="koboSpan" id="kobo.310.1">your site:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.311.1">
   # The following applies to static files:  
   # images, CSS, javascript 
   location ~* ^.+.(jpg|jpeg|png|gif|ico|css|js)$ { 
         access_log off; # Disable logging 
         # Allow client browsers to cache files  
         # for a long period of time 
         expires max;  
   } 
 
   # The following applies to every request 
   location / { 
      # Try serving the requested URI: 
      # - If the file does not exist, append / 
      # - If the directory does not exist,  
      # redirect to /index.php forwarding the request URI 
      # and other request arguments 
         try_files $uri $uri/ /index.php?q=$uri&amp;$args; 
   } 
    
   # The following applies to every PHP file 
   location ~ .php$ { 
         # Ensure file really exists 
            if (!-e $request_filename) { 
                  return 404; 
            } 
            # Pass the request to your PHP-FPM backend 
            fastcgi_pass 127.0.0.1:9000; 
         fastcgi_index index.php; 
         fastcgi_param PATH_INFO $fastcgi_script_name; 
         include </span><a id="_idTextAnchor739"/><span class="koboSpan" id="kobo.312.1">f</span><a id="_idTextAnchor740"/><span class="koboSpan" id="kobo.313.1">astcgi_params; 
   }
}</span></pre> <h2 id="_idParaDest-187"><a id="_idTextAnchor741"/><span class="koboSpan" id="kobo.314.1">WordPress configuration</span></h2>
<p><span class="koboSpan" id="kobo.315.1">Once your NGINX configuration is </span><a id="_idIndexMarker544"/><span class="koboSpan" id="kobo.316.1">finalized and saved, make sure to reload the NGINX configuration, either via </span><strong class="source-inline"><span class="koboSpan" id="kobo.317.1">systemctl reload nginx</span></strong><span class="koboSpan" id="kobo.318.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.319.1">/usr/local/nginx/sbin/nginx -s reload</span></strong><span class="koboSpan" id="kobo.320.1"> (or your usual NGINX </span><span class="No-Break"><span class="koboSpan" id="kobo.321.1">binary location).</span></span></p>
<p><span class="koboSpan" id="kobo.322.1">If all goes well, you should be able to run the web-based WordPress installer by visiting </span><strong class="source-inline"><span class="koboSpan" id="kobo.323.1">https://example.com/wp-admin/install.php</span></strong><span class="koboSpan" id="kobo.324.1"> (replacing </span><strong class="source-inline"><span class="koboSpan" id="kobo.325.1">example.com</span></strong><span class="koboSpan" id="kobo.326.1"> by your own domain name). </span><span class="koboSpan" id="kobo.326.2">You will be </span><span class="No-Break"><span class="koboSpan" id="kobo.327.1">prompted for:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.328.1">The name of the database you created earlier, in our </span><span class="No-Break"><span class="koboSpan" id="kobo.329.1">example: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.330.1">wordpress</span></strong></span></li>
<li><span class="koboSpan" id="kobo.331.1">The SQL username you created earlier, in our </span><span class="No-Break"><span class="koboSpan" id="kobo.332.1">example: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.333.1">wordpress</span></strong></span></li>
<li><span class="koboSpan" id="kobo.334.1">The password associated to the </span><span class="No-Break"><span class="koboSpan" id="kobo.335.1">user: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.336.1">password</span></strong></span></li>
<li><span class="koboSpan" id="kobo.337.1">The database host: </span><strong class="source-inline"><span class="koboSpan" id="kobo.338.1">127.0.0.1</span></strong><span class="koboSpan" id="kobo.339.1">, if your MySQL server is hosted on the </span><span class="No-Break"><span class="koboSpan" id="kobo.340.1">same server</span></span></li>
<li><span class="koboSpan" id="kobo.341.1">A prefix for all SQL tables created by </span><span class="No-Break"><span class="koboSpan" id="kobo.342.1">WordPress: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.343.1">wp_</span></strong></span></li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer055">
<span class="koboSpan" id="kobo.344.1"><img alt="Figure 10.4: WordPress database installation page" src="image/B21787_10_4.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.345.1">Figure 10.4: WordPress database installation page</span></p>
<p><span class="koboSpan" id="kobo.346.1">Once the installer </span><a id="_idIndexMarker545"/><span class="koboSpan" id="kobo.347.1">completes, you can begin configuring and preparing your WordPress site. </span><span class="koboSpan" id="kobo.347.2">In order to enable pretty URLs, you should check the </span><strong class="bold"><span class="koboSpan" id="kobo.348.1">Settings</span></strong><span class="koboSpan" id="kobo.349.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.350.1">Permalinks</span></strong><span class="koboSpan" id="kobo.351.1"> section: several URL schemes are offered, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.352.1">https://example.com/post-name/</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.353.1">or </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.354.1">https://example.com</span><a id="_idTextAnchor742"/><a id="_idTextAnchor743"/><span class="koboSpan" id="kobo.355.1">/year/month/post-name/</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.356.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.357.1">…We’ve deployed Wordpress. </span><span class="koboSpan" id="kobo.357.2">In the next section, we’ll be deploying Nextcloud alongside Wordpress using Docker to properly isolate our configurations for W</span><a id="_idTextAnchor744"/><span class="koboSpan" id="kobo.358.1">ordpress </span><span class="No-Break"><span class="koboSpan" id="kobo.359.1">and Nextcloud.</span></span></p>
<h1 id="_idParaDest-188"><a id="_idTextAnchor745"/><span class="koboSpan" id="kobo.360.1">Deploying Nextcloud</span></h1>
<p><strong class="bold"><span class="koboSpan" id="kobo.361.1">Nextcloud</span></strong><span class="koboSpan" id="kobo.362.1"> represents</span><a id="_idIndexMarker546"/><span class="koboSpan" id="kobo.363.1"> the pinnacle of self-hosted cloud services, offering not just file storage, but also integrated calendars, contacts, and collaboration tools. </span><span class="koboSpan" id="kobo.363.2">As an open-source solution, it provides transparency and control, ensuring that your data is </span><span class="No-Break"><span class="koboSpan" id="kobo.364.1">truly yours.</span></span></p>
<p><span class="koboSpan" id="kobo.365.1">In this section, we will navigate the setup of Nextcloud on an NGINX server, emphasizing secure communication through validated SSL certificates. </span><span class="koboSpan" id="kobo.365.2">This will complement the multi-application hosting environment we’ve cultivated with NGINX, where it serves both the dynamic content management</span><a id="_idIndexMarker547"/><span class="koboSpan" id="kobo.366.1"> of WordPress and the robust data ecosystem </span><span class="No-Break"><span class="koboSpan" id="kobo.367.1">of Nextcloud.</span></span></p>
<h2 id="_idParaDest-189"><a id="_idTextAnchor746"/><span class="koboSpan" id="kobo.368.1">Getting Nextcloud</span></h2>
<p><span class="koboSpan" id="kobo.369.1">As we’ve already</span><a id="_idIndexMarker548"/><span class="koboSpan" id="kobo.370.1"> configured NGINX to serve our WordPress site, optimized specifically for WordPress’s unique requirements, we’ll now employ Docker to host Nextcloud. </span><span class="koboSpan" id="kobo.370.2">This approach ensures isolation and flexibility without disrupting our current setup. </span><span class="koboSpan" id="kobo.370.3">We’ll use Docker’s containerization to seamlessly integrate Nextcloud alongside WordPress. </span><span class="koboSpan" id="kobo.370.4">More exactly, we’ll deploy the NextCloud All-In-One image which features an integrated Apache web server, and proxy it through NGINX. </span><span class="koboSpan" id="kobo.370.5">Please refer back to </span><a href="B21787_08.xhtml#_idTextAnchor688"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.371.1">Chapter 8</span></em></span></a><span class="koboSpan" id="kobo.372.1"> for guidance on setting up Docker </span><span class="No-Break"><span class="koboSpan" id="kobo.373.1">if needed.</span></span></p>
<p><span class="koboSpan" id="kobo.374.1">So, let’s </span><span class="No-Break"><span class="koboSpan" id="kobo.375.1">get started:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.376.1">We’ll create a directory </span><strong class="source-inline"><span class="koboSpan" id="kobo.377.1">/root/nextcloud</span></strong><span class="koboSpan" id="kobo.378.1"> and within this folder, we’ll create the file </span><strong class="source-inline"><span class="koboSpan" id="kobo.379.1">docker-compose.yml</span></strong><span class="koboSpan" id="kobo.380.1"> with the official All-In-One Nextcloud Docker image. </span><span class="koboSpan" id="kobo.380.2">Please refer to their online github to get the latest docker compose file. </span><span class="koboSpan" id="kobo.380.3">Currently, it looks </span><span class="No-Break"><span class="koboSpan" id="kobo.381.1">like this:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.382.1">
services:
  nextcloud-aio-mastercontainer:
    image: nextcloud/all-in-one:latest
    init: true
    restart: always
    container_name: nextcloud-aio-mastercontainer
    volumes:
      - nextcloud_aio_mastercontainer:/mnt/docker-aio-config
      - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
      - 8080:8080
      - "127.0.0.1:11000:11000"
    environment:
      - APACHE_PORT=11000
volumes:
  nextcloud_aio_mastercontainer:
    name: nextcloud_aio_mastercontainer</span></pre></li> <li><span class="koboSpan" id="kobo.383.1">We’ve saved the file in our </span><strong class="source-inline"><span class="koboSpan" id="kobo.384.1">directory /root/nextcloud</span></strong><span class="koboSpan" id="kobo.385.1">. </span><span class="koboSpan" id="kobo.385.2">Within this directory, let’s start </span><span class="No-Break"><span class="koboSpan" id="kobo.386.1">the container:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.387.1">docker compose up -d</span></strong></pre></li> <li><span class="koboSpan" id="kobo.388.1">Now that our container is running, we’ll need to add a server block into NGINX, in order to create a reverse proxy for Nextcloud. </span><span class="koboSpan" id="kobo.388.2">Fortunately for us, Nextcloud provides us with a configuration </span><a id="_idIndexMarker549"/><span class="koboSpan" id="kobo.389.1">sample, available on their github repository (Nextcloud AIO reverse proxy). </span><span class="koboSpan" id="kobo.389.2">Here’s how the NGINX configuration file should look like. </span><span class="koboSpan" id="kobo.389.3">We’ll save this file </span><span class="No-Break"><span class="koboSpan" id="kobo.390.1">into </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.391.1">/etc/nginx/sites-enabled/nextcloud.conf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.392.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.393.1">
server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  include ssl.conf;
  server_name nextcloud.example.com;
    location / {
        proxy_pass http://127.0.0.1:11000$request_uri;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_set_header X-Forwarded-Scheme $scheme;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Accept-Encoding "";
        proxy_set_header Host $host;
        client_body_buffer_size 512k;
        proxy_read_timeout 86400s;
        client_max_body_size 0;
        # Websocket
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }
}</span></pre></li> <li><span class="koboSpan" id="kobo.394.1">Make sure to test your </span><a id="_idIndexMarker550"/><span class="koboSpan" id="kobo.395.1">configuration and reload the NGINX server, before getting ready to set </span><span class="No-Break"><span class="koboSpan" id="kobo.396.1">up Nextcloud:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer056">
<span class="koboSpan" id="kobo.397.1"><img alt="Figure 10.5: Nextcloud default installation page" src="image/B21787_10_5.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.398.1">Figure 10.5: Nextcloud default installation page</span></p>
<p><span class="koboSpan" id="kobo.399.1">There you have it, your Nextcloud server is ready for action. </span><span class="koboSpan" id="kobo.399.2">For further customization and detailed configurations, the Nextcloud official documentation is an excellent resource. </span><span class="koboSpan" id="kobo.399.3">You can</span><a id="_idIndexMarker551"/><span class="koboSpan" id="kobo.400.1"> find it</span><a id="_idIndexMarker552"/> <span class="No-Break"><span class="koboSpan" id="kobo.401.1">at </span></span><a href="http://nextcloud.com"><span class="No-Break"><span class="koboSpan" id="kobo.402.1">nextcloud.com</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.403.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.404.1">With the foundations laid, you’re now equipped to deploy numerous servers, utilizing Docker for containerization or installing directly on the host. </span><span class="koboSpan" id="kobo.404.2">Just remember to use compatible </span><span class="No-Break"><span class="koboSpan" id="kobo.405.1">software versions.</span></span></p>
<p><span class="koboSpan" id="kobo.406.1">In the next section, we’ll recap the key points covered in </span><span class="No-Break"><span class="koboSpan" id="kobo.407.1">this chapter.</span></span></p>
<h1 id="_idParaDest-190"><a id="_idTextAnchor747"/><span class="koboSpan" id="kobo.408.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.409.1">Throughout this chapter, we’ve mastered the art of generating verified SSL certificates with acme.sh, tapping into DNS APIs for efficiency. </span><span class="koboSpan" id="kobo.409.2">We’ve explored the enhancements offered by HTTP/2 and laid the groundwork for HTTP/3, setting the stage for optimal web performance. </span><span class="koboSpan" id="kobo.409.3">This knowledge has empowered us to deploy a WordPress site, fortified with SSL and best security practices such as chroot environments. </span><span class="koboSpan" id="kobo.409.4">Additionally, we’ve taken a deep dive into Docker by deploying a Nextcloud server, demonstrating our ability to manage multiple services on a single </span><span class="No-Break"><span class="koboSpan" id="kobo.410.1">server seamlessly.</span></span></p>
<p><span class="koboSpan" id="kobo.411.1">As you may have noticed in the cases we studied in this chapter, the process of setting up a web application can sometimes be long and complex. </span><span class="koboSpan" id="kobo.411.2">But when it comes to the part that concerns NGINX, the configuration is usually pretty simple and straightforward: a couple of directives in a server block, reload the server, and </span><span class="No-Break"><span class="koboSpan" id="kobo.412.1">you’re done.</span></span></p>
<p><span class="koboSpan" id="kobo.413.1">Unfortunately, in some cases, while your initial configuration seems to do the trick, you realize over time that your visitors run into a variety of problems or are presented with unexpected error pages. </span><span class="koboSpan" id="kobo.413.2">The next chapter will prepare you to face such issues by exploring several leads, should you ever need to</span><a id="_idTextAnchor748"/><span class="koboSpan" id="kobo.414.1"> troubleshoot your </span><span class="No-Break"><span class="koboSpan" id="kobo.415.1">web server.</span></span></p>
</div>
</body></html>