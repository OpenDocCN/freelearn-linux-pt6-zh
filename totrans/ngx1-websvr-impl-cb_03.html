<html><head></head><body><div class="chapter" title="Chapter&#xA0;3.&#xA0;Get It All Logged: The Logging Module"><div class="titlepage"><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Get It All Logged: The Logging Module</h1></div></div></div><p>In this chapter, we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Setting up error log path and levels</li><li class="listitem" style="list-style-type: disc">Logging it like Apache</li><li class="listitem" style="list-style-type: disc">Disabling logging of 404 in error logs</li><li class="listitem" style="list-style-type: disc">Using different logging profiles in the same setup</li><li class="listitem" style="list-style-type: disc">Enabling a log file cache</li><li class="listitem" style="list-style-type: disc">Utilizing separate error logs per virtual host</li><li class="listitem" style="list-style-type: disc">Setting up log rotation</li><li class="listitem" style="list-style-type: disc">Enabling remote logging with syslog-ng</li><li class="listitem" style="list-style-type: disc">Setting up your custom logs for easy parsing</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec01"/>Introduction</h1></div></div></div><p><a class="indexterm" id="id81"/>
This chapter aims to teach the basics as well as the advanced configurations that can be done around the Nginx logging module, like log management, backup, rotation, and more. Logging is very crucial as it can help you identify and track various attributes of your application, like performance, user behavior, and much more. It also helps you as a system administrator to identify, both reactively and proactively, potential security issues.</p></div></div>
<div class="section" title="Setting up error log path and levels"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec02"/>Setting up error log path and levels</h1></div></div></div><p>The basic configurations that one needs to get the logging modules working properly are setting up the location of the logging files and configuring the level of the logging that will take place.<a class="indexterm" id="id82"/>
</p><p>Nginx allows a clear separation of the access and the error logs, thus letting you easily track your error lists.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec01"/>How to do it...</h2></div></div></div><p>You can use the following configuration to setup a file path for logging in addition to setting the format in which to log in:<a class="indexterm" id="id83"/>
</p><div class="informalexample"><pre class="programlisting">http {
log_format combined '$remote_addr - $remote_user [$time_local] '
'"$request" $status $body_bytes_sent '
'"$http_referer" "$http_user_agent"';
access_log /var/log/nginx/access.log combined;
error_log /var/log/nginx/error.log crit;
...
</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec02"/>How it works...</h2></div></div></div><p>This simple configuration will allow us to log the various HTTP activities that occur on all the sites hosted in the particular environment. Here is a sample log from the access log:</p><div class="informalexample"><pre class="programlisting">204.15.240.18 - - [11/Nov/2010:10:57:50 -0800] "GET /public/images-redux/infobox_join_type.png HTTP/1.1" 200 10212 "http://example.com/public/css/style-redux.css" "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.9.2.10) Gecko/20100914 Firefox/3.6.10"
</pre></div><p>It is easy to see how the various variables are outputted in order, as defined with the combined format.</p><p>The error log, which is now logged at<code class="literal"> /var/log/nginx/error.log</code>, will start logging all the critical errors, and here is a sample entry from an error log:</p><div class="informalexample"><pre class="programlisting">2010/11/11 10:07:28 [error] 3172#0: accept() failed (53: Software caused connection abort)
2010/11/11 10:15:12 [error] 3175#0: *136332 open() "/root/sites/app/public/images/fancybox/blank.gif" failed (2: No such file or directory), client: 122.176.248.115, server: example1.com, request: "GET /public/images/fancybox/blank.gif HTTP/1.1", host: "example1.com", referrer: "http://example1.com/"
</pre></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec03"/>There's more...</h2></div></div></div><p>You can change the level of error logging (error_log) to<code class="literal"> debug,info,notice,warn ,error,crit</code>, or<code class="literal"> alert</code>, based upon your application needs. It is usually best to try out the various levels to understand what exactly it outputs, and weather that can satisfy your current debugging needs.</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left" width="1.175"/><col style="text-align: left" width="2.195"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Error level</p>
</th><th style="text-align: left" valign="bottom">
<p>What does it mean?</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Alert</p>
</td><td style="text-align: left" valign="top">
<p>Emergency conditions</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Crit</p>
</td><td style="text-align: left" valign="top">
<p>Critical conditions</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Error</p>
</td><td style="text-align: left" valign="top">
<p>Error conditions</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Warn</p>
</td><td style="text-align: left" valign="top">
<p>Warning conditions</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Notice</p>
</td><td style="text-align: left" valign="top">
<p>Normal, but significant conditions</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Info</p>
</td><td style="text-align: left" valign="top">
<p>Information messages</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Debug</p>
</td><td style="text-align: left" valign="top">
<p>Debug-level messages</p>
</td></tr></tbody></table></div></div></div>
<div class="section" title="Logging it like Apache"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec03"/>Logging it like Apache</h1></div></div></div><p>Apache or httpd is the most used open source web server out there. It has a very stable codebase and community which has made it more or less the standard for open source enterprise applications out there.<a class="indexterm" id="id84"/>
</p><p>Most of the log analyzers are configured with Apache logging format in mind. Our goal in this recipe is to enable us to use log analyzing tools which already work well with Apache in our Nginx setup.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec04"/>How to do it...</h2></div></div></div><p>If you want the log to look like the Apache logs, you will need to enter the following code:<a class="indexterm" id="id85"/>
</p><div class="informalexample"><pre class="programlisting">log_format main '$remote_addr - $remote_user [$time_local] '
'"$request" $status $body_bytes_sent "$http_referer" '
'"$http_user_agent" "$http_x_forwarded_for"';
access_log /var/log/nginx/access.log main;
</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec05"/>How it works...</h2></div></div></div><p>In this, we basically create a new Apache compatible format which will be easily read with tools like AWStats. We then set the standard as the Nginx access log format in the preceding configuration. The format has the following fields:<a class="indexterm" id="id86"/>
</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left" width="1.825"/><col style="text-align: left" width="3.60652777777778"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Variable</p>
</th><th style="text-align: left" valign="bottom">
<p>What is it?</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$remote_addr</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the IP of the remote address that was accessing the site.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$remote_user</code>
</p>
</td><td style="text-align: left" valign="top">
<p>If the user is logged in with HTTP authentication, this would be their username.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$time_local</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the local timestamp of the server when the request was made.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$request</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The request that was made on the server.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$status</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The HTTP response code (200, 404, 500, and so on).</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$body_bytes_sent</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the size of the response that was sent to the server.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$http_referer</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the site from where the user has arrived on to this particular page/made this HTTP request.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$http_user_agent</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the browser type that was used to make this HTTP request.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$http_x_forwarded_for</code>
</p>
</td><td style="text-align: left" valign="top">
<p>If the server is running as a reverse proxy then this will display the actual IP of the server.</p>
</td></tr></tbody></table></div><div class="informalexample"><pre class="programlisting">66.249.64.13 - - [18/Sep/2004:11:07:48 +1000] "GET /robots.txt HTTP/1.0" 200 468 "-" "Googlebot/2.1"
66.249.64.13 - - [18/Sep/2004:11:07:48 +1000] "GET / HTTP/1.0" 200 6433 "-" "Googlebot/2.1"
</pre></div><p>The preceding lines from the access log display the format in action. This particular format will easily work with all the web log parsing and analyzing tools, such as webalizer and AWStats, with no changes at all.<a class="indexterm" id="id87"/>
</p></div></div>
<div class="section" title="Disabling logging of 404 in error logs"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec04"/>Disabling logging of 404 in error logs</h1></div></div></div><p>In the age of Google, we can see that there are thousands of crawlers out there trying to get the most out of your site and content by reading through all your pages. In a lot of situations, when you update or upgrade a site, these crawlers start to take up system resources by trying to access pages that used to exist and do not anymore. This also increases the system overheads of logging and can potentially become a bottleneck for your site. This recipe will address this particular issue.<a class="indexterm" id="id88"/>
</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec06"/>How to do it...</h2></div></div></div><p>This piece of configuration is placed in the location context of the configuration, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">location = /robots.txt {
log_not_found off;
}
</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec07"/>How it works...</h2></div></div></div><p>This simple configuration will not log when the<code class="literal"> /robots.txt</code> file is not found on the server. This will save the unnecessary overhead of opening the error log file and writing out an 404 entry indicating that the file, robots.txt(cit) is being found.</p></div></div>
<div class="section" title="Using different logging profiles in the same setup"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec06"/>Using different logging profiles in the same setup</h1></div></div></div><p>As we have seen before, Nginx allows you to easily set up a logging format. In this recipe, we will explore how one configuration file can exploit multiple logging formats. This neat functionality can help you generate custom logs specific to a particular section of the site whenever necessary.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec08"/>How to do it...</h2></div></div></div><p>This particular configuration will implement three logging formats and then effectively utilize them for logging different sections of the site:<a class="indexterm" id="id89"/>
</p><div class="informalexample"><pre class="programlisting">http {
log_format main '$remote_addr - $remote_user [$time_local] '
'"$request" $status $body_bytes_sent "$http_referer" '
'"$http_user_agent" "$http_x_forwarded_for"';
# You do not need HTTP authentication information and Refer information for the static files !
log_format static_main '$remote_addr [$time_local] '
'"$request" $status $body_bytes_sent
'"$http_user_agent";
# You do not need to know about the bytes sent in an error logging case
log_format error_main '$remote_addr - $remote_user [$time_local] '
'"$request" $status "$http_user_agent";
...
server {
listen 80;
server_name example1.com;
error_log var/log/nginx/example1_error.log error_main;
location / {
...
access_log /var/log/nginx/example1_main.log main;
}
location /static/ {
...
access_log /var/log/nginx/example1_static.log static_main;
}
}
...
}
</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec09"/>How it works...</h2></div></div></div><p>The<code class="literal"> main</code> log format will be used to log the normal dynamic PHP request, while the<code class="literal"> static_main</code> log format is being used to log the static requests that come to Nginx. Finally we use an<code class="literal"> error_main</code> format to keep track of the errors.<a class="indexterm" id="id90"/>
</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec10"/>There's more...</h2></div></div></div><p>You have access to the following variables to use in the<code class="literal"> log_format</code> structure. These can be utilized effectively to gather and understand whatever Nginx can access in your stack:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left" width="1.586875"/><col style="text-align: left" width="3.83275173611111"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Variable</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$arg_PARAMETER</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This variable contains the value of the GET request variable PARAMETER if present in the query string.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$args</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This variable is the GET parameter's in request line, for example,<code class="literal"> foo=123&amp;bar=blahblah</code>.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$binary_remote_addr</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The address of the client in binary form.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$body_bytes_sent</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The bytes of the body sent.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$content_length</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This variable is equal to line Content-Length in the header of request.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$content_type</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This variable is equal to line Content-Type in the header of request.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$document_root</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This variable is equal to the value of directive root for the current request.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$document_uri</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The same as<code class="literal"> $uri</code>.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$host</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This variable is equal to line Host in the header of request or name of the server processing the request if the Host header is not available. This variable may have a different value from<code class="literal"> $http_host</code> when the Host input header is absent or has an empty value.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$http_HEADER</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The value of the HTTP header HEADER when converted to lowercase and with "dashes" converted to "underscores", for example,<code class="literal"> $http_user_agent, $http_referer</code>.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$is_args</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Evaluates to "?" if<code class="literal"> $args</code> is set, returns "" otherwise.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$request_uri</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This variable is equal to the *original* request URI as received from the client including the args. It cannot be modified. Look at<code class="literal"> $uri</code> for the post-rewrite/altered URI. Does not include host name. Example:<code class="literal">"/foo/bar.php?arg=baz"</code>.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$scheme</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The HTTP scheme (that is http, https). Evaluated only on demand, for example:</p>
<p>
<code class="literal">rewrite ^(.+)$ $scheme://example.com$1 redirect</code>;</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$server_addr</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Equal to the server address. As a rule, for obtaining the value of this variable is done one system call. In order to avoid system call, it is necessary to indicate addresses in directives, listen, and to use parameter bind.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$server_name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The name of the server.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$server_port</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This variable is equal to the port of the server, to which the request arrived.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$server_protocol</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This variable is equal to the protocol of request, usually this HTTP/1.0 or HTTP/1.1.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">$uri</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This variable is equal to current URI in the request (without arguments, those are in<code class="literal"> $args.)</code> It can differ from<code class="literal"> $request_uri</code> which is what is sent by the browser. Examples of how it can be modified are internal redirects, or with the use of index. Does not include host name. Example:<code class="literal">"/foo/bar.html"</code>.</p>
</td></tr></tbody></table></div></div></div>
<div class="section" title="Enabling a log file cache"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec07"/>Enabling a log file cache</h1></div></div></div><p>Logging is primarily a disk based activity, and on a busy server, that requires logging as an audit requirement. It is crucial to ensure that you enable file descriptor caching in Nginx. This is a performance enhancement recipe that will also increase the life of your server hard drive.<a class="indexterm" id="id91"/>
</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec11"/>How to do it...</h2></div></div></div><p>You can put this configuration in the<code class="literal"> http</code> part of the configuration:</p><div class="informalexample"><pre class="programlisting">http {
...
open_log_file_cache max=1000 inactive=20s min_uses=2 valid=1m;
..
</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec12"/>How it works...</h2></div></div></div><p>This simple configuration sets up the following flags which are described in the following table:<a class="indexterm" id="id92"/>
</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left" width="0.735"/><col style="text-align: left" width="4.7"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Flag</p>
</th><th style="text-align: left" valign="bottom">
<p>Utility</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Max</p>
</td><td style="text-align: left" valign="top">
<p>Maximal number of descriptors in the cache, with overflow Least Recently Used removed (LRU)</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Inactive</p>
</td><td style="text-align: left" valign="top">
<p>Sets the time after which descriptor without hits during this time are removed; default is 10 seconds</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>min_uses</p>
</td><td style="text-align: left" valign="top">
<p>Sets the minimum number of file usage within the time specified in parameter inactive, after which the file descriptor will be put in the cache; default is 1</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Valid</p>
</td><td style="text-align: left" valign="top">
<p>Sets the time until it will be checked if file still exists under same name; default is 60 seconds</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Off</p>
</td><td style="text-align: left" valign="top">
<p>Disables the cache</p>
</td></tr></tbody></table></div><p>These settings can be optimized over some span of testing, thus giving you the best of what Nginx has to offer with logging and reducing your performance overheads for the same.</p></div></div>
<div class="section" title="Utilizing separate error logs per virtual host"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec09"/>Utilizing separate error logs per virtual host</h1></div></div></div><p>We looked earlier at how simple it is in Nginx to set up virtual hosts and manage them clearly in their separate files. In this recipe, we are going to have a look at how we create different access and error logs for each virtual host.<a class="indexterm" id="id93"/>
</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec13"/>How to do it...</h2></div></div></div><p>This is a configuration that takes three virtual hosts (www.example1.com ,<a class="ulink" href="http://www.example2.com"> www.example2.com</a>, and<a class="ulink" href="http://www.example3.com)"> www.example3.com)</a> which have different access and error logs:</p><div class="informalexample"><pre class="programlisting">http {
...
server {
listen 80;
server_name www.example1.com ;
access_log /var/log/nginx/example1.access.log;
error_log /var/log/nginx/example1.error.log;
...
}
server {
listen 80;
server_name www.example2.com ;
access_log /var/log/nginx/example2.access.log;
error_log /var/log/nginx/example2.error.log;
...
}
server {
listen 80;
server_name www.example3.com ;
access_log /var/log/nginx/example3.access.log;
error_log /var/log/nginx/example3.error.log;
...
}
}
</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec14"/>How it works...</h2></div></div></div><p>As you can see, we can place<code class="literal"> access_log</code> and<code class="literal"> error_log</code> directives individually in each of the virtual host configurations. This allows us to create different files for each of those sites.<a class="indexterm" id="id94"/>
</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec15"/>There's more...</h2></div></div></div><p>You can potentially combine the earlier recipe of different log formats and this recipe to create different kinds of access and error logs for each of your sites. This clearly exhibits the immense power that the Nginx logging module brings to the table for the system administrators.</p><div class="informalexample"><pre class="programlisting">http {
...
server {
listen 80;
server_name www.example1.com ;
access_log /var/log/nginx/example1.access.log main;
error_log /var/log/nginx/example1.error.log error_main;
...
}
</pre></div><p>The preceding example shows how we are logging the access and error logs with different formats, which are<code class="literal"> main</code> and<code class="literal"> error_main</code> respectively. This may be necessary in cases where one logs fewer variables for the access logs purposes and more esoteric variables to track errors in the error logs.</p></div></div>
<div class="section" title="Setting up log rotation"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec10"/>Setting up log rotation</h1></div></div></div><p>In production sites that have been running for a decent amount of time, log archiving becomes a necessity. For proper log archiving, you will need to have a proper log rotation system in place. Every website request generates more than one log entry (as there are logging for the static files as well), so logs tend to bloat up quickly. This recipe helps you tackle the log rotation setup with Nginx, making sure you are archiving your logs correctly.</p><p>This depends on the logrotate script that is available, for example, on both Fedora and Debian distributions.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec16"/>How to do it...</h2></div></div></div><p>You will need to add a configuration to the logrotate conf file:<a class="indexterm" id="id95"/>
</p><div class="informalexample"><pre class="programlisting">/var/log/nginx/*.log {
daily
missingok
rotate 52
compress
delaycompress
notifempty
create 640 root adm
sharedscripts
postrotate
[ ! -f /var/run/nginx.pid ] || kill -USR1 `cat
/var/run/nginx.pid`
endscript
}
</pre></div><p>This assumes that the Nginx configurations are placed in the<code class="literal"> /var/log/nginx</code> directory and the Nginx PID file exists at<code class="literal"> /var/run/nginx.pid</code>.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec17"/>How it works...</h2></div></div></div><p>This is a simple configuration for logrotate which effectively carries out the following steps:<a class="indexterm" id="id96"/>
</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem"> Moves the existing log file with a new filename and compresses it.</li><li class="listitem"> Makes a USR1 signal call to the Nginx master process, which releases the log which has just been moved and starts writing into a normal log file.</li></ol></div><p>The logrotate script allows very interesting configurations which allow you great control over when the log needs to be rotated, what compressions you need, and with what permissions the files to be archived.</p></div></div>
<div class="section" title="Enabling remote logging with syslog-ng"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec11"/>Enabling remote logging with syslog-ng</h1></div></div></div><p>Imagine running a cluster of servers spread out over various geographies. In such a scenario, one will probably need to do remote logging on a set of redundant central logging servers. It makes life easier for log parsing and system administration tasks as well.</p><p>In this recipe, we will have a look at syslog-ng and Nginx to get them working together in a networked environment. This will involve some interesting things, like patching the Nginx codebase.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec18"/>How to do it...</h2></div></div></div><p>If you want to get the Nginx installation to interact with syslog-ng, you will need to carry out the following steps carefully. This recipe assumes that you have already installed syslog-ng on your system:<a class="indexterm" id="id97"/>
</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem"> You will need to download Nginx from the following URL: (<a class="ulink" href="http://nginx.org/download/nginx-0.7.67.tar.gz">http://nginx.org/download/nginx-0.7.67.tar.gz</a>)<div class="informalexample"><pre class="programlisting">wget http://nginx.org/download/nginx-0.7.67.tar.gz
</pre></div></li><li class="listitem"> Then untar the downloaded file:<div class="informalexample"><pre class="programlisting">tar xvzf nginx-0.7.67.tar.gz
</pre></div></li><li class="listitem"> Download the patch: (<a class="ulink" href="http://bugs.gentoo.org/attachment.cgi?id=197180">http://bugs.gentoo.org/attachment.cgi?id=197180</a>)<div class="informalexample"><pre class="programlisting">wget "http://bugs.gentoo.org/attachment.cgi?id=197180" -O syslog.patch
</pre></div></li><li class="listitem"> Apply the patch:<div class="informalexample"><pre class="programlisting">patch -p0 &lt; syslog.patch
</pre></div></li><li class="listitem"> Configure Nginx:<div class="informalexample"><pre class="programlisting">./configure --with-syslog
</pre></div></li><li class="listitem"> Build and install Nginx:<div class="informalexample"><pre class="programlisting">make &amp;&amp; make install
</pre></div></li><li class="listitem"> You will now need to configure the syslog client, adding the following configuration to<code class="literal"> /etc/syslog-ng/syslog-ng.conf</code> and restarting the syslog-ng service:<div class="informalexample"><pre class="programlisting">filter f_local5 { facility(local5); };
destination d_loghost {tcp("nginx_log" port(514));};
log { source(s_all); filter(f_local5); destination(d_loghost); };
</pre></div></li><li class="listitem"> You will now need to configure the remote logging server<code class="literal"> nginx_log</code> , adding the following configuration to<code class="literal"> /etc/syslog-ng/syslog-ng.conf</code> and restarting the syslog-ng service:<div class="informalexample"><pre class="programlisting">source s_remote { tcp(); };
destination d_clients { file("/var/log/HOSTS/nginx.$HOST"); };
log { source(s_remote); destination(d_clients); };
</pre></div></li><li class="listitem"> You can test this configuration out by running the following:</li></ol></div><div class="informalexample"><pre class="programlisting">logger -p local5.info HelloWorld
</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec19"/>How it works...</h2></div></div></div><p>Nginx, by default, does not support syslog-ng and needs some patching to work correctly. So in the first set of steps we actually install Nginx with the patch and then proceed to configure syslog-ng.<a class="indexterm" id="id98"/>
</p><p>There are two parts to the syslog-ng configuration. In the first we actually configure the client on which Nginx is running and make the local5 facility (where Nginx logs in our case) point to the syslog-ng server running on the<code class="literal"> nginx_log</code> server. The second part involved configuring the syslog-ng server to accept log request from the remote client and putting them at certain locations on the hard drive.</p><p>There is a small utility called "logger", which allows you to test out the logging on your machine without invoking Nginx. It's pretty nifty and lets you easily debug your syslog-ng setup.</p></div></div>
<div class="section" title="Setting up your custom logs for easy parsing"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec12"/>Setting up your custom logs for easy parsing</h1></div></div></div><p>The point of logging is not only to find out errors in a setup, but also for various analytics that one can perform on the usage of the sites running on the server. There are various tools that are available that one can use to analyze your web logs. Some of the open source and freely available ones are AWstats, webalizer, and so on. We will have a look at how to set up for AWstats.<a class="indexterm" id="id99"/>
</p><p>The following screenshot is a sample of the AWstats generated HTML report:</p><div class="mediaobject"><img alt="Setting up your custom logs for easy parsing" src="graphics/4965_03_01.jpg" width="394"/></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec20"/>How to do it...</h2></div></div></div><p>We will first have a look at how to install AWstats, and then configure it to create a continuous report around Nginx logs.<a class="indexterm" id="id100"/>
</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem"> Add the following to the Nginx configuration file:<div class="informalexample"><pre class="programlisting">log_format new_log
$remote_addr - $remote_user [$time_local] $request '
'"$status" $body_bytes_sent "$http_referer" '
'"$http_user_agent" "$http_x_forwarded_for"';
access_log logs/access.log new_log;
</pre></div></li><li class="listitem"> Now we need to install the AWstats package, so download the latest version and then run the configuration wizard<code class="literal"> awstats_configure.pl</code> to create a new statistics profile:<a class="indexterm" id="id101"/><div class="informalexample"><pre class="programlisting">-----&gt; Check for web server install
Enter full config file path of your Web server.
Example: /etc/httpd/httpd.conf
Example: /usr/local/apache2/conf/httpd.conf
Example: c:Program filesapache groupapacheconfhttpd.conf
Config file path ('none' to skip web server setup):
#&gt; none
Enter
Your web server config file(s) could not be found.
You will need to setup your web server manually to declare AWStats
script as a CGI, if you want to build reports dynamically.
See AWStats setup documentation (file docs/index.html)
-----&gt; Update model config file '/usr/local/awstats/wwwroot/cgi-bin/awstats.model.conf'
File awstats.model.conf updated.
-----&gt; Need to create a new config file ?
Do you want me to build a new AWStats config/profile
file (required if first install) [y/N] ?
#&gt; y
Enter
-----&gt; Define config file name to create
What is the name of your web site or profile analysis ?
Example: www.mysite.com
Example: demo
Your web site, virtual server or profile name:
#&gt; www.example1.com
www.example1.com
Enter
-----&gt; Define config file path
In which directory do you plan to store your config file(s) ?
Default: /etc/awstats
Directory path to store config file(s) (Enter for default):
#&gt;
----&gt; Add update process inside a scheduler
Sorry, configure.pl does not support automatic add to cron yet.
You can do it manually by adding the following command to your cron:
/usr/local/awstats/wwwroot/cgi-bin/awstats.pl -update -config=www.moabc.net
Or if you have several config files and prefer having only one command:
/usr/local/awstats/tools/awstats_updateall.pl now
A SIMPLE config file has been created: /etc/awstats/awstats.www.example1.com.conf
You should have a look inside to check and change manually main parameters.
You can then manually update your statistics for 'www.example1.com' with command:
&gt; perl awstats.pl -update -config=www.example1.com
You can also build static report pages for 'www.example1.com' with command:
&gt; perl awstats.pl -output=pagetype -config=www.example1.com
Press ENTER to finish...
</pre></div></li><li class="listitem"> You can now open the file generated<code class="literal"> /etc/awstats/awstats.www.example1.com.conf</code> and update the LogFile variable to the path of the Nginx log file (assuming that they are being log rotated).<a class="indexterm" id="id102"/><div class="informalexample"><pre class="programlisting">LogFile="/usr/local/nginx/logs/access_%YYYY-0%MM-0%DD-0.log"
</pre></div></li><li class="listitem"> Now you can test out the new log analysis by using the following command. This will also depend on where you installed the AWstats package:<div class="informalexample"><pre class="programlisting">/usr/local/awstats/wwwroot/cgi-bin/awstats.pl -update -config=www.example1.com
</pre></div></li><li class="listitem"> Now you need to generate the reports in HTML, so you will need to create a directory and then run the HTML generation script:<div class="informalexample"><pre class="programlisting"># mkdir /data/webroot/awstats
# /usr/local/awstats/tools/awstats_buildstaticpages.pl -update
-config=www.example1.com -lang=en -dir=/data/admin_web/awstats
-awstatsprog=/usr/local/awstats/wwwroot/cgi-bin/awstats.pl
</pre></div></li><li class="listitem"> You can now add some configuration to Nginx to expose this HTML analysis on your own domain:<div class="informalexample"><pre class="programlisting">location ~ ^/awstats/ {
root /data/webroot/awstats;
index index.html;
access_log off;
error_log off;
charset utf-8;
}
</pre></div></li><li class="listitem"> Now you can visit<a class="ulink" href="http://example1.com/awstats/awstats.www.example1.com.html"> http://example1.com/awstats/awstats.www.example1.com.html</a> to see the resultant HTML.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec21"/>How it works...</h2></div></div></div><p>This is a fairly simple setup, where we are initially setting up the logging format on Nginx so that we are able to fully exploit all that AWstats can generate for us. Then we go on to install AWstats, which is a set of Perl scripts. We generate a configuration for our domain<code class="literal"> www.example1.com</code> and then start analyzing the log. In addition to the basic analysis, we can also generate really easy-to-use HTML reports.<a class="indexterm" id="id103"/>
</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec22"/>There's more...</h2></div></div></div><p>A tool like AWstats allows you to track things like:<a class="indexterm" id="id104"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Visits (the number of unique visitors)</li><li class="listitem" style="list-style-type: disc">Access time and the last visit</li><li class="listitem" style="list-style-type: disc">User authentication (last time logged in using site credentials)</li><li class="listitem" style="list-style-type: disc">Weekly peak time (the number of pages, click-through rate per hour, and week kilobytes)</li><li class="listitem" style="list-style-type: disc">Name/country hosts visitors (pages, click-through rate, byte, 269 domains/ countries detected, GeoIP detection)</li><li class="listitem" style="list-style-type: disc">Host list of recently visited and did not resolve the IP address list</li><li class="listitem" style="list-style-type: disc">Most read entry and exit pages</li><li class="listitem" style="list-style-type: disc">File types</li><li class="listitem" style="list-style-type: disc">Site compression tables (mod_gzip or mod_deflate)</li><li class="listitem" style="list-style-type: disc">Operating system (one for each operating system, the number of pages, click-through rate, byte, 35 OS detected)</li><li class="listitem" style="list-style-type: disc">Type of browsers used</li><li class="listitem" style="list-style-type: disc">Robot visits (319 robots detected)</li><li class="listitem" style="list-style-type: disc">Worm attacks (5 worm family)</li><li class="listitem" style="list-style-type: disc">Search engines statistics about what keywords lead users to your site</li><li class="listitem" style="list-style-type: disc">HTTP protocol error (the most recent inspection did not find the page)</li><li class="listitem" style="list-style-type: disc">Other reports based on the personalized URL and link parameters, involving the field of integrated marketing purpose</li><li class="listitem" style="list-style-type: disc">Your site by adding "favorite bookmarks" views</li><li class="listitem" style="list-style-type: disc">Screen size (in the index page of the need to add some HTML tags)</li><li class="listitem" style="list-style-type: disc">The proportion of browser support: Java, Flash, RealG2 reader, Quicktime reader, WMA reader, PDF reader</li><li class="listitem" style="list-style-type: disc">The ratio of load-balancing server cluster report<a class="indexterm" id="id105"/></li></ul></div><p>The preceding setup was not completely automated after you run the script for the first time. We can take a step ahead and put all this in a cron script that will help us run it as a cron job.</p><p>You will need to add the following in your cron (crontab<code class="literal"> e):</code>
<a class="indexterm" id="id106"/>
</p><div class="informalexample"><pre class="programlisting">00 1 * * * /usr/local/awstats/tools/awstats_buildstaticpages.pl
-update -config=www.example1.com -lang=cn -dir=/data/admin_web/awstats
-awstatsprog=/usr/local/awstats/wwwroot/cgi-bin/awstats.pl
</pre></div><p>This above cron job basically fires up a script every day at 1:00AM. The job of the script is to parse and generate the reports for the sites that it is configured for.</p></div></div></body></html>