<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;NGINX for the Developer"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. NGINX for the Developer</h1></div></div></div><p>Throughout the book so far, we have seen how to configure NGINX for a number of different scenarios. What we have not yet done is look at the possibilities that NGINX offers the application developer. There are a number of ways that NGINX can be integrated directly into your application. We will explore those possibilities in the following sections:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Caching integration</li><li class="listitem" style="list-style-type: disc">Changing content on-the-fly</li><li class="listitem" style="list-style-type: disc">Using Server Side Includes</li><li class="listitem" style="list-style-type: disc">Decision-making in NGINX</li><li class="listitem" style="list-style-type: disc">Creating a secure link</li><li class="listitem" style="list-style-type: disc">Generating images</li><li class="listitem" style="list-style-type: disc">Tracking website visitors</li><li class="listitem" style="list-style-type: disc">Preventing inadvertent code execution</li></ul></div><div class="section" title="Caching integration"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec49"/>Caching integration</h1></div></div></div><p>NGINX is superb at serving static<a id="id958" class="indexterm"/> content. It is designed to support over 100,000 simultaneous connections while using only minimal system resources. Integrating a dynamic web application into such a well-architected server may mean a performance hit for the server. We may not be able to support as many simultaneous connections, but that does not mean that we cannot still give our users a snappy web experience.</p><p>Caching <a id="id959" class="indexterm"/>was introduced in <a class="link" href="ch05.html" title="Chapter 5. Reverse Proxy Advanced Topics">Chapter 5</a>, <span class="emphasis"><em>Reverse Proxy Advanced Topics</em></span>. In this section, we will take an in-depth view of integrating NGINX's caching mechanisms into a web application. Your web application may already cache to a certain extent. Perhaps it writes pre-rendered pages into a database so that an expensive rendering task does not have to be repeated at each page view. Or, even better, your application may write prerendered pages into the filesystem, so that they can simply be served by NGINX's stellar static file performance. No matter the caching mechanism your application already has (even if it has none), NGINX offers a way to integrate it into the server.</p><div class="section" title="No application caching"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec52"/>No application caching</h2></div></div></div><p>When your application does no caching at all, NGINX can still help speed up your users' response times. Both the <code class="literal">proxy</code> and the <code class="literal">fastcgi</code> modules are able to make use of this caching feature. You will therefore either be using the <code class="literal">proxy_cache_*</code> or the <code class="literal">fastcgi_cache_*</code> directives to configure caching for your application. The <code class="literal">proxy_cache_*</code> directives were described in the <span class="emphasis"><em>Caching</em></span> section in <a class="link" href="ch05.html" title="Chapter 5. Reverse Proxy Advanced Topics">Chapter 5</a>, <span class="emphasis"><em>Reverse Proxy Advanced Topics</em></span>; the <code class="literal">fastcgi_cache_*</code> directives summarized in <a class="link" href="ch06.html" title="Chapter 6. The NGINX HTTP Server">Chapter 6</a>, <span class="emphasis"><em>The NGINX HTTP Server</em></span>.</p><p>Here we will describe <a id="id960" class="indexterm"/>how to extend your application to instruct NGINX how to cache individual pages. This is done by using headers sent to NGINX. You can use either the standard <code class="literal">Expires</code> and <code class="literal">Cache-Control</code> headers or the special<a id="id961" class="indexterm"/> <code class="literal">X-Accel-Expires</code> header, which NGINX interprets for caching and does not pass on to the client. This header allows the application to completely control how long NGINX caches a file. This makes it very easy to expire normally long-lived objects.</p><p>Let's say that you have a news application that's suffering from slow page load times. This can happen for different reasons, but after analysis, you have determined that each page is rendered in real time from the content stored in a database. When a user visits the site, this causes a new database connection to be opened, multiple SQL queries to be made, and the result to be parsed, before a fully-rendered page can be delivered to that user. Due to multiple connections in the application's backend system, the architecture cannot easily be restructured to make use of a more reasonable rendering strategy.</p><p>Given these restrictions, you decide on the following caching strategy:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The front page is to be cached for 1 minute, as this contains links to articles and the list is frequently updated</li><li class="listitem" style="list-style-type: disc">Each article will be cached for 1 day because once written they don't change, but we don't want the cache to be filled with older entries that need to be removed due to lack of space</li><li class="listitem" style="list-style-type: disc">Any image will be cached for as long as possible, due to the images also being stored in the database, making it a truly expensive operation to retrieve them</li></ul></div><p>We will configure NGINX to support this strategy as follows:</p><div class="informalexample"><pre class="programlisting">http {

    # here we configure two separate shared memory zones for the keys/metadata
    #   and filesystem paths for the cached objects themselves
    proxy_cache_path /var/spool/nginx/articles keys_zone=ARTICLES:16m levels=1:2 inactive=1d;

    proxy_cache_path /var/spool/nginx/images keys_zone=IMAGES:128m levels=1:2 inactive=30d;

    # but both paths still lie on the same filesystem as proxy_temp_path
    proxy_temp_path /var/spool/nginx;

    server {

        location / {

            # this is where the list of articles is found
            proxy_cache_valid 1m;

        }

        location /articles {

            # each article has a URI beginning with "/articles"
            proxy_cache_valid 1d;

        }

        location /img {

            # every image is referenced with a URI under "/img"
            proxy_cache_valid 10y;

        }

}</pre></div><p>That takes care of our requirements. We have now activated caching for a legacy application that has no caching support.</p></div><div class="section" title="Caching in the database"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec53"/>Caching in the database</h2></div></div></div><p>If your application <a id="id962" class="indexterm"/>currently caches prerendered pages in a database, it should be possible without too much additional effort to place those pages into a memcached instance instead. NGINX is capable of answering requests directly from what is stored in memcached. The logic is shown in the following figure:</p><div class="mediaobject"><img src="graphics/7447OS_07_01.jpg" alt="Caching in the database"/></div><p>The interface <a id="id963" class="indexterm"/>is very simple, allowing it to be as flexible as possible. NGINX looks up a key in the store. If it is found, the value is returned to the client. Constructing the proper key is a configuration task, which we will discuss next. Storing the value at that key is outside the scope of what NGINX was designed to do. That job belongs to the application.</p><p>Determining which key to use is a fairly simple task. For resources that are not personalized, the best key to use is the URI itself. This is set <a id="id964" class="indexterm"/>in the <code class="literal">$memcached_key</code> variable:</p><div class="informalexample"><pre class="programlisting">location / {

    set $memcached_key $uri;

    memcached_pass 127.0.0.1:11211;

}</pre></div><p>If your application reads request arguments to construct a page, then the <code class="literal">$memcached_key</code> should include these as well:</p><div class="informalexample"><pre class="programlisting">location / {

    set $memcached_key "$uri?$args";

    memcached_pass 127.0.0.1:11211;

}</pre></div><p>If the key is not present, NGINX will need a means of requesting the page from the application. Hopefully, the application will then write the key/value pair into memcached so that the next request can be directly served from memory. NGINX will report a "Not Found" error if the key couldn't be found in memcached, so the best way to then pass the request to the application is to use the <code class="literal">error_page</code> directive<a id="id965" class="indexterm"/> and a <code class="literal">location</code> to handle the request. We <a id="id966" class="indexterm"/>should also include the error codes for a "Bad Gateway" error and a "Gateway Timeout" error, in case memcached does not respond to our key lookup:</p><div class="informalexample"><pre class="programlisting">server {

    location / {

        set $memcached_key "$uri?$args";

        memcached_pass 127.0.0.1:11211;

        error_page 404 502 504 = @app;

    }

    location @app {

        proxy_pass 127.0.0.1:8080;

    }

}</pre></div><p>Remember that by using the equals sign (<code class="literal">=</code>) in the arguments to <code class="literal">error_page</code>, NGINX will substitute in the return code from the last argument. This enables us to turn an error condition into a normal response.</p><p>The following table describes the directives available with the <code class="literal">memcached</code> module, which is compiled into an <code class="literal">nginx</code> binary by default:</p><div class="section" title="Table: Memcached module directives"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl6sec33"/>Table: Memcached module directives</h3></div></div></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Directive</p>
</th><th style="text-align: left" valign="bottom">
<p>Explanation</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">memcached_buffer_size</code>
<a id="id967" class="indexterm"/>
<a id="id968" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>The size of the buffer for the response from memcached. This<a id="id969" class="indexterm"/> response is then sent synchronously to the client.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">memcached_connect_timeout</code>
<a id="id970" class="indexterm"/>
<a id="id971" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>The maximum length of time NGINX will wait for its connection to be accepted when making a request to a memcached server.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">memcached_next_upstream</code>
<a id="id972" class="indexterm"/>
<a id="id973" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>The conditions under which a request will be passed to the next memcached server, as specified by one or more of the following parameters:</p>
<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">error</code>: An error occurred when communicating with the memcached server</li><li class="listitem" style="list-style-type: disc"><code class="literal">timeout</code>: A timeout was reached when communicating with the memcached server</li><li class="listitem" style="list-style-type: disc"><code class="literal">invalid_response</code>: The memcached server returned an empty or otherwise invalid response</li><li class="listitem" style="list-style-type: disc"><code class="literal">not_found</code>: The key was not found on this memcached instance</li><li class="listitem" style="list-style-type: disc"><code class="literal">off</code>: Disables passing a request to the next memcached server</li></ul></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">memcached_pass</code>
<a id="id974" class="indexterm"/>
<a id="id975" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies the name or address of a memcached server and its port. May also be a <code class="literal">server</code> group, as declared in an <code class="literal">upstream</code> context.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">memcached_read_timeout</code>
<a id="id976" class="indexterm"/>
<a id="id977" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies the length of time that needs to elapse between two successive read operations from a memcached server before the connection is closed.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">memcached_send_timeout</code>
<a id="id978" class="indexterm"/>
<a id="id979" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>The length of time that needs to elapse between two successive write operations to a memcached server before the connection is closed.</p>
</td></tr></tbody></table></div></div></div><div class="section" title="Caching in the filesystem"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec54"/>Caching in the filesystem</h2></div></div></div><p>Suppose your application<a id="id980" class="indexterm"/> writes prerendered pages as files. You know how long each file should be valid. You can configure NGINX to deliver certain headers with each file that instruct the client, and any proxy in between, how long the file should be cached. In this way, you have enabled a local cache for your users without having to change a single line of code.</p><p>You can do this by setting the <code class="literal">Expires</code> and <code class="literal">Cache-Control</code> headers. These are standard HTTP headers understood by clients and HTTP proxies alike. No change is required in your application; you merely need to set these headers in the NGINX configuration block for the corresponding locations. NGINX makes it convenient by providing the <code class="literal">expires</code> and <code class="literal">add_header</code> directives.</p><div class="section" title="Table: Header modifying directives"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl6sec34"/>Table: Header modifying directives</h3></div></div></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Directive</p>
</th><th style="text-align: left" valign="bottom">
<p>Explanation</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">add_header</code>
<a id="id981" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Adds fields to a header present in the responses with HTTP codes 200, 204, 206, 301, 302, 303, 304, or 307.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">expires</code>
<a id="id982" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Adds or modifies the <code class="literal">Expires</code> and <code class="literal">Cache-Control</code> headers. The parameters can be an optional <code class="literal">modified</code> parameter, followed by <code class="literal">time</code>, or one of <code class="literal">epoch</code>, <code class="literal">max</code>, or <code class="literal">off</code>. If <code class="literal">time</code> alone is present, the <code class="literal">Expires</code> header will be set to the current time plus the time specified in the <code class="literal">time</code> parameter. <code class="literal">Cache-Control</code> will be set to <code class="literal">max-age=t</code>, where <code class="literal">t</code> is the time specified as an argument, in seconds. If the <code class="literal">modified</code> parameter precedes a <code class="literal">time</code> value, the <code class="literal">Expires</code> header is set to the file's modification time plus the time specified in the <code class="literal">time</code> parameter. If the <code class="literal">time</code> contains an <code class="literal">@</code>, the time specified will be interpreted as the time of day; for example, <code class="literal">@12h</code> is 12 noon. <code class="literal">epoch</code> is defined to be the exact date and time <code class="literal">Thu, 01 Jan 1970 00:00:01 GMT</code>. <code class="literal">max</code> sets <code class="literal">Expires</code> to <code class="literal">Thu, 31 Dec 2037 23:55:55 GMT</code> and <code class="literal">Cache-Control</code> to 10 years. Any negative time will set <code class="literal">Cache-Control</code> to <code class="literal">no-cache</code>.</p>
</td></tr></tbody></table></div><p>Knowing what you do about the files your application generates, you can set these headers appropriately. Let's take an example application where the main page should be cached for 5 minutes, all JavaScript and CSS files for 24 hours, each HTML page for 3 days, and each image for as long as possible:</p><div class="informalexample"><pre class="programlisting">server {

    root /home/www;

    location / {

        # match the index.html page explicitly so the *.html below
        #  won't match the main page
        location = /index.html	 {

            expires 5m;

        }

        # match any file ending in .js or .css (Javascript or CSS files)
        location ~* /.*\.(js|css)$ {

            expires 24h;

        }

        # match any page ending in .html
        location ~* /.*\.html$ {

            expires 3d;

        }

    }

    # all of our images are under a separate location (/img)
    location /img {

        expires max;

    }

}</pre></div><p>To see how this <a id="id983" class="indexterm"/>configuration sets the headers, let's take a look at what each location looks like in the browser. Each modern browser has a tool either built-in or available as a plug-in that enables you to view the headers of both the request and the response. The following series of screenshots show how Chrome displays the response headers for these locations:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>The main page</strong></span> (<code class="literal">index.html</code>): The <code class="literal">Expires</code> header is set to 5 minutes later than the <code class="literal">Date</code> header. The <code class="literal">Cache-Control</code> header has a <code class="literal">max-age</code> parameter set to 300 seconds.<div class="mediaobject"><img src="graphics/7447OS_07_02.jpg" alt="Table: Header modifying directives"/></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>A CSS file</strong></span>: The <code class="literal">Expires</code> <a id="id984" class="indexterm"/>header is set to 24 hours later than the <code class="literal">Date</code> header. The <code class="literal">Cache-Control</code> header has a <code class="literal">max-age</code> parameter of 86400 seconds.<div class="mediaobject"><img src="graphics/7447OS_07_03.jpg" alt="Table: Header modifying directives"/></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>An HTML file</strong></span>: The <code class="literal">Expires</code> header is set to 3 days later than the <code class="literal">Date</code> header. The <code class="literal">Cache-Control</code> header has a <code class="literal">max-age</code> parameter set to 259200 seconds.<div class="mediaobject"><img src="graphics/7447OS_07_04.jpg" alt="Table: Header modifying directives"/></div></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>An image</strong></span>: The<a id="id985" class="indexterm"/> <code class="literal">Expires</code> header is set to <code class="literal">Thu, 31 Dec 2037 23:55:55 GMT</code>. The <code class="literal">Cache-Control</code> header has a <code class="literal">max-age</code> parameter set to 315360000 seconds.<div class="mediaobject"><img src="graphics/7447OS_07_05.jpg" alt="Table: Header modifying directives"/></div></li></ul></div><p>Just by setting the one directive, <code class="literal">expires</code>, in the appropriate location, we can ensure that our prerendered files are cached locally for as long as they should be.</p></div></div></div></div>
<div class="section" title="Changing content on-the-fly"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec50"/>Changing content on-the-fly</h1></div></div></div><p>Sometimes it may be helpful post-process what comes from your application. Maybe you would like to add a string at a certain point in your page to show which frontend server delivered that page to the client. Or maybe you would like to perform a transformation on the rendered HTML page. NGINX provides three modules that could be useful here: the <code class="literal">addition</code> module, the <code class="literal">sub</code> module, and the <code class="literal">xslt</code> module.</p><div class="section" title="The addition module"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec55"/>The addition module</h2></div></div></div><p>The <code class="literal">addition</code> module <a id="id986" class="indexterm"/>works as a filter to add text before and/or after a response. It is not compiled by default, so if you want to make use of this feature, you must enable it at configure time by adding <code class="literal">--with-http_addition_module</code>.</p><p>This filter works by referencing a subrequest, which is then either appended to a request, or placed at the beginning of one:</p><div class="informalexample"><pre class="programlisting">server {

    root /home/www;

    location / {

        add_before_body /header;

        add_after_body /footer;

    }

    location /header {

        proxy_pass http://127.0.0.1:8080/header;

    }

    location /footer {

        proxy_pass http://127.0.0.1:8080/footer;

    }

}</pre></div><p>The <code class="literal">addition</code> module directives are summarized in the following table:</p><div class="section" title="Table: HTTP addition module directives"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl6sec35"/>Table: HTTP addition module directives</h3></div></div></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Directive</p>
</th><th style="text-align: left" valign="bottom">
<p>Explanation</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">add_before_body</code>
<a id="id987" class="indexterm"/>
<a id="id988" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Adds the result of<a id="id989" class="indexterm"/> processing a subrequest before the response body.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">add_after_body</code>
<a id="id990" class="indexterm"/>
<a id="id991" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Adds the result of processing a subrequest after the response body.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">addition_types</code>
<a id="id992" class="indexterm"/>
<a id="id993" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Lists the MIME types of a response in addition to <code class="literal">text/html</code>, in <a id="id994" class="indexterm"/>which an addition will be made. It may be <code class="literal">*</code> to enable all MIME types.</p>
</td></tr></tbody></table></div></div></div><div class="section" title="The sub module"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec56"/>The sub module</h2></div></div></div><p>The <code class="literal">sub</code> module<a id="id995" class="indexterm"/> works as a filter to replace (substitute) one text for another. It is not compiled by default, so if you want to make use of this feature, you must enable it at configure time by adding <code class="literal">--with-http_sub_module</code>.</p><p>It is fairly easy to work with. You use the <code class="literal">sub_filter</code> directive to specify a string to be replaced and its replacement, and the filter makes a case-insensitive match for your string, and substitutes in the replacement:</p><div class="informalexample"><pre class="programlisting">location / {

    sub_filter &lt;/head&gt; '&lt;meta name="frontend" content="web3"&gt;&lt;/head&gt;';

}</pre></div><p>In the preceding example, we added a new meta tag to the header of the page as it passed through NGINX.</p><p>It's also possible to make the match more than once. To do this, you set the <code class="literal">sub_filter_once</code> directive<a id="id996" class="indexterm"/> to <code class="literal">off</code>. This can be useful to replace all relative links in a page with absolute ones, for example:</p><div class="informalexample"><pre class="programlisting">location / {

    sub_filter_once off;

    sub_filter '&lt;img src="img/' '&lt;img src="/img/';

}</pre></div><p>If there are any spaces or embedded quotes in the string to be matched, they must be enclosed in quotes in order for NGINX to recognize them as the first parameter.</p><p>NGINX will automatically use the <code class="literal">sub_filter</code> directive on any HTML file. If you want to use substitution on other types of files, such as JavaScript or CSS, just add the corresponding MIME type to the <code class="literal">sub_filter_types</code> directive.</p><div class="informalexample"><pre class="programlisting">location / {

    sub_filter_types text/css;

    sub_filter url(img/ 'url(/img/';

}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note12"/>Note</h3><p>Since <code class="literal">text/html</code> is the default value, this type doesn't need to be added—it won't be overwritten by adding additional MIME types to be transformed. This principle applies to all MIME type specification directives in NGINX.</p></div></div><p>The following table summarizes these directives:</p><div class="section" title="Table: HTTP sub module directives"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl6sec36"/>Table: HTTP sub module directives</h3></div></div></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Directive</p>
</th><th style="text-align: left" valign="bottom">
<p>Explanation</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">sub_filter</code>
<a id="id997" class="indexterm"/>
<a id="id998" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Sets the <a id="id999" class="indexterm"/>string to be matched without regards to case and the string to be substituted into that match. The substitution string may contain variables.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">sub_filter_once</code>
<a id="id1000" class="indexterm"/>
<a id="id1001" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Setting to <code class="literal">off</code> will cause the match in <code class="literal">sub_filter</code> to be made as many times as the string is found.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">sub_filter_types</code>
<a id="id1002" class="indexterm"/>
<a id="id1003" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Lists the MIME types of a response in addition to <code class="literal">text/html</code> in which a substitution will be made. It may be <code class="literal">*</code> to enable all MIME types.</p>
</td></tr></tbody></table></div></div></div><div class="section" title="The xslt module"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec57"/>The xslt module</h2></div></div></div><p>The <code class="literal">xslt</code> module<a id="id1004" class="indexterm"/> works as a filter to transform XML using XSLT stylesheets. It is not compiled by default, so if you would like to make use of it, you will need to install the <code class="literal">libxml2</code> and <code class="literal">libxslt</code> libraries and enable compilation of the module by passing <code class="literal">--with-http_xslt_module</code> to NGINX's configure script.</p><p>To use the <code class="literal">xslt</code> module, you define a DTD in which the character entities are declared. You then specify one or more XSLT stylesheets and their corresponding parameters to process the XML document:</p><div class="informalexample"><pre class="programlisting">location / {

    xml_entities /usr/local/share/dtd/entities.dtd;

    xsl_stylesheet /usr/local/share/xslt/style1.xslt;

    xsl_stylesheet /usr/local/share/xslt/style2.xslt theme=blue;

}</pre></div><p>The directives included in the <code class="literal">xslt</code> module are summarized in the following table:</p><div class="section" title="Table: HTTP XSLT module directives"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl6sec37"/>Table: HTTP XSLT module directives</h3></div></div></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Directive</p>
</th><th style="text-align: left" valign="bottom">
<p>Explanation</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">xml_entities</code>
<a id="id1005" class="indexterm"/>
<a id="id1006" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>The path to the DTD that declares the character <a id="id1007" class="indexterm"/>entities referenced in the XML to be processed.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">xslt_param</code>
<a id="id1008" class="indexterm"/>
<a id="id1009" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Parameters passed to the stylesheets, whose values are XPath expressions.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">xslt_string_param</code>
<a id="id1010" class="indexterm"/>
<a id="id1011" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Parameters passed to the stylesheets, whose values are strings.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">xslt_stylesheet</code>
<a id="id1012" class="indexterm"/>
<a id="id1013" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>The path to an XSLT stylesheet used to transform an XML response. Parameters may be passed as a series of key/value pairs.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">xslt_types</code>
<a id="id1014" class="indexterm"/>
<a id="id1015" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Lists the MIME types of a response in addition to <code class="literal">text/xml</code> in which a substitution will be made. It may be <code class="literal">*</code> to enable all MIME types. If the transformation results in an HTML response, the MIME type will be changed to <code class="literal">text/html</code>.</p>
</td></tr></tbody></table></div></div></div></div>
<div class="section" title="Using Server Side Includes"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec51"/>Using Server Side Includes</h1></div></div></div><p>The <code class="literal">ssi</code> module<a id="id1016" class="indexterm"/> is also a filter, and one of NGINX's most flexible. It enables the use of Server Side Includes for processing logic embedded in a webpage. It supports a series of <a id="id1017" class="indexterm"/>commands that are controlled by the following directives:</p><div class="section" title="Table: Server Side Includes directives"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl6sec38"/>Table: Server Side Includes directives</h2></div></div></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Directive</p>
</th><th style="text-align: left" valign="bottom">
<p>Explanation</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">ssi</code>
<a id="id1018" class="indexterm"/>
<a id="id1019" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Enables the<a id="id1020" class="indexterm"/> processing of SSI files.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">ssi_silent_errors</code>
<a id="id1021" class="indexterm"/>
<a id="id1022" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Suppresses the error message normally output when an error occurs during SSI processing.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">ssi_types</code>
<a id="id1023" class="indexterm"/>
<a id="id1024" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Lists the <a id="id1025" class="indexterm"/>MIME types of a response in addition to <code class="literal">text/html</code> in which SSI commands are processed. It may be <code class="literal">*</code> to enable all MIME types.</p>
</td></tr></tbody></table></div><p>The Server Side Includes commands supported by NGINX are shown in the following table. They all follow the following <a id="id1026" class="indexterm"/>pattern:</p><div class="informalexample"><pre class="programlisting"> &lt;!--# command parameter1=value1 parameter2=value2 … --&gt;</pre></div></div><div class="section" title="Table: Server Side Includes commands"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl6sec39"/>Table: Server Side Includes commands</h2></div></div></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Command</p>
</th><th style="text-align: left" valign="bottom">
<p>Argument</p>
</th><th style="text-align: left" valign="bottom">
<p>Explanation</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">block</code>
<a id="id1027" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>Defines a section that can be referenced in the <code class="literal">include</code> command. Ends with <code class="literal">&lt;!--# endblock --&gt;</code>.</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>
<code class="literal">name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Name of the block.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">config</code>
<a id="id1028" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>Sets global parameters used during SSI processing.</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>
<code class="literal">errmsg</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Configures the string used as the error message if something goes wrong during SSI processing. The default is <code class="literal">[an error occurred while processing the directive]</code>.</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>
<code class="literal">timefmt</code>
</p>
</td><td style="text-align: left" valign="top">
<p>A string passed to <code class="literal">strftime()</code> to format a timestamp used in other commands. The default is <code class="literal">%A, %d-%b-%Y %H:%M:%S %Z</code>.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">echo</code>
<a id="id1029" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>Writes out the value of a variable.</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>
<code class="literal">var</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The name of the variable whose value is written out.</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>
<code class="literal">encoding</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The encoding method used for the variable. The value it can take is one of <code class="literal">none</code>, <code class="literal">url</code>, and <code class="literal">entity</code>. The default is <code class="literal">entity</code>.</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>
<code class="literal">default</code>
</p>
</td><td style="text-align: left" valign="top">
<p>A value to write out if the variable is undefined. If unset, <code class="literal">none</code> is the default.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">if</code>
<a id="id1030" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>Evaluates a condition. If true, the block enclosed will be included. The sequence <code class="literal">if</code>, <code class="literal">elsif</code>, <code class="literal">else</code>, and <code class="literal">endif</code> is supported one level deep.</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>
<code class="literal">expr</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The expression to be evaluated for truth:</p>
<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">variable existence (expr="$var")</li><li class="listitem" style="list-style-type: disc">text comparison (<code class="literal">expr="$var = text"</code> or <code class="literal">expr="$var != text"</code>)</li><li class="listitem" style="list-style-type: disc">regular expression match (<code class="literal">expr="$var = /regexp/"</code> or <code class="literal">expr="$var != /regexp/"</code>)</li></ul></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">include</code>
<a id="id1031" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>Writes the result of a subrequest.</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>
<code class="literal">file</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The name of a file to <code class="literal">include</code>.</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>
<code class="literal">virtual</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The URI of a subrequest to include.</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>
<code class="literal">stub</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The block to be included instead of an empty body, or if there was<a id="id1032" class="indexterm"/> an error in processing.</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>
<code class="literal">wait</code>
</p>
</td><td style="text-align: left" valign="top">
<p>If there are multiple <code class="literal">include</code> commands on the same page, they will be processed serially if this parameter is present.</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>
<code class="literal">set</code>
</p>
</td><td style="text-align: left" valign="top">
<p>If the subrequest made in virtual is to a <code class="literal">proxy_pass</code> or <code class="literal">memcached_pass</code> location, the result can be stored in the variable named as the argument to <code class="literal">set</code>.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">set</code>
<a id="id1033" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>Creates a variable and sets the value to it.</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>
<code class="literal">var</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The name of the variable to be set.</p>
</td></tr><tr><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>
<code class="literal">value</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The value of the variable to set.</p>
</td></tr></tbody></table></div><p>An SSI file is nothing more than an <a id="id1034" class="indexterm"/>HTML file with these commands embedded within comments. That way, if <code class="literal">ssi</code> isn't enabled for a particular location that contains such a file, the HTML portion will still render, albeit incompletely.</p><p>The following is an example of an SSI file which uses calls to a subrequest to render the header, footer, and menu of a page:</p><div class="informalexample"><pre class="programlisting">&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;*** SSI test page ***&lt;/title&gt;
    &lt;link rel="stylesheet" href="/css/layout.css" type="text/css"/&gt;
      &lt;!--# block name="boilerplate" --&gt;
      &lt;p&gt;...&lt;/p&gt;
      &lt;!--# endblock --&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id="header"&gt;
      &lt;!--# include virtual="/render/header?page=$uri" stub="boilerplate" --&gt;
    &lt;/div&gt;
    &lt;div id="menu"&gt;
      &lt;!--# include virtual="/render/menu?page=$uri" stub="boilerplate" --&gt;
    &lt;/div&gt;
    &lt;div id="content"&gt;
      &lt;p&gt;This is the content of the page.&lt;/p&gt;
    &lt;/div&gt;
    &lt;div id="footer"&gt;
      &lt;!--# include virtual="/render/footer?page=$uri" stub="boilerplate" --&gt;
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre></div><p>The <code class="literal">stub</code> is used to render some default content in case of an error in processing the subrequest.</p><p>If these primitives don't<a id="id1035" class="indexterm"/> offer enough flexibility in processing logic, you can use the embedded <code class="literal">perl</code> module<a id="id1036" class="indexterm"/> to solve just about any other processing or configuration need you may have.</p></div></div>
<div class="section" title="Decision-making in NGINX"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec52"/>Decision-making in NGINX</h1></div></div></div><p>You may find<a id="id1037" class="indexterm"/> yourself trying to bend NGINX's configuration <a id="id1038" class="indexterm"/>directives in ways that they were not meant to be used. This is frequently seen in configurations where there are a lot of <code class="literal">if</code> checks to try to emulate some sort of logic chain. A better option would be to use NGINX's embedded <code class="literal">perl</code> module. With this module, you will be able to use the flexibility of Perl to achieve your configuration goals.</p><p>The <code class="literal">perl</code> module is not built by default, so it needs to be enabled with the <code class="literal">--with-http_perl_module</code> configure switch. Ensure as well that your Perl was built with <code class="literal">-Dusemultiplicity=yes</code> (or <code class="literal">-Dusethreads=yes</code>) and <code class="literal">-Dusemymalloc=no</code>. NGINX configuration reloads will cause the <code class="literal">perl</code> module to leak memory over time, so this last parameter is included to help mitigate that problem.</p><p>After having built an <code class="literal">nginx</code> with embedded Perl, the following directives are available:</p><div class="section" title="Table: Perl module directives"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl6sec40"/>Table: Perl module directives</h2></div></div></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Directives</p>
</th><th style="text-align: left" valign="bottom">
<p>Explanation</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">perl</code>
<a id="id1039" class="indexterm"/>
<a id="id1040" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Activates a <a id="id1041" class="indexterm"/>Perl handler for this location. The argument is the name of the handler or a string describing a full subroutine.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">perl_modules</code>
<a id="id1042" class="indexterm"/>
<a id="id1043" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Specifies an additional search path for Perl modules.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">perl_require</code>
<a id="id1044" class="indexterm"/>
<a id="id1045" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Indicates a Perl module that will be loaded at each NGINX reconfiguration. May be specified multiple times for separate modules.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">perl_set</code>
<a id="id1046" class="indexterm"/>
<a id="id1047" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Installs a Perl handler to set the value of a variable. The argument is the name of the handler or a string describing a full subroutine.</p>
</td></tr></tbody></table></div><p>When writing Perl scripts to be used in an NGINX configuration, you have use of the $r object, representing the request. The methods on this object are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">$r-&gt;args</code>: The<a id="id1048" class="indexterm"/> request arguments.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$r-&gt;filename</code>: The name of the file <a id="id1049" class="indexterm"/>referenced by the URI.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$r-&gt;has_request_body(handler)</code>: If there is a request body, the handler will be called.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$r-&gt;allow_ranges</code>: Enables the use of byte ranges in a response.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$r-&gt;discard_request_body</code>: Discards the body of the request.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$r-&gt;header_in(header)</code>: The value of the specified request header.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$r-&gt;header_only</code>: Instructs NGINX to return only the header to the client.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$r-&gt;header_out(header, value)</code>: Sets the specified response header to this value.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$r-&gt;internal_redirect(uri)</code>: Makes an internal redirect to the specified URI once the Perl handler has completed execution.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$r-&gt;print(text)</code>: Prints the specified text out to the client.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$r-&gt;request_body</code>: The body of the request, if it fits in memory.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$r-&gt;request_body_file</code>: The body of the request, if written out to a temporary file.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$r-&gt;request_method</code>: The HTTP method of the request.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$r-&gt;remote_addr</code>: The client's IP address.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$r-&gt;flush</code>: Immediately send data to the client.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$r-&gt;sendfile(name[, offset[, length]])</code>: Sends the specified file to the client, with an optional offset and length, once the Perl handler has completed execution.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$r-&gt;send_http_header([type])</code>: Sends the response headers to the client, with an optional content type.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$r-&gt;status(code)</code>: Sets the HTTP status of the response.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$r-&gt;sleep(milliseconds, handler)</code>: Sets a timer to execute the handler after having waited the specified number of milliseconds. NGINX will continue processing other requests while the timer is running.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$r-&gt;unescape(text)</code>: Decodes URI-encoded text.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$r-&gt;uri</code>: The URI in the request.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$r-&gt;variable(name[, value])</code>: Either returns a named, request-local variable or sets one to the specified value.</li></ul></div><p>The <code class="literal">perl</code> module may also be used within Server Side Includes. An SSI command using Perl has the following format:</p><div class="informalexample"><pre class="programlisting">&lt;!--# perl sub="module::function" arg="parameter1" arg="parameter2" ... --&gt;</pre></div><p>Let's take a look at an <a id="id1050" class="indexterm"/>example of using the <code class="literal">perl</code> module. Our goal is to pass<a id="id1051" class="indexterm"/> requests to a different upstream server, as determined by the first letter of the request URI. We could implement this as a series of locations in NGINX, but it will be more concise expressed as a Perl handler.</p><p>The first step is to define the processing actions in a Perl handler:</p><div class="informalexample"><pre class="programlisting"># upstreammapper.pm

# name our package
package upstreammapper;

# include the nginx request methods and return code definitions
use nginx;

# this subroutine will be called from nginx
sub handler {

    my $r = shift;

    my @alpha = ("a".."z");

    my %upstreams = ();

    # simplistically create a mapping between letter and
    #  an IP which is between 10 and 35 of that network
    foreach my $idx (0..$#alpha) {

  $upstreams{ $alpha[$idx] } = $idx + 10;

    }

    # get the URI into an array
    my @uri = split(//,$r-&gt;uri);

    # so that we can use the first letter as a key
    my $ip = "10.100.0." . $upstreams{ $uri[1] };

    return $ip;

}

1;

__END__</pre></div><p>Then we set up NGINX to use this module to do the mapping:</p><div class="informalexample"><pre class="programlisting">http {

    # this path is relative to the main configuration file
    perl_modules perl/lib;

    perl_require upstreammapper.pm;

    # we'll store the result of the handler in the $upstream variable
    perl_set $upstream upstreammapper::handler;</pre></div><p>Then we pass the request along to the correct upstream server:</p><div class="informalexample"><pre class="programlisting">    location / {

        include proxy.conf;

        proxy_pass http://$upstream;

    }

}</pre></div><p>We have<a id="id1052" class="indexterm"/> seen a <a id="id1053" class="indexterm"/>very simple example of implementing some configuration logic in a Perl handler. Just about any kind of special requirement can be done in a similar way.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note13"/>Note</h3><p>Request processing in a Perl handler should be as well-defined as possible. Whenever NGINX has to wait on a Perl handler finishing, the whole worker responsible for handling that request will block. So, any I/O or DNS-related tasks should be done outside of a Perl handler.</p></div></div></div></div>
<div class="section" title="Creating a secure link"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec53"/>Creating a secure link</h1></div></div></div><p>You may have cause to protect<a id="id1054" class="indexterm"/> certain content on your site, but do not want to integrate full user authentication to allow access to that content. One way of enabling this is to use NGINX's <code class="literal">secure_link</code> module<a id="id1055" class="indexterm"/>. By passing configure the <code class="literal">--with-http_secure_link</code> switch at compile time, you get access to the<a id="id1056" class="indexterm"/> <code class="literal">secure_link_secret</code> directive, and its corresponding variable <code class="literal">$secure_link</code>.</p><p>The <code class="literal">secure_link</code> module <a id="id1057" class="indexterm"/>works by computing the MD5 hash of a link concatenated with <a id="id1058" class="indexterm"/>a secret word. If the hash matches that found in the URI, then the <code class="literal">$secure_link</code> variable is set to the portion of the URI after the hash. If there is no match, then <code class="literal">$secure_link</code> is set to the empty string.</p><p>One possible scenario is to generate a page of download links using a secret word. This word is then placed in the NGINX configuration to enable access to these links. The word and page are replaced periodically to prevent saved links from being called again at a later time. The following example illustrates this scenario.</p><p>We first decide on a secret word <code class="literal">supersecret</code>. Then, we generate the MD5 hash of the links we want to enable:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ echo -n "alphabet_soup.pdfsupersecret" |md5sum 8082202b04066a49a1ae8da9ec4feba1  - </strong></span>
<span class="strong"><strong>$ echo -n "time_again.pdfsupersecret" |md5sum 5b77faadb4f5886c2ffb81900a6b3a43  -</strong></span>
</pre></div><p>Now, we can create the HTML for our links:</p><div class="informalexample"><pre class="programlisting">&lt;a href="/downloads/8082202b04066a49a1ae8da9ec4feba1/alphabet_soup.pdf"&gt;alphabet soup&lt;/a&gt;
&lt;a href="/downloads/5b77faadb4f5886c2ffb81900a6b3a43/time_again.pdf"&gt;time again&lt;/a&gt;</pre></div><p>These will only be valid if we use the same <code class="literal">secure_link_secret</code> directive in our configuration that we used to generate these hashes:</p><div class="informalexample"><pre class="programlisting"># any access to URIs beginning with /downloads/ will be protected
location /downloads/ {

    # this is the string we used to generate the hashes above
    secure_link_secret supersecret;

    # deny access with a Forbidden if the hash doesn't match
    if ($secure_link = "") {

        return 403;

    }

    try_files /downloads/$secure_link =404;

}</pre></div><p>To ensure that links without a hash will not work, we can add an additional link to our HTML:</p><div class="informalexample"><pre class="programlisting">&lt;a href="/downloads/bare_link.pdf"&gt;bare link&lt;/a&gt;</pre></div><p>Calling this link <a id="id1059" class="indexterm"/>reports a <a id="id1060" class="indexterm"/>"403 Forbidden" error, as it should.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note14"/>Note</h3><p>The technique for generating a <code class="literal">secure_link</code> module described before is just one possible way of solving this type of problem. NGINX itself even offers an alternative way described at <a class="ulink" href="http://wiki.nginx.org/HttpSecureLinkModule">http://wiki.nginx.org/HttpSecureLinkModule</a>.</p></div></div></div>
<div class="section" title="Generating images"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec54"/>Generating images</h1></div></div></div><p>Instead of writing an image <a id="id1061" class="indexterm"/>manipulation module for your application, you can configure NGINX to handle some simple transformations. If your image-manipulation needs are as simple as rotating an image, resizing it, or cropping it, NGINX is capable of doing this for you.</p><p>To make use of this functionality, you need to have installed the <code class="literal">libgd</code> library, and enabled the <code class="literal">image_filter</code> module<a id="id1062" class="indexterm"/> at compile-time (<code class="literal">--with-http_image_filter_module</code>). If that is the case, you now have use of the directives in the following table:</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note15"/>Note</h3><p>The GD library<a id="id1063" class="indexterm"/> (<code class="literal">libgd</code>) is an image generation library written in C. It is often used in combination with a programming language such as PHP or Perl to generate images for websites. NGINX's <code class="literal">image_filter</code> module uses <code class="literal">libgd</code> to provide the capability of creating a simple image resizing proxy, which we discuss in the following example.</p></div></div><div class="section" title="Table: Image filter directives"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl6sec41"/>Table: Image filter directives</h2></div></div></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Directive</p>
</th><th style="text-align: left" valign="bottom">
<p>Explanation</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">empty_gif</code>
<a id="id1064" class="indexterm"/>
<a id="id1065" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Causes a 1x1 pixel<a id="id1066" class="indexterm"/> transparent GIF to be emitted for that <code class="literal">location</code>.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">image_filter</code>
<a id="id1067" class="indexterm"/>
<a id="id1068" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Transforms an image according to one of the following parameters:</p>
<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">off</code>: Turns off image transformation.</li><li class="listitem" style="list-style-type: disc"><code class="literal">test</code>: Ensures that responses are either GIF, JPEG, or PNG images. If not, an error 415 (Unsupported Media Type) is returned.</li><li class="listitem" style="list-style-type: disc"><code class="literal">size</code>: Emits information about an image in JSON format.</li><li class="listitem" style="list-style-type: disc"><code class="literal">rotate</code>: Rotates an image counter-clockwise by either 90, 180, or 270 degrees.</li><li class="listitem" style="list-style-type: disc"><code class="literal">resize</code>: Reduces an image proportionally by the width and height given. One dimension may be "<code class="literal">-</code>" in order to reduce by only the other dimension. If combined with <code class="literal">rotate</code>, rotation happens after reduction. An error will result in returning 415 (Unsupported Media Type).</li><li class="listitem" style="list-style-type: disc"><code class="literal">crop</code>: Reduces an image by the size of the largest side, as specified by the width and height given. Any extraneous space along the other edges will be cut. One dimension may be "<code class="literal">-</code>" in order to reduce by only the other dimension. If combined with <code class="literal">rotate</code>, rotation happens before reduction. An error will result in returning 415 (Unsupported Media Type).</li></ul></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">image_filter_buffer</code>
<a id="id1069" class="indexterm"/>
<a id="id1070" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>The size<a id="id1071" class="indexterm"/> of the buffer used to process images. If more memory is needed, the server will return a 415 error (Unsupported Media Type).</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">image_filter_jpeg_quality</code>
<a id="id1072" class="indexterm"/>
<a id="id1073" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>The quality of the resulting JPEG image, after processing. Not recommended to exceed 95.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">image_filter_sharpen</code>
<a id="id1074" class="indexterm"/>
<a id="id1075" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Increases the sharpness of a processed image by this percentage.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">image_filter_transparency</code>
<a id="id1076" class="indexterm"/>
<a id="id1077" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Disables preserving transparency of transformed GIF and PNG images. The default <code class="literal">on</code> preserves transparency.</p>
</td></tr></tbody></table></div><p>Note that the <code class="literal">empty_gif</code> directive is not part of the <code class="literal">image_filter</code> module, but is included in a default installation of NGINX.</p><p>Using these directives, we <a id="id1078" class="indexterm"/>can construct an image resizing module as follows:</p><div class="informalexample"><pre class="programlisting">location /img {

    try_files $uri /resize/$uri;

}

location ~* /resize/(?.&lt;name&gt;.*)_(?&lt;width&gt;[[:digit:]]*)x(?&lt;height&gt;[[:digit:]]*)\.(?&lt;extension&gt;gif|jpe?g|png)$ {

     error_page 404 = /resizer/$name.$extension?width=$width&amp;height=$height;

}

location /resizer {

    image_filter resize $arg_width $arg_height;

}</pre></div><p>This little<a id="id1079" class="indexterm"/> snippet will first try to serve an image as requested in the URI. If it cannot find an appropriately-named image, it will then move on to the <code class="literal">/resize</code> location. The <code class="literal">/resize</code> location is defined as a regular expression so that we can capture the size we'd like the image to be. Note that we use named capture groups to create meaningful variable names. We then pass these on to the <code class="literal">/resizer</code> location so that we have the name of the original file as the URI and the width and height as named arguments.</p><p>We can now combine this with NGINX's <code class="literal">proxy_store</code> or <code class="literal">proxy_cache</code> capability to save the resized images so that another request for the same URI won't need to hit the <code class="literal">image_filter</code> module:</p><div class="informalexample"><pre class="programlisting">server {

    root /home/www;

    location /img {

        try_files $uri /resize/$uri;

    }

    location /resize {

        error_page 404 = @resizer;
    }

    location @resizer {

        internal;

        proxy_pass http://localhost:8080$uri;

        proxy_store /home/www/img$request_uri;

        proxy_temp_path /home/www/tmp/proxy_temp;

    }

}

server {

    listen 8080;

    root /home/www/img;

    location ~* /resize/(?.&lt;name&gt;.*)_(?&lt;width&gt;[[:digit:]]*)x(?&lt;height&gt;[[:digit:]]*)\.(?&lt;extension&gt;gif|jpe?g|png)$ {

        error_page 404 = /resizer/$name.$extension?width=$width&amp;height=$height;

    }

    location /resizer {

        image_filter resize $arg_width $arg_height;

    }

}</pre></div><p>As you can see in the table of directives for the <code class="literal">image_filter</code> module, any error returned by this module has the code 415. We can catch this error to replace it with an empty GIF, so that the end user will still get an image instead of an error message:</p><div class="informalexample"><pre class="programlisting">location /thumbnail {

    image_filter resize 90 90;

    error_page 415 = @empty;

}
location = @empty {

    access_log off;

    empty_gif;

}</pre></div><p>The <code class="literal">size</code> <a id="id1080" class="indexterm"/>parameter to <code class="literal">image_filter</code> deserves special mention. When this parameter is configured for a location, information about the image is delivered instead of the image itself. This could be useful in your application for discovering metadata about an image before calling a resize or crop URI:</p><div class="informalexample"><pre class="programlisting">location /img {

    image_filter size;

}</pre></div><p>The result is a JSON object such as the following:</p><div class="informalexample"><pre class="programlisting">{ "img" : { "width": 150, "height": 200, "type": "png" } }</pre></div></div></div>
<div class="section" title="Tracking website visitors"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec55"/>Tracking website visitors</h1></div></div></div><p>A fairly unobtrusive <a id="id1081" class="indexterm"/>way to track unique website visitors is to <a id="id1082" class="indexterm"/>use the <code class="literal">userid</code> module. This module sets cookies that are used to identify unique clients. The value of these cookies is referenced by the <code class="literal">$uid_set</code> variable. When that same user returns to the site and the cookie is still valid, the value is available in the <code class="literal">$uid_got</code> variable. An example of how to use these is as follows:</p><div class="informalexample"><pre class="programlisting">http {

    log_format useridcomb '$remote_addr - $uid_got [$time_local] ' 
                    '"$request" $status $body_bytes_sent ' 
                    '"$http_referer" "$http_user_agent"';

    server {

        server_name .example.com;

        access_log logs/example.com-access.log useridcomb;

        userid         on; 
        userid_name    uid; 

        userid_domain  example.com; 

        userid_path    /; 

        userid_expires 365d; 

        userid_p3p     'policyref="/w3c/p3p.xml", CP="CUR ADM OUR NORSTA NID"';

    }

}</pre></div><p>These directives are<a id="id1083" class="indexterm"/> summarized in the following table:</p><div class="section" title="Table: UserID module directives"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl6sec42"/>Table: UserID module directives</h2></div></div></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Directive</p>
</th><th style="text-align: left" valign="bottom">
<p>Explanation</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">userid</code>
<a id="id1084" class="indexterm"/>
<a id="id1085" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Activates the module according to the following parameters:</p>
<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">on</code>: Sets Version 2 cookies and logs those received</li><li class="listitem" style="list-style-type: disc"><code class="literal">v1</code>: Sets Version <a id="id1086" class="indexterm"/>1 cookies and logs those received</li><li class="listitem" style="list-style-type: disc"><code class="literal">log</code>: Disables setting of cookies, but enables logging them</li><li class="listitem" style="list-style-type: disc"><code class="literal">off</code>: Disables both the setting of cookies and the logging of them</li></ul></div>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">userid_domain</code>
<a id="id1087" class="indexterm"/>
<a id="id1088" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Configures a domain to be set in the cookie.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">userid_expires</code>
<a id="id1089" class="indexterm"/>
<a id="id1090" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Sets the age of the cookie. If the keyword <code class="literal">max</code> is used, this translates to <code class="literal">31 Dec 2037 23:55:55 GMT</code>.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">userid_name</code>
<a id="id1091" class="indexterm"/>
<a id="id1092" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Sets the name of the cookie (default is <code class="literal">uid</code>).</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">userid_p3p</code>
<a id="id1093" class="indexterm"/>
<a id="id1094" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Configures the <a id="id1095" class="indexterm"/>P3P header; for sites which declare their privacy policy using the<a id="id1096" class="indexterm"/> <span class="strong"><strong>Platform for Privacy Preferences Project</strong></span>'s protocol.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">userid_path</code>
<a id="id1097" class="indexterm"/>
<a id="id1098" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Defines the path set in the cookie.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">userid_service</code>
<a id="id1099" class="indexterm"/>
<a id="id1100" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Identity of the service that set the cookie. For example, the default value for Version 2 cookies is the IP address of the server that set the cookie.</p>
</td></tr></tbody></table></div></div></div>
<div class="section" title="Preventing inadvertent code execution"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec56"/>Preventing inadvertent code execution</h1></div></div></div><p>When trying to construct<a id="id1101" class="indexterm"/> a configuration that does what you expect it to do, you may inadvertently enable something that you did not expect. Take the following configuration block, for example:</p><div class="informalexample"><pre class="programlisting">location ~* \.php {

    include fastcgi_params;

    fastcgi_pass 127.0.0.1:9000;

}</pre></div><p>Here we seem to be passing all requests for PHP files to the FastCGI server responsible for processing them. This would be OK if PHP only processed the file it was given, but due to differences in how PHP is compiled and configured this may not always be the case. This can become a problem if user uploads are made into the same directory structure that PHP files are in.</p><p>Users may be prevented from uploading files with a <code class="literal">.php</code> extension, but are allowed to upload <code class="literal">.jpg</code>, <code class="literal">.png</code>, and <code class="literal">.gif</code> files. A malicious user could upload an image file with the embedded PHP code, and cause the FastCGI server to execute this code by passing a URI with the uploaded filename in it.</p><p>To prevent this from happening, either set the PHP parameter <code class="literal">cgi.fix_pathinfo</code> to <code class="literal">0</code> or use something similar to the following in your NGINX configuration:</p><div class="informalexample"><pre class="programlisting">location ~* \.php {

    try_files $uri =404;

    include fastcgi_params;

    fastcgi_pass 127.0.0.1:9000;

}</pre></div><p>We have <a id="id1102" class="indexterm"/>used <code class="literal">try_files</code> to ensure that the file actually exists before passing the request on to the FastCGI server for PHP processing.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note16"/>Note</h3><p>Keep in mind that you should evaluate your configuration to see if it matches your goals. If you have only a few files, you would be better served by explicitly specifying which PHP files may be executed instead of the regular expression <code class="literal">location</code> and corresponding <code class="literal">try_files</code>.</p></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec57"/>Summary</h1></div></div></div><p>NGINX provides a number of ways to support developers wishing to integrate a high-performance web server into their application. We looked at various possibilities of integrating both legacy and new applications. Caching plays a key role in the modern web application. NGINX offers both passive and active ways of using caching to help deliver a web page more quickly.</p><p>We also explored how NGINX can help manipulate a response by adding or replacing text. Server Side Includes are also possible with NGINX. We saw a way of integrating these commands into normal text. We then examined the powerful embedded Perl capabilities in NGINX. Image transformation is also possible using just core NGINX. We examined how to set a unique cookie to track website visitors. We wound up the chapter with a word of caution about how to prevent code from inadvertently being executed. On the whole, there are quite a few tools at the developer's disposal when working with NGINX as a web server.</p><p>In the next chapter, we will explore troubleshooting techniques to try to get at the root of the problem when something doesn't work as expected.</p></div></body></html>