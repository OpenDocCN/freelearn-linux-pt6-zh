<html><head></head><body>
<div id="_idContainer060">
<h1 class="chapter-number" id="_idParaDest-191"><a id="_idTextAnchor749"/><span class="koboSpan" id="kobo.1.1">11</span></h1>
<h1 id="_idParaDest-192"><a id="_idTextAnchor750"/><span class="koboSpan" id="kobo.2.1">Troubleshooting</span></h1>
<p><span class="koboSpan" id="kobo.3.1">Even if you read every single word of this book with the utmost attention, you will not unfortunately be sheltered from all kinds of issues, ranging from simple configuration errors to the occasional unexpected behavior of one module or another. </span><span class="koboSpan" id="kobo.3.2">To help you with that, in this chapter, we will attempt to provide solutions for some of the common problems encountered by administrators who are just getting started </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">with NGINX.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">This chapter covers the </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">following topics:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.7.1">A basic guide containing general tips on </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">NGINX troubleshooting</span></span></li>
<li><span class="koboSpan" id="kobo.9.1">How to solve some of the most common </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">install issues</span></span></li>
<li><span class="koboSpan" id="kobo.11.1">Dealing with </span><strong class="source-inline"><span class="koboSpan" id="kobo.12.1">403 Forbidden</span></strong><span class="koboSpan" id="kobo.13.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.14.1">400 Bad Request</span></strong><span class="koboSpan" id="kobo.15.1"> HTTP errors </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">and more</span></span></li>
<li><span class="koboSpan" id="kobo.17.1">Why your configuration does not appear to </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">apply correctly</span></span></li>
<li><span class="koboSpan" id="kobo.19.1">A few words about the </span><strong class="source-inline"><span class="koboSpan" id="kobo.20.1">if</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.21.1">block behavior</span></span><a id="_idTextAnchor751"/></li>
</ul>
<h1 id="_idParaDest-193"><a id="_idTextAnchor752"/><span class="koboSpan" id="kobo.22.1">Looking at some general tips on NGINX troubleshooting</span></h1>
<p><span class="koboSpan" id="kobo.23.1">Before we begin, whenever </span><a id="_idIndexMarker553"/><span class="koboSpan" id="kobo.24.1">you run into some kind of problem with NGINX, you should make sure to follow the recommendations given in the following sections, as they are generally a good source </span><span class="No-Break"><span class="koboSpan" id="kobo.25.1">of solutions</span><a id="_idTextAnchor753"/><span class="koboSpan" id="kobo.26.1">.</span></span><a id="_idTextAnchor754"/></p>
<h2 id="_idParaDest-194"><a id="_idTextAnchor755"/><span class="koboSpan" id="kobo.27.1">Checking access permissions</span></h2>
<p><span class="koboSpan" id="kobo.28.1">A lot of</span><a id="_idIndexMarker554"/><span class="koboSpan" id="kobo.29.1"> errors that NGINX administrators are faced with are caused by invalid access permissions. </span><span class="koboSpan" id="kobo.29.2">On two separate occasions, you have the option to specify a user and group for the NGINX worker processes </span><span class="No-Break"><span class="koboSpan" id="kobo.30.1">to run:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.31.1">When configuring the build with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.32.1">configure</span></strong><span class="koboSpan" id="kobo.33.1"> command, you are allowed to specify a user and group that will be used by default (refer to </span><a href="B21787_01.xhtml#_idTextAnchor014"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.34.1">Chapter 1</span></em></span></a><span class="No-Break"><span class="koboSpan" id="kobo.35.1">).</span></span></li>
<li><span class="koboSpan" id="kobo.36.1">In the configuration file, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.37.1">user</span></strong><span class="koboSpan" id="kobo.38.1"> directive allows you to specify a user and group. </span><span class="koboSpan" id="kobo.38.2">This directive overrides the value that you may have defined during the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.39.1">configure</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.40.1"> step.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.41.1">If NGINX is</span><a id="_idIndexMarker555"/><span class="koboSpan" id="kobo.42.1"> supposed to access files that do not have the correct permissions, in other words, that cannot be read (and by extension, cannot be written for directories that hold temporary files, for example) by the specified user and group, NGINX will not be able to serve files correctly. </span><span class="koboSpan" id="kobo.42.2">Additionally, should your web application encounter an error related to file- or directory-access permissions, the user and group under which your FastCGI or other backend runs should also </span><span class="No-Break"><span class="koboSpan" id="kobo.43.1">be investigat</span><a id="_idTextAnchor756"/><span class="koboSpan" id="kobo.44.1">e</span><a id="_idTextAnchor757"/><span class="koboSpan" id="kobo.45.1">d.</span></span></p>
<h2 id="_idParaDest-195"><a id="_idTextAnchor758"/><span class="koboSpan" id="kobo.46.1">Testing your configuration</span></h2>
<p><span class="koboSpan" id="kobo.47.1">A common </span><a id="_idIndexMarker556"/><span class="koboSpan" id="kobo.48.1">mistake is often made by administrators showing a little too much self-confidence: after having modified the configuration file (often without a backup), they reload NGINX to apply the new configuration. </span><span class="koboSpan" id="kobo.48.2">If the configuration file contains syntax or semantic errors, the application will refuse to reload. </span><span class="koboSpan" id="kobo.48.3">Even worse, if NGINX is stopped (for example, after a complete server reboot) it will refuse to start at all. </span><span class="koboSpan" id="kobo.48.4">In either of those cases, remember to follow </span><span class="No-Break"><span class="koboSpan" id="kobo.49.1">these recommendations:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.50.1">Always keep a backup of your working configuration files in case something </span><span class="No-Break"><span class="koboSpan" id="kobo.51.1">goes wrong</span></span></li>
<li><span class="koboSpan" id="kobo.52.1">Before reloading or restarting NGINX, test your configuration with a simple command, </span><strong class="source-inline"><span class="koboSpan" id="kobo.53.1">nginx -t</span></strong><span class="koboSpan" id="kobo.54.1">, to test your current configuration files, or run </span><strong class="source-inline"><span class="koboSpan" id="kobo.55.1">nginx -t -</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.56.1">c /path/to/config/file.conf</span></strong></span></li>
<li><span class="koboSpan" id="kobo.57.1">Reload your server instead of restarting it, preferring </span><strong class="source-inline"><span class="koboSpan" id="kobo.58.1">systemctl reload nginx</span></strong><span class="koboSpan" id="kobo.59.1"> over </span><strong class="source-inline"><span class="koboSpan" id="kobo.60.1">systemctl restart nginx</span></strong><span class="koboSpan" id="kobo.61.1"> (and </span><strong class="source-inline"><span class="koboSpan" id="kobo.62.1">nginx -s reload</span></strong><span class="koboSpan" id="kobo.63.1"> instead of </span><strong class="source-inline"><span class="koboSpan" id="kobo.64.1">nginx -s stop &amp;&amp; nginx</span></strong><span class="koboSpan" id="kobo.65.1">), as it will keep existing connections alive, and thus won’t interrupt ongoing </span><span class="No-Break"><span class="koboSpan" id="kobo.66.1">file downlo</span><a id="_idTextAnchor759"/><span class="koboSpan" id="kobo.67.1">a</span><a id="_idTextAnchor760"/><span class="koboSpan" id="kobo.68.1">ds</span></span></li>
</ul>
<h2 id="_idParaDest-196"><a id="_idTextAnchor761"/><span class="koboSpan" id="kobo.69.1">Have you reloaded the service?</span></h2>
<p><span class="koboSpan" id="kobo.70.1">You would be </span><a id="_idIndexMarker557"/><span class="koboSpan" id="kobo.71.1">surprised to learn how often this happens: the most complicated situations have the simplest solutions. </span><span class="koboSpan" id="kobo.71.2">Before tearing your hair out, before rushing to the forums or IRC asking for help, start with the most simple </span><span class="No-Break"><span class="koboSpan" id="kobo.72.1">of verifications.</span></span></p>
<p><span class="koboSpan" id="kobo.73.1">You just spent two hours creating your virtual host configuration. </span><span class="koboSpan" id="kobo.73.2">You’ve saved the files properly and have fired up your web browser to check the results. </span><span class="koboSpan" id="kobo.73.3">But did you remember that one additional step? </span><span class="koboSpan" id="kobo.73.4">NGINX, unlike Apache, does not support on-the-fly configuration changes in </span><strong class="source-inline"><span class="koboSpan" id="kobo.74.1">.htaccess</span></strong><span class="koboSpan" id="kobo.75.1"> files or similar. </span><span class="koboSpan" id="kobo.75.2">So take a moment to make sure you have reloaded NGINX with </span><strong class="source-inline"><span class="koboSpan" id="kobo.76.1">systemctl reload nginx</span></strong><span class="koboSpan" id="kobo.77.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.78.1">/usr/local/nginx/sbin/nginx -s reload</span></strong><span class="koboSpan" id="kobo.79.1">, without forgetting to test your </span><span class="No-Break"><span class="koboSpan" id="kobo.80.1">configuration beforeha</span><a id="_idTextAnchor762"/><span class="koboSpan" id="kobo.81.1">n</span><a id="_idTextAnchor763"/><span class="koboSpan" id="kobo.82.1">d!</span></span></p>
<h2 id="_idParaDest-197"><a id="_idTextAnchor764"/><span class="koboSpan" id="kobo.83.1">Checking logs</span></h2>
<p><span class="koboSpan" id="kobo.84.1">There is </span><a id="_idIndexMarker558"/><span class="koboSpan" id="kobo.85.1">usually no need to look for the answer to your problems on the internet. </span><span class="koboSpan" id="kobo.85.2">Chances are, the answer is already given to you by NGINX in the log files. </span><span class="koboSpan" id="kobo.85.3">There are two variations of log files you may want to check. </span><span class="koboSpan" id="kobo.85.4">First, check the access logs. </span><span class="koboSpan" id="kobo.85.5">These contain information about requests themselves: the request method and URI, the HTTP response code issued by NGINX, and more, depending on the log format </span><span class="No-Break"><span class="koboSpan" id="kobo.86.1">you defined:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer058">
<span class="koboSpan" id="kobo.87.1"><img alt="Figure 11.1: An extract of the Nginx error log for troubleshooting and debugging purposes" src="image/B21787_11_1.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.88.1">Figure 11.1: An extract of the Nginx error log for troubleshooting and debugging purposes</span></p>
<p><span class="koboSpan" id="kobo.89.1">More importantly, for troubleshooting, the error log is a goldmine of information. </span><span class="koboSpan" id="kobo.89.2">Depending on the level you defined (see the </span><strong class="source-inline"><span class="koboSpan" id="kobo.90.1">error_log</span></strong><span class="koboSpan" id="kobo.91.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.92.1">debug_connection</span></strong><span class="koboSpan" id="kobo.93.1"> directives for more details), NGINX will provide details on its inner functioning. </span><span class="koboSpan" id="kobo.93.2">For example, you will be able to see the request URI translated to the actual filesystem path. </span><span class="koboSpan" id="kobo.93.3">This can be a great help for debugging rewrite rules. </span><span class="koboSpan" id="kobo.93.4">The error log should be located in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.94.1">/logs/</span></strong><span class="koboSpan" id="kobo.95.1"> directory of your NGINX setup, by default </span><strong class="source-inline"><span class="koboSpan" id="kobo.96.1">/usr/local/nginx/logs</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.97.1">or </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.98.1">/var/log/nginx</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.99.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.100.1">In this section, we learned how to troubleshoot NGINX running errors. </span><span class="koboSpan" id="kobo.100.2">Moving forward, we’ll explore the use of external tools to streamline the aggregation of NGINX errors for more </span><span class="No-Break"><span class="koboSpan" id="kobo.101.1">efficient troubleshoo</span><a id="_idTextAnchor765"/><span class="koboSpan" id="kobo.102.1">t</span><a id="_idTextAnchor766"/><span class="koboSpan" id="kobo.103.1">ing.</span></span></p>
<h1 id="_idParaDest-198"><a id="_idTextAnchor767"/><span class="koboSpan" id="kobo.104.1">Installing a log parser</span></h1>
<p><span class="koboSpan" id="kobo.105.1">While NGINX </span><a id="_idIndexMarker559"/><span class="koboSpan" id="kobo.106.1">has great logs, at some of the higher levels of logging, they can also be quite exhaustive in the amount of information they log. </span><span class="koboSpan" id="kobo.106.2">A good way to not miss information and get a high-level overview of what is going on with NGINX is to install a log parser that can aggregate information and display it in a more </span><span class="No-Break"><span class="koboSpan" id="kobo.107.1">approachable format.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.108.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.109.1">One open source tool we can use for this </span><a id="_idIndexMarker560"/><span class="koboSpan" id="kobo.110.1">is called </span><strong class="bold"><span class="koboSpan" id="kobo.111.1">GoAccess</span></strong><span class="koboSpan" id="kobo.112.1">. </span><span class="koboSpan" id="kobo.112.2">More info can be found on its website </span><span class="No-Break"><span class="koboSpan" id="kobo.113.1">at </span></span><a href="https://goaccess.io/"><span class="No-Break"><span class="koboSpan" id="kobo.114.1">https://goaccess.io/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.115.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.116.1">The good thing about GoAccess, aside from being free and open source, is that it can be accessed through both the Terminal and your browser. </span><span class="koboSpan" id="kobo.116.2">Therefore, it can function as both a monitoring tool that you run in your Terminal and as a reporting tool that generates a kind of dashboard for </span><span class="No-Break"><span class="koboSpan" id="kobo.117.1">your stats:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer059">
<span class="koboSpan" id="kobo.118.1"><img alt="Figure 11.2: GoAccess analyzing and organizing Nginx logs for a clear view" src="image/B21787_11_2.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.119.1">Figure 11.2: GoAccess analyzing and organizing Nginx logs for a clear view</span></p>
<p><span class="koboSpan" id="kobo.120.1">To </span><a id="_idIndexMarker561"/><span class="koboSpan" id="kobo.121.1">get </span><a id="_idIndexMarker562"/><span class="koboSpan" id="kobo.122.1">started and install GoAccess, you can either check your distribution package manager (whether with </span><strong class="source-inline"><span class="koboSpan" id="kobo.123.1">apt</span></strong><span class="koboSpan" id="kobo.124.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.125.1">dnf</span></strong><span class="koboSpan" id="kobo.126.1"> or else) or download and compile </span><span class="No-Break"><span class="koboSpan" id="kobo.127.1">it manually:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.128.1">
wget http://tar.goaccess.io/goaccess-1.9.1.tar.gz
tar -xzvf goaccess-1.9.1.tar.gz
cd goaccess-1.9.1/
./configure --enable-utf8 --enable-geoip=mmdb
make
make install</span></pre> <p><span class="koboSpan" id="kobo.129.1">Once installed, using it is very straightforward; you can get a Terminal view by running the </span><span class="No-Break"><span class="koboSpan" id="kobo.130.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.131.1">
goaccess /var/log/nginx/access.log --log-format=COMBINED</span></pre> <p><span class="koboSpan" id="kobo.132.1">Here, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.133.1">COMBINED</span></strong><span class="koboSpan" id="kobo.134.1"> log format refers to the default log format of NGINX, but it is also compatible with Apache HTTPd logs. </span><span class="koboSpan" id="kobo.134.2">If you want to get an HTML report that you can view in a browser, or perhaps email to someone for reporting, then run </span><span class="No-Break"><span class="koboSpan" id="kobo.135.1">the following:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.136.1">
goaccess /var/log/nginx/access.log -o report.html --log-format=COMBINED</span></pre> <p><span class="koboSpan" id="kobo.137.1">A neat </span><a id="_idIndexMarker563"/><span class="koboSpan" id="kobo.138.1">feature of GoAccess is that it can also provide a real-time auto-updating HTML page by using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.139.1">--real-time-html</span></strong><span class="koboSpan" id="kobo.140.1"> flag. </span><span class="koboSpan" id="kobo.140.2">Enabling this will add some WebSocket code to the report that will fetch the latest stats continuously. </span><span class="koboSpan" id="kobo.140.3">Create a location block for your report and point it to your </span><strong class="source-inline"><span class="koboSpan" id="kobo.141.1">report.html</span></strong><span class="koboSpan" id="kobo.142.1"> to have a report always </span><span class="No-Break"><span class="koboSpan" id="kobo.143.1">available</span><a id="_idTextAnchor768"/><span class="koboSpan" id="kobo.144.1"> online.</span></span></p>
<p><span class="koboSpan" id="kobo.145.1">We’ve covered how to handle NGINX log errors. </span><span class="koboSpan" id="kobo.145.2">Up next, we’ll dive into the challenges of compiling and </span><span class="No-Break"><span class="koboSpan" id="kobo.146.1">installin</span><a id="_idTextAnchor769"/><span class="koboSpan" id="kobo.147.1">g NGINX.</span></span></p>
<h1 id="_idParaDest-199"><a id="_idTextAnchor770"/><span class="koboSpan" id="kobo.148.1">Troubleshooting install issues</span></h1>
<p><span class="koboSpan" id="kobo.149.1">There are </span><a id="_idIndexMarker564"/><span class="koboSpan" id="kobo.150.1">typically four sources of errors when attempting to </span><a id="_idIndexMarker565"/><span class="koboSpan" id="kobo.151.1">install NGINX or to run it for the </span><span class="No-Break"><span class="koboSpan" id="kobo.152.1">first time:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.153.1">Some of the prerequisites are missing or an invalid path to the source was specified. </span><span class="koboSpan" id="kobo.153.2">More details about prerequisites can be found in </span><a href="B21787_01.xhtml#_idTextAnchor014"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.154.1">Chapter 1</span></em></span></a><span class="No-Break"><span class="koboSpan" id="kobo.155.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.156.1">After having installed NGINX correctly, you cannot use the SSL-related directives to host a secure website. </span><span class="koboSpan" id="kobo.156.2">Have you made sure to include the SSL module correctly during the </span><strong class="source-inline"><span class="koboSpan" id="kobo.157.1">configure</span></strong><span class="koboSpan" id="kobo.158.1"> step? </span><span class="koboSpan" id="kobo.158.2">More details are in </span><a href="B21787_01.xhtml#_idTextAnchor014"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.159.1">Chapter 1</span></em></span></a><span class="No-Break"><span class="koboSpan" id="kobo.160.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.161.1">NGINX refuses to start and outputs a message similar to </span><strong class="source-inline"><span class="koboSpan" id="kobo.162.1">[emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)</span></strong><span class="koboSpan" id="kobo.163.1">. </span><span class="koboSpan" id="kobo.163.2">This error signifies that another application is utilizing the network port </span><strong class="source-inline"><span class="koboSpan" id="kobo.164.1">80</span></strong><span class="koboSpan" id="kobo.165.1">. </span><span class="koboSpan" id="kobo.165.2">This could either mean that another web server, such as Apache, is already running on the machine, or that you don’t have the proper permissions to open a server socket on this port. </span><span class="koboSpan" id="kobo.165.3">This can happen if you are running NGINX from an underprivileged </span><span class="No-Break"><span class="koboSpan" id="kobo.166.1">system account.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.167.1">NGINX refuses to start and outputs a message similar to </span><strong class="source-inline"><span class="koboSpan" id="kobo.168.1">[emerg] 3629#0: open() "/path/to/logs/access.log" failed (2: No such file or directory)</span></strong><span class="koboSpan" id="kobo.169.1">. </span><span class="koboSpan" id="kobo.169.2">In this case, one of the files that NGINX tries to open, such as a log file, cannot be accessed. </span><span class="koboSpan" id="kobo.169.3">This </span><a id="_idIndexMarker566"/><span class="koboSpan" id="kobo.170.1">could be caused by invalid access</span><a id="_idIndexMarker567"/><span class="koboSpan" id="kobo.171.1"> permissions or by an invalid directory path (for example, when specifying log files to be stored in a directory that does not exist on</span><a id="_idTextAnchor771"/><span class="koboSpan" id="kobo.172.1"> the system). </span><span class="koboSpan" id="kobo.172.2">After addressing NGINX’s compilation challenges, we’ll explore location block and error nuances. </span><span class="koboSpan" id="kobo.172.3">Though NGINX functions, we’ll learn to adjust these settings to meet </span><span class="No-Break"><span class="koboSpan" id="kobo.173.1">our e</span><a id="_idTextAnchor772"/><span class="koboSpan" id="kobo.174.1">xpectations.</span></span></p>
<h1 id="_idParaDest-200"><a id="_idTextAnchor773"/><span class="koboSpan" id="kobo.175.1">Looking at the 403 forbidden custom error page</span></h1>
<p><span class="koboSpan" id="kobo.176.1">If you </span><a id="_idIndexMarker568"/><span class="koboSpan" id="kobo.177.1">decide to use </span><strong class="source-inline"><span class="koboSpan" id="kobo.178.1">allow</span></strong><span class="koboSpan" id="kobo.179.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.180.1">deny</span></strong><span class="koboSpan" id="kobo.181.1"> directives to allow or deny access, respectively, to a resource on your server, clients who are being denied access will usually fall back on a </span><strong class="source-inline"><span class="koboSpan" id="kobo.182.1">403 Forbidden</span></strong><span class="koboSpan" id="kobo.183.1"> error page. </span><span class="koboSpan" id="kobo.183.2">Imagine you have carefully set up a custom, user-friendly 403 error page for your clients to understand why they are denied access. </span><span class="koboSpan" id="kobo.183.3">Unfortunately, you cannot get that custom page to work, and clients still get the default NGINX 403 </span><span class="No-Break"><span class="koboSpan" id="kobo.184.1">error page:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.185.1">
server {
    [...]
    allow 192.168.0.0/16;
    deny all;
    error_page 403 /error403.html;
}</span></pre> <p><span class="koboSpan" id="kobo.186.1">The problem is simple: NGINX also denies access to your custom 403 error page! </span><span class="koboSpan" id="kobo.186.2">In such a case, you need to override the access rules in a </span><strong class="source-inline"><span class="koboSpan" id="kobo.187.1">location</span></strong><span class="koboSpan" id="kobo.188.1"> block specifically matching your page. </span><span class="koboSpan" id="kobo.188.2">You can use the following code to allow access to your custom 403 error </span><span class="No-Break"><span class="koboSpan" id="kobo.189.1">page only:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.190.1">
server {
    [...]
    location / {
        error_page 403 /error403.html;
        allow 192.168.0.0/16;
        deny all;
    }
    location = /error403.html {
        allow all;
    }
}</span></pre> <p><span class="koboSpan" id="kobo.191.1">If you are </span><a id="_idIndexMarker569"/><span class="koboSpan" id="kobo.192.1">going to have more than just one error page, you could specify a </span><strong class="source-inline"><span class="koboSpan" id="kobo.193.1">location</span></strong><span class="koboSpan" id="kobo.194.1"> block matching all error </span><span class="No-Break"><span class="koboSpan" id="kobo.195.1">page filenames:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.196.1">
server {
    [...]
    location / {
        error_page 403 /error403.html;
        error_page 404 /error404.html;
        allow 192.168.0.0/16;
        deny all;
    }
    location ~ "^/error[0-9]{3}.html$" {
        allow all;
    }
}</span></pre> <p><span class="koboSpan" id="kobo.197.1">All your visitors are now allowed to view your custo</span><a id="_idTextAnchor774"/><a id="_idTextAnchor775"/><span class="koboSpan" id="kobo.198.1">m </span><span class="No-Break"><span class="koboSpan" id="kobo.199.1">error pages.</span></span></p>
<h1 id="_idParaDest-201"><a id="_idTextAnchor776"/><span class="koboSpan" id="kobo.200.1">Exploring 400 Bad Request</span></h1>
<p><span class="koboSpan" id="kobo.201.1">Occasionally, you</span><a id="_idIndexMarker570"/><span class="koboSpan" id="kobo.202.1"> may run into a recurring issue with some of your websites: NGINX returns </span><strong class="source-inline"><span class="koboSpan" id="kobo.203.1">400 Bad Request</span></strong><span class="koboSpan" id="kobo.204.1"> error pages to random visitors, and this only stops happening when visitors clear their cache and cookies. </span><span class="koboSpan" id="kobo.204.2">The error is caused by an overly large header field sent by the client. </span><span class="koboSpan" id="kobo.204.3">Most of the time, this is when cookie data exceeds a certain size. </span><span class="koboSpan" id="kobo.204.4">In order to prevent further trouble, you can simply increase the value of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.205.1">large_client_header_buffers</span></strong><span class="koboSpan" id="kobo.206.1"> directive in order to allow a larger cookie </span><span class="No-Break"><span class="koboSpan" id="kobo.207.1">data size:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.208.1">
large_client_header_buffers 4 16k;</span></pre> <p><span class="koboSpan" id="kobo.209.1">In addition to adjusting the </span><strong class="source-inline"><span class="koboSpan" id="kobo.210.1">large_client_header_buffers</span></strong><span class="koboSpan" id="kobo.211.1"> for resolving 400 Bad Request errors, it’s also worth examining directives such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.212.1">proxy_buffers</span></strong><span class="koboSpan" id="kobo.213.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.214.1">proxy_buffer_size</span></strong><span class="koboSpan" id="kobo.215.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.216.1">proxy_busy_buffers_size</span></strong><span class="koboSpan" id="kobo.217.1">. </span><span class="koboSpan" id="kobo.217.2">Modifying these settings can further mitigate error 400 by optimizing how NGINX handles</span><a id="_idTextAnchor777"/><a id="_idTextAnchor778"/> <span class="No-Break"><span class="koboSpan" id="kobo.218.1">incoming data.</span></span></p>
<h1 id="_idParaDest-202"><a id="_idTextAnchor779"/><span class="koboSpan" id="kobo.219.1">Looking at truncated or invalid FastCGI responses</span></h1>
<p><span class="koboSpan" id="kobo.220.1">When</span><a id="_idIndexMarker571"/><span class="koboSpan" id="kobo.221.1"> setting up an NGINX frontend for a website that heavily</span><a id="_idIndexMarker572"/><span class="koboSpan" id="kobo.222.1"> relies on </span><strong class="bold"><span class="koboSpan" id="kobo.223.1">AJAX</span></strong><span class="koboSpan" id="kobo.224.1"> (short for </span><strong class="bold"><span class="koboSpan" id="kobo.225.1">Asynchronous JavaScript and XML</span></strong><span class="koboSpan" id="kobo.226.1">), along with a FastCGI backend such as PHP, you may run into different sorts of problems. </span><span class="koboSpan" id="kobo.226.2">If your server returns truncated AJAX responses, invalid JSON values, or even empty responses, you may want to check your configuration for the </span><span class="No-Break"><span class="koboSpan" id="kobo.227.1">following elements:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.228.1">Have you set up a writable directory for FastCGI temporary files? </span><span class="koboSpan" id="kobo.228.2">Make sure to do so via the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.229.1">fastcgi_temp_path</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.230.1"> directive.</span></span></li>
<li><span class="koboSpan" id="kobo.231.1">If </span><strong class="source-inline"><span class="koboSpan" id="kobo.232.1">fastcgi_buffering</span></strong><span class="koboSpan" id="kobo.233.1"> is set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.234.1">off</span></strong><span class="koboSpan" id="kobo.235.1">, all FastCGI responses are forwarded to the client synchronously, in chunks of a certain size (determined </span><span class="No-Break"><span class="koboSpan" id="kobo.236.1">by </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.237.1">fastcgi_buffer_size</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.238.1">).</span></span></li>
<li><span class="koboSpan" id="kobo.239.1">In some cases, increasing the size and number of buffers allocated to storing FastCGI responses prevents responses from getting truncated. </span><span class="koboSpan" id="kobo.239.2">For example, use </span><strong class="source-inline"><span class="koboSpan" id="kobo.240.1">fastcgi_buffers 256 8k;</span></strong><span class="koboSpan" id="kobo.241.1"> for 256 buffers of </span><a id="_idTextAnchor780"/><a id="_idTextAnchor781"/><span class="koboSpan" id="kobo.242.1">8 </span><span class="No-Break"><span class="koboSpan" id="kobo.243.1">kilobytes each.</span></span></li>
</ul>
<h1 id="_idParaDest-203"><a id="_idTextAnchor782"/><span class="koboSpan" id="kobo.244.1">Exploring location block priorities</span></h1>
<p><span class="koboSpan" id="kobo.245.1">This problem</span><a id="_idIndexMarker573"/><span class="koboSpan" id="kobo.246.1"> frequently occurs when using multiple location blocks in the same server block: configuration does not apply as you thought </span><span class="No-Break"><span class="koboSpan" id="kobo.247.1">it would.</span></span></p>
<p><span class="koboSpan" id="kobo.248.1">As an example, suppose that you want to define a behavior to be applied to all image files that are requested </span><span class="No-Break"><span class="koboSpan" id="kobo.249.1">by clients:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.250.1">
location ~* .(gif|jpg|jpeg|png)$ {
    # matches any request for GIF/JPG/JPEG/PNG files
    proxy_pass http://imageserver; # proxy pass to backend
}</span></pre> <p><span class="koboSpan" id="kobo.251.1">Later on, you decide to enable automatic indexing of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.252.1">/images/</span></strong><span class="koboSpan" id="kobo.253.1"> directory. </span><span class="koboSpan" id="kobo.253.2">Therefore, you decide to create a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.254.1">location</span></strong><span class="koboSpan" id="kobo.255.1"> block, matching all requests starting </span><span class="No-Break"><span class="koboSpan" id="kobo.256.1">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.257.1">/images/</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.258.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.259.1">
location ^~ /images/ {
    # matches any request that starts with /images/
    autoindex on;
}</span></pre> <p><span class="koboSpan" id="kobo.260.1">With this configuration, when a client requests to download </span><strong class="source-inline"><span class="koboSpan" id="kobo.261.1">/images/square.gif</span></strong><span class="koboSpan" id="kobo.262.1">, NGINX will apply the second location’s block only. </span><span class="koboSpan" id="kobo.262.2">Why not the first one? </span><span class="koboSpan" id="kobo.262.3">The reason is that </span><strong class="source-inline"><span class="koboSpan" id="kobo.263.1">location</span></strong><span class="koboSpan" id="kobo.264.1"> blocks are processed in a specific order. </span><span class="koboSpan" id="kobo.264.2">For more information about </span><strong class="source-inline"><span class="koboSpan" id="kobo.265.1">location</span></strong><span class="koboSpan" id="kobo.266.1"> block priorities, refer to the </span><em class="italic"><span class="koboSpan" id="kobo.267.1">Location block</span></em><span class="koboSpan" id="kobo.268.1"> sec</span><a id="_idTextAnchor783"/><a id="_idTextAnchor784"/><span class="koboSpan" id="kobo.269.1">tion in </span><a href="B21787_03.xhtml#_idTextAnchor179"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.270.1">Chapter 3</span></em></span></a><span class="No-Break"><span class="koboSpan" id="kobo.271.1">.</span></span></p>
<h1 id="_idParaDest-204"><a id="_idTextAnchor785"/><span class="koboSpan" id="kobo.272.1">Looking at if block issues</span></h1>
<p><span class="koboSpan" id="kobo.273.1">In some situations, if </span><a id="_idIndexMarker574"/><span class="koboSpan" id="kobo.274.1">not most, you should avoid using </span><strong class="source-inline"><span class="koboSpan" id="kobo.275.1">if</span></strong><span class="koboSpan" id="kobo.276.1"> blocks. </span><span class="koboSpan" id="kobo.276.2">There are two main issues that occur, regardless of the NGINX </span><a id="_idTextAnchor786"/><span class="koboSpan" id="kobo.277.1">b</span><a id="_idTextAnchor787"/><span class="koboSpan" id="kobo.278.1">uild you </span><span class="No-Break"><span class="koboSpan" id="kobo.279.1">are using.</span></span></p>
<h2 id="_idParaDest-205"><a id="_idTextAnchor788"/><span class="koboSpan" id="kobo.280.1">Inefficient statements</span></h2>
<p><span class="koboSpan" id="kobo.281.1">There are</span><a id="_idIndexMarker575"/><span class="koboSpan" id="kobo.282.1"> some cases where </span><strong class="source-inline"><span class="koboSpan" id="kobo.283.1">if</span></strong><span class="koboSpan" id="kobo.284.1"> is used inappropriately, in a way that risks saturating your storage device with </span><span class="No-Break"><span class="koboSpan" id="kobo.285.1">useless checks:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.286.1">
location / {
    # Redirect to index.php if the requested file is not found
    if (!-e $request_filename) {
       rewrite ^ index.php last;
    }
}</span></pre> <p><span class="koboSpan" id="kobo.287.1">With such a configuration, every single request received by NGINX will trigger a complete verification of the directory tree for the requested filename, thus requiring multiple storage disk access system calls. </span><span class="koboSpan" id="kobo.287.2">If you test </span><strong class="source-inline"><span class="koboSpan" id="kobo.288.1">/usr/local/nginx/html/hello.html</span></strong><span class="koboSpan" id="kobo.289.1">, NGINX will check </span><strong class="source-inline"><span class="koboSpan" id="kobo.290.1">/</span></strong><span class="koboSpan" id="kobo.291.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.292.1">/usr</span></strong><span class="koboSpan" id="kobo.293.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.294.1">/usr/local</span></strong><span class="koboSpan" id="kobo.295.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.296.1">/usr/local/nginx</span></strong><span class="koboSpan" id="kobo.297.1">, and so on. </span><span class="koboSpan" id="kobo.297.2">In any case, you should avoid resorting to such a statement, for example, by filtering the file type beforehand (which could be done by making such a check only if the requested file matches </span><span class="No-Break"><span class="koboSpan" id="kobo.298.1">specific extensions):</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.299.1">
location / {
    # Filter file extension first
    if ($request_filename !~ ".(gif|jpg|jpeg|png)" {
       break;
    }
    if (!-f $request_filename) {
       rewrite ^ index</span><a id="_idTextAnchor789"/><span class="koboSpan" id="kobo.300.1">.</span><a id="_idTextAnchor790"/><span class="koboSpan" id="kobo.301.1">php last;
    }
}</span></pre> <h2 id="_idParaDest-206"><a id="_idTextAnchor791"/><span class="koboSpan" id="kobo.302.1">Unexpected behavior</span></h2>
<p><span class="koboSpan" id="kobo.303.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.304.1">if</span></strong><span class="koboSpan" id="kobo.305.1"> block </span><a id="_idIndexMarker576"/><span class="koboSpan" id="kobo.306.1">should ideally be employed in simple situations, as its behavior might be surprising in some cases. </span><span class="koboSpan" id="kobo.306.2">Apart from the fact that </span><strong class="source-inline"><span class="koboSpan" id="kobo.307.1">if</span></strong><span class="koboSpan" id="kobo.308.1"> statements cannot be nested, the following situations may </span><span class="No-Break"><span class="koboSpan" id="kobo.309.1">present issues:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.310.1">
# Two consecutive statements with the same condition:
location / {
    if ($uri = "/test.html") {
       add_header X-Test-1 1;
       expires 7;
    }
    if ($uri = "/test.html") {
       add_header X-Test-1 1;
    }
}</span></pre> <p><span class="koboSpan" id="kobo.311.1">In this case, the first </span><strong class="source-inline"><span class="koboSpan" id="kobo.312.1">if</span></strong><span class="koboSpan" id="kobo.313.1"> block is ignored and only the second one is processed. </span><span class="koboSpan" id="kobo.313.2">However, if you insert a </span><em class="italic"><span class="koboSpan" id="kobo.314.1">Rewrite module</span></em><span class="koboSpan" id="kobo.315.1"> directive in the first block, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.316.1">rewrite</span></strong><span class="koboSpan" id="kobo.317.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.318.1">break</span></strong><span class="koboSpan" id="kobo.319.1">, or </span><strong class="source-inline"><span class="koboSpan" id="kobo.320.1">return</span></strong><span class="koboSpan" id="kobo.321.1">, the first block will be processed and the second one will </span><span class="No-Break"><span class="koboSpan" id="kobo.322.1">be ignored.</span></span></p>
<p><span class="koboSpan" id="kobo.323.1">There are many other cases where the use of </span><strong class="source-inline"><span class="koboSpan" id="kobo.324.1">if</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.325.1">causes problems:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.326.1">Having </span><strong class="source-inline"><span class="koboSpan" id="kobo.327.1">try_files</span></strong><span class="koboSpan" id="kobo.328.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.329.1">if</span></strong><span class="koboSpan" id="kobo.330.1"> statements in the same location block is not recommended, as the </span><strong class="source-inline"><span class="koboSpan" id="kobo.331.1">try_files</span></strong><span class="koboSpan" id="kobo.332.1"> directive will, in most cases, </span><span class="No-Break"><span class="koboSpan" id="kobo.333.1">be ignored.</span></span></li>
<li><span class="koboSpan" id="kobo.334.1">Some directives are theoretically allowed within the </span><strong class="source-inline"><span class="koboSpan" id="kobo.335.1">if</span></strong><span class="koboSpan" id="kobo.336.1"> block, but can create serious issues; for instance, </span><strong class="source-inline"><span class="koboSpan" id="kobo.337.1">proxy_pass</span></strong><span class="koboSpan" id="kobo.338.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.339.1">fastcgi_pass</span></strong><span class="koboSpan" id="kobo.340.1">. </span><span class="koboSpan" id="kobo.340.2">You should keep those within </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.341.1">location</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.342.1"> blocks.</span></span></li>
<li><span class="koboSpan" id="kobo.343.1">You should avoid using </span><strong class="source-inline"><span class="koboSpan" id="kobo.344.1">if</span></strong><span class="koboSpan" id="kobo.345.1"> blocks within a </span><strong class="source-inline"><span class="koboSpan" id="kobo.346.1">location</span></strong><span class="koboSpan" id="kobo.347.1"> block that captures regular expression patterns from within </span><span class="No-Break"><span class="koboSpan" id="kobo.348.1">its modifier.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.349.1">These issues originate from the fact that while the NGINX configuration is written in what appears to be a </span><a id="_idIndexMarker577"/><span class="koboSpan" id="kobo.350.1">declarative language, directives from the Rewrite module, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.351.1">if</span></strong><span class="koboSpan" id="kobo.352.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.353.1">rewrite</span></strong><span class="koboSpan" id="kobo.354.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.355.1">return</span></strong><span class="koboSpan" id="kobo.356.1">, or </span><strong class="source-inline"><span class="koboSpan" id="kobo.357.1">break</span></strong><span class="koboSpan" id="kobo.358.1">, make it look like event-based programming. </span><span class="koboSpan" id="kobo.358.2">In general, you should try to avoid using directives from other modules within </span><strong class="source-inline"><span class="koboSpan" id="kobo.359.1">if</span></strong><span class="koboSpan" id="kobo.360.1"> bloc</span><a id="_idTextAnchor792"/><span class="koboSpan" id="kobo.361.1">k</span><a id="_idTextAnchor793"/><span class="koboSpan" id="kobo.362.1">s as much </span><span class="No-Break"><span class="koboSpan" id="kobo.363.1">as possible.</span></span></p>
<h1 id="_idParaDest-207"><a id="_idTextAnchor794"/><span class="koboSpan" id="kobo.364.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.365.1">Most of the problems you can run into will occur during the early configuration stages while you test your server before production. </span><span class="koboSpan" id="kobo.365.2">These problems are usually easier to deal with because you are mentally prepared for the challenge, and more importantly, because NGINX points out syntax or configuration errors on startup. </span><span class="koboSpan" id="kobo.365.3">It is, on the other hand, much more difficult to identify the cause of malfunctions while your websites are actually in production. </span><span class="koboSpan" id="kobo.365.4">But once again, NGINX saves the day: if you properly configure log files (both access and error logs) and adopt the habit of reading them regularly, you will find that problem-solving is </span><span class="No-Break"><span class="koboSpan" id="kobo.366.1">made easy.</span></span></p>
<p><span class="koboSpan" id="kobo.367.1">This concludes our journey with NGINX, throughout which we have walked through a large number of subjects, from the basic mechanisms of the HTTP server to web application deployment </span><span class="No-Break"><span class="koboSpan" id="kobo.368.1">and troubleshooting.</span></span></p>
<p><span class="koboSpan" id="kobo.369.1">If you want to know more about NGINX, we invite you to dive into the vibrant NGINX community, a collaborative hub teeming with expertise and innovative ideas. </span><span class="koboSpan" id="kobo.369.2">Whether seeking advice for your projects or offering your own insights, the community is an invaluable resource for broadening your understanding and refining your skills. </span><span class="koboSpan" id="kobo.369.3">Engage in discussions, share solutions, and connect with fellow enthusiasts to further your journey </span><span class="No-Break"><span class="koboSpan" id="kobo.370.1">with NGINX.</span></span></p>
</div>
</body></html>