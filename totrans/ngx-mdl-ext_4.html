<html><head></head><body><div class="chapter" title="Chapter&#xA0;4.&#xA0;Installing Third-party Modules"><div class="titlepage"><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Installing Third-party Modules</h1></div></div></div><p>In this chapter we will explore the installation of third-party modules. Third-party modules are developed by a vast variety of developers around the world and are hosted on various open source repositories such as GitHub and SourceForge. Some of these modules are well tested while others are not quite ready for production. These modules are not officially supported by Nginx developers and might have issues across different Nginx versions. In this chapter, we will talk about some of the most well-known Nginx modules. A bigger list of available options can be browsed on the Nginx website at <a class="ulink" href="http://wiki.nginx.org/3rdPartyModules">http://wiki.nginx.org/3rdPartyModules</a>.</p><p>All the configuration directives that we have discussed so far, and the ones that we will discuss in this and the remaining chapters, are specified in the <code class="literal">nginx.conf</code> file. The default location of the <code class="literal">nginx.conf</code> file is <code class="literal">/usr/local/conf/</code>.</p><div class="section" title="Compiling third-party modules"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec16"/>Compiling third-party modules</h1></div></div></div><p>None of the third-party modules that we will be covering in this chapter are distributed with the source code. <a id="id351" class="indexterm"/>You will have to download the source code and compile it by specifying its location while compiling Nginx. You can do that by specifying the <code class="literal">--add-module</code> parameters while running <code class="literal">configure</code>. For example, if you downloaded the module's source code present in <code class="literal">/opt/downloads</code>, you can compile it in the Nginx binary with the following code:</p><div class="informalexample"><pre class="programlisting">configure --add-module=/opt/downloads/module-folder</pre></div><p>Some of these modules may have additional dependencies, which you will have to resolve. Please refer to the documentation of the module you are trying to install, to make sure you understand the consequences and dependencies of the module you are about to compile.</p><div class="section" title="Communicating with PostgreSQL (ngx_postgres)"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec32"/>Communicating with PostgreSQL (ngx_postgres)</h2></div></div></div><p>The Nginx PostgreSQL module<a id="id352" class="indexterm"/> is currently hosted at <a class="ulink" href="http://labs.frickle.com/nginx_ngx_postgres/">http://labs.frickle.com/nginx_ngx_postgres/</a> and maintained by Frickle Labs. It is an upstream module that<a id="id353" class="indexterm"/> allows direct communication with the PostgreSQL database. The output of this module is in a custom binary format named <span class="strong"><strong>Resty DBD Stream</strong></span> (<span class="strong"><strong>RDS</strong></span>).<a id="id354" class="indexterm"/>This module is useful if you want to directly connect Nginx to a PostgreSQL database. There can be several use-cases of why you would want to do that. You might want to serve pages by directly querying results from a table. You might also want to log things in a database or check certain conditions by querying a database table. Or you might want to authenticate a user from an upstream PostgreSQL database. For all such situations and more, the <code class="literal">ngx_postgres</code> module will be useful.</p><p>An example configuration is as follows:</p><div class="informalexample"><pre class="programlisting">http {
    upstream database {
        postgres_server  127.0.0.1 dbname=test
                         user=user password=password;
    }

    server {
        location / {
            postgres_pass   database;
            postgres_query  "select * from users";
        }
    }
}</pre></div><div class="section" title="Explaining directives"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec47"/>Explaining directives</h3></div></div></div><p>Some important directives <a id="id355" class="indexterm"/>of the <code class="literal">ngx_postgres</code> module are as follows:</p><div class="section" title="postgres_server"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec60"/>postgres_server</h4></div></div></div><p>The <code class="literal">postgres_server</code> directive <a id="id356" class="indexterm"/>sets the details of the<a id="id357" class="indexterm"/> database server. You can specify the hostname or IP address along with a port, username, and password.</p><p>An example configuration is as follows:</p><div class="informalexample"><pre class="programlisting">postgres_server  127.0.0.1 dbname=test user=test password=test;</pre></div></div><div class="section" title="postgres_keepalive"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec61"/>postgres_keepalive</h4></div></div></div><p>The <code class="literal">postgres_keepalive</code> directive<a id="id358" class="indexterm"/> is used<a id="id359" class="indexterm"/> to configure <code class="literal">keepalive</code> parameters. The syntax is as follows:</p><div class="informalexample"><pre class="programlisting">postgres_keepalive off | max=count [mode=single|multi] [overflow=ignore|reject]
default: max=10 mode=single overflow=ignore</pre></div><p>Here, the <code class="literal">max</code> parameter determines the maximum number of <code class="literal">keepalive</code> connections. The <code class="literal">mode</code> parameter has two <a id="id360" class="indexterm"/>possible values, <code class="literal">multi</code> and <code class="literal">single</code>. The <code class="literal">single</code> mode means that the connection pool will not differentiate between multiple <code class="literal">postgres_server</code> definitions in the current block<a id="id361" class="indexterm"/> and will apply to all of them, that is, you have one pool for all the <code class="literal">postgres_server</code> definitions. In the <code class="literal">multi</code> mode, the pool will re-use connections that have identical server hostnames and ports. The default value is <code class="literal">single</code>. The <code class="literal">overflow</code> option specifies what to do when the connection pool is already full and a new database connection is required. Either <code class="literal">reject</code> or <code class="literal">ignore</code> can be specified. In case of <code class="literal">reject</code>, it will reject the current request and return the <span class="strong"><strong>503 Service Unavailable</strong></span> error page. On using <code class="literal">ignore</code>, this module will create a new database connection.</p></div><div class="section" title="postgres_pass"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec62"/>postgres_pass</h4></div></div></div><p>The <code class="literal">postgres_pass</code> directive<a id="id362" class="indexterm"/> holds the name of the upstream block that <a id="id363" class="indexterm"/>contains the PostgreSQL <a id="id364" class="indexterm"/>connection's configurations. It can also contain variables.</p></div><div class="section" title="postgres_query"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec63"/>postgres_query</h4></div></div></div><p>The <code class="literal">postgres_query</code> directive<a id="id365" class="indexterm"/> is used to specify a PostgreSQL query. If an HTTP method such as <code class="literal">GET</code>, <code class="literal">POST</code>, <code class="literal">PUT</code>, or <code class="literal">DELETE</code> is specified, the query is used only for the specified methods; otherwise,<a id="id366" class="indexterm"/> it will run for all the methods. A query can contain variables and you can specify multiple query directives in one location. An example configuration is as follows:</p><div class="informalexample"><pre class="programlisting">postgres_query    GET POST  "SELECT * FROM employees";</pre></div></div><div class="section" title="postgres_rewrite"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec64"/>postgres_rewrite</h4></div></div></div><p>The <code class="literal">postgres_rewrite</code> directive<a id="id367" class="indexterm"/> should be used to send a specific response code when a condition is met. The condition can be <a id="id368" class="indexterm"/>one of the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">no_changes</code>: This is the condition when no rows are affected by the query</li><li class="listitem" style="list-style-type: disc"><code class="literal">changes</code>: This is the condition when at least one row is affected by the query</li><li class="listitem" style="list-style-type: disc"><code class="literal">no_rows</code>: This is the condition when no rows are returned in the result set</li><li class="listitem" style="list-style-type: disc"><code class="literal">rows</code>: This is the condition when at least one row is returned in the result set</li></ul></div><p>If you want to send the original response body to the client, prefix the code with <code class="literal">=</code> as shown in the following<a id="id369" class="indexterm"/> example configuration:</p><div class="informalexample"><pre class="programlisting">postgres_rewrite  no_rows =403;</pre></div></div><div class="section" title="postgres_output"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec65"/>postgres_output</h4></div></div></div><p>The <code class="literal">postgres_output</code> directive determines the output type of the response. The possible values are <code class="literal">rds</code>, <code class="literal">text</code>, <code class="literal">binary</code>, <code class="literal">value</code>, and <code class="literal">none</code>. The <code class="literal">none</code> value is used when you don't want any <a id="id370" class="indexterm"/>output. <code class="literal">value</code> is used when you want a single value as an output in the text format. All response<a id="id371" class="indexterm"/> types set the appropriate HTTP header.</p></div><div class="section" title="postgres_set"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec66"/>postgres_set</h4></div></div></div><p>The <code class="literal">postgres_set</code> directive is<a id="id372" class="indexterm"/> used to set a variable from a single value from the result set. You can specify the row and column to pick the value from. <a id="id373" class="indexterm"/>An example <a id="id374" class="indexterm"/>configuration is as follows:</p><div class="informalexample"><pre class="programlisting">postgres_set $empname 00 required</pre></div><p>If you set this directive to <code class="literal">required</code>, the module will generate a <code class="literal">500 internal server</code> error if the value to be set is null or out of range.</p></div><div class="section" title="postgres_escape"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec67"/>postgres_escape</h4></div></div></div><p>The <code class="literal">postgres_escape</code> directive <a id="id375" class="indexterm"/>will escape, quote a value in the <code class="literal">$unquoted</code> variable, and store the result in the <code class="literal">$escaped</code> <a id="id376" class="indexterm"/>variable, which can be safely used in SQL queries. An example configuration is given as follows:</p><div class="informalexample"><pre class="programlisting">postgres_escape   $user $remote_user;
postgres_escape   $pass $remote_passwd;</pre></div></div><div class="section" title="postgres_connect_timeout"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec68"/>postgres_connect_timeout</h4></div></div></div><p>The <code class="literal">postgres_connect_timeout</code> directive <a id="id377" class="indexterm"/>sets a timeout <a id="id378" class="indexterm"/>value for connecting to the database.</p></div><div class="section" title="postgres_result_timeout"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec69"/>postgres_result_timeout</h4></div></div></div><p>The <code class="literal">postgres_result_timeout</code> directive<a id="id379" class="indexterm"/> sets a <a id="id380" class="indexterm"/>timeout value for receiving results from the database.</p></div></div></div><div class="section" title="Communicating with MySQL and drizzle (drizzle-nginx)"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec33"/>Communicating with MySQL and drizzle (drizzle-nginx)</h2></div></div></div><p>The <code class="literal">drizzle-nginx</code> module is <a id="id381" class="indexterm"/>an upstream module to communicate with a MySQL or drizzle server. Drizzle is a fork of MySQL, which is optimized for multicore processing and scalability. This module essentially integrates <a id="id382" class="indexterm"/>
<code class="literal">libdrizzle</code> into an Nginx module. Like the Nginx PostgreSQL module, this module does not create human-readable text output, but rather <a id="id383" class="indexterm"/>a Resty DB format, <a id="id384" class="indexterm"/>which is a custom binary format.</p><p>You can download the source code for this module from the GitHub repository at <a class="ulink" href="https://github.com/chaoslawful/drizzle-nginx-module">https://github.com/chaoslawful/drizzle-nginx-module</a>. Please note that you will need to install drizzle and libdrizzle in order to be able to successfully compile this module. You can download drizzle from launchpad at <a class="ulink" href="https://launchpad.net/drizzle">https://launchpad.net/drizzle</a>.</p><p>This module is useful if you want<a id="id385" class="indexterm"/> to directly connect Nginx with a MySQL database. There can be several use-cases of why you would want to do that. You might want to serve pages by directly <a id="id386" class="indexterm"/>querying results from a table. You might also want to log things in a database or check certain<a id="id387" class="indexterm"/> conditions by querying a database table. Or else, you might want to authenticate a user from an upstream MySQL database. For all such situations and more, this module will be useful.</p><div class="section" title="Explaining directives"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec48"/>Explaining directives</h3></div></div></div><p>The most important directives <a id="id388" class="indexterm"/>from the <code class="literal">drizzle-nginx</code> module are as follows:</p><div class="section" title="drizzle_server"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec70"/>drizzle_server</h4></div></div></div><p>We use the <code class="literal">drizzle_server</code> directive to specify the drizzle server's name in the form of an IP address or a domain name,<a id="id389" class="indexterm"/> and optionally a port. The default port number is <code class="literal">3306</code>. You can also specify a username and a password. The following <a id="id390" class="indexterm"/>options are supported by this directive:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">user=</code>: This option defines the database username for login</li><li class="listitem" style="list-style-type: disc"><code class="literal">password=</code>: This option defines the database password, optionally enclosed in quotes, for special characters as shown in the following example configuration:<div class="informalexample"><pre class="programlisting">drizzle_server 127.0.0.1:3306 user=user "password=1 2 3"
        dbname=mysql protocol=mysql;</pre></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">dbname=</code>: This option defines the database to be used for the default connection</li><li class="listitem" style="list-style-type: disc"><code class="literal">protocol=</code>: This option<a id="id391" class="indexterm"/> defines the target database type, <code class="literal">drizzle</code>, or <code class="literal">mysql</code> (the default value is <code class="literal">drizzle</code>)</li><li class="listitem" style="list-style-type: disc"><code class="literal">charset=</code>: This option is used<a id="id392" class="indexterm"/> to explicitly specify the character set for the MySQL connections as shown in the following example configuration:<div class="informalexample"><pre class="programlisting">drizzle_server localhost:3306 user=mysqluser password=passwd
                                  dbname=mydb charset=utf8;</pre></div></li></ul></div></div><div class="section" title="drizzle_keepalive"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec71"/>drizzle_keepalive</h4></div></div></div><p>The <code class="literal">drizzle_keepalive</code> directive is used to maintain a <code class="literal">keepalive</code> pool for the target database. The following options <a id="id393" class="indexterm"/>are supported by this directive:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">max=</code>: This option is set to <code class="literal">0</code> by default, which means that the <code class="literal">keepalive</code> connection pooling is disabled. <a id="id394" class="indexterm"/>In order to enable it, you must set this value to a value greater than 0.</li><li class="listitem" style="list-style-type: disc"><code class="literal">mode=</code>: The possible values for this parameter are <code class="literal">multi</code> and <code class="literal">single</code>. The <code class="literal">single</code> mode means that the connection pool will not differentiate between multiple <code class="literal">drizzle_server</code> definitions in the current block, and the pool will apply to all of them, that is, you have one pool for all the <code class="literal">drizzle_server</code> definitions. In the <code class="literal">multi</code> mode, the pool will re-use connections that have identical server host names and ports. The default value is <code class="literal">single</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">overflow=</code>: This option specifies what to do when the connection pool is already full while a new database connection is required. Either <code class="literal">reject</code> or <code class="literal">ignore</code> can be specified. In case of <code class="literal">reject</code>, it will reject the current request and return the <span class="strong"><strong>503 Service Unavailable</strong></span> error page. For <code class="literal">ignore</code>, this module will create a new database connection.</li></ul></div></div><div class="section" title="drizzle_query"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec72"/>drizzle_query</h4></div></div></div><p>The <code class="literal">drizzle_query</code> directive<a id="id395" class="indexterm"/> defines the SQL query to <a id="id396" class="indexterm"/>be run on the database's backend.</p><p>You are allowed to use Nginx<a id="id397" class="indexterm"/> variables in place of queries, but you must be careful with SQL injection attacks. You are, therefore, advised to properly sanitize and quote your SQL queries. An example configuration is as follows:</p><div class="informalexample"><pre class="programlisting">location /employees {
    set_unescape_uri $name $arg_name;
    set_quote_sql_str $quoted_name $name;

    drizzle_query "select * from empl where name = $quoted_name";
    drizzle_pass my_backend;
}</pre></div></div><div class="section" title="drizzle_pass"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec73"/>drizzle_pass</h4></div></div></div><p>Using the <code class="literal">drizzle_pass</code> directive,<a id="id398" class="indexterm"/> you can pass the current location to another defined MySQL or drizzle-upstream block.</p><p>You can use the <a id="id399" class="indexterm"/>Nginx variables<a id="id400" class="indexterm"/> as values to perform dynamic passing. <a id="id401" class="indexterm"/>An example configuration is as follows:</p><div class="informalexample"><pre class="programlisting">upstream backend { localhost:3306 dbname=mydb; }

server {
    location /emp {
        set $srv backend;

        drizzle_query ...;
        drizzle_pass $srv;
    }
 }</pre></div></div><div class="section" title="drizzle_connect_timeout"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec74"/>drizzle_connect_timeout</h4></div></div></div><p>The <code class="literal">drizzle_connect_timeout</code> directive specifies the timeout value for connecting to the remote server. The value can <a id="id402" class="indexterm"/>be an integer with an optional time unit, such as s (second), ms (millisecond), or m (minute). The <a id="id403" class="indexterm"/>default time unit is s and the default value is <code class="literal">60 s</code>.</p></div><div class="section" title="drizzle_send_query_timeout"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec75"/>drizzle_send_query_timeout</h4></div></div></div><p>The <code class="literal">drizzle_send_query_timeout</code> directive specifies the timeout value for sending a SQL query to a remote server. The <a id="id404" class="indexterm"/>value can be an integer with an optional time unit, such as s (second), ms (millisecond), <a id="id405" class="indexterm"/>or m (minute). The default time unit is s and the default value is <code class="literal">60 s</code>.</p></div><div class="section" title="drizzle_recv_cols_timeout"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec76"/>drizzle_recv_cols_timeout</h4></div></div></div><p>The <code class="literal">drizzle_recv_cols_timeout</code> directive <a id="id406" class="indexterm"/>specifies the timeout <a id="id407" class="indexterm"/>value for receiving the columns' metadata of the result set to a remote server. The value can be<a id="id408" class="indexterm"/> an integer with an optional time unit, such as s (second), ms (millisecond), or m (minute). The default time unit is s and the default value is <code class="literal">60 s</code>.</p></div><div class="section" title="drizzle_recv_rows_timeout"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec77"/>drizzle_recv_rows_timeout</h4></div></div></div><p>The <code class="literal">drizzle_recv_rows_timeout</code> directive specifies the timeout value for receiving the rows' data of the result set (if any) to a<a id="id409" class="indexterm"/> remote server. The value can be an integer with an optional time unit, such as s (second), ms<a id="id410" class="indexterm"/> (millisecond), or m (minute). The default time unit is <code class="literal">s</code> and the default value is <code class="literal">60 s</code>.</p></div><div class="section" title="drizzle_buffer_size"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec78"/>drizzle_buffer_size</h4></div></div></div><p>The <code class="literal">drizzle_buffer_size</code><a id="id411" class="indexterm"/> directive specifies the buffer size for server outputs. The default value of this directive depends on the OS page size which would be 4K/8K normally. Larger buffer sizes can result in<a id="id412" class="indexterm"/> lower network overheads. However, you have to find the<a id="id413" class="indexterm"/> correct value for your workload by experimenting with this number.</p></div><div class="section" title="drizzle_module_header"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec79"/>drizzle_module_header</h4></div></div></div><p>The <code class="literal">drizzle_module_header</code> directive<a id="id414" class="indexterm"/> controls whether to output the drizzle header in the response or not. By default, the sending <a id="id415" class="indexterm"/>of the header is enabled. This directive can be configured with the following script:</p><div class="informalexample"><pre class="programlisting">X-Resty-DBD-Module: ngx_drizzle 0.1.0</pre></div></div></div></div><div class="section" title="Digest Authentication (ngx_http_auth_digest)"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec34"/>Digest Authentication (ngx_http_auth_digest)</h2></div></div></div><p>In today's world, HTTP basic authentication is too basic and doesn't provide adequate security required by the modern web servers. The reason is that usernames and passwords are sent in clear text unless you use HTTPS. The <code class="literal">ngx_http_auth_digest</code> module can be used to protect your resources using the HTTP Digest Authentication based on RFC 2617.</p><p>The digest authentication module <a id="id416" class="indexterm"/>works, and is considered quite stable. However, it is perhaps not tested enough for the real world, <a id="id417" class="indexterm"/>so make sure it works in your situation. As this module deals with security, it is always a good idea to test the software thoroughly.</p><p>You can download the source code at <a class="ulink" href="https://github.com/samizdatco/nginx-http-auth-digest">https://github.com/samizdatco/nginx-http-auth-digest</a>.</p><p>You can password-protect a directory tree by adding the following code lines into a server section in your Nginx configuration file:</p><div class="informalexample"><pre class="programlisting">auth_digest_user_file /opt/passwd.digest;
location /members{
  auth_digest 'members area; # set the realm for this location block
}</pre></div><p>Currently, the digest<a id="id418" class="indexterm"/> authentication module works with a file generated through the <code class="literal">htdigest</code> script. The <code class="literal">htdigest</code> script can be found in your Apache installation or source code. There is also an <code class="literal">htdigest.py</code> script in this module's source code, which will help you generate a compatible file.</p><div class="section" title="Explaining directives"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec49"/>Explaining directives</h3></div></div></div><p>Some of the most important <a id="id419" class="indexterm"/>directives of <code class="literal">ngx_http_auth_digest</code> are as follows:</p><div class="section" title="auth_digest"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec80"/>auth_digest</h4></div></div></div><p>The <code class="literal">auth_digest</code> directive can be<a id="id420" class="indexterm"/> defined in the contexts of the server and location. This parameter defines the realm<a id="id421" class="indexterm"/> name for authentication. This name should match the name used in creating the <code class="literal">htdigest</code> file. To selectively disable authentication, set <code class="literal">auth_digest</code> to <code class="literal">off</code>. The default value for this directive is <code class="literal">off</code>.</p></div><div class="section" title="auth_digest_user_file"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec81"/>auth_digest_user_file</h4></div></div></div><p>The <code class="literal">auth_digest_user_file</code> directive<a id="id422" class="indexterm"/> can be defined in the contexts of the server and location. This directive is used to specify<a id="id423" class="indexterm"/> the name of the password file. The password file should be created by the Apache htdigest command (or the included <code class="literal">htdigest.py</code> script).</p></div><div class="section" title="auth_digest_timeout"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec82"/>auth_digest_timeout</h4></div></div></div><p>The <code class="literal">auth_digest_timeout</code> directive can be defined in the contexts of the server and location. This timeout value defines the expiry <a id="id424" class="indexterm"/>time of the challenge sent to the client. If the user does not provide the response within this time, the challenge is considered stale, and a new challenge is sent to the client when <a id="id425" class="indexterm"/>a resource is requested again or the response comes from the client. The default timeout value is <code class="literal">60 s</code>.</p></div><div class="section" title="auth_digest_expires"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec83"/>auth_digest_expires</h4></div></div></div><p>The <code class="literal">auth_digest_expires</code> directive <a id="id426" class="indexterm"/>can be defined<a id="id427" class="indexterm"/> in the contexts of the server and location. This parameter is used to define the expiry time of the nonce value. Once a client<a id="id428" class="indexterm"/> successfully authenticates, the nonce value is cached and subsequent requests use the cached value. This parameter defines the duration<a id="id429" class="indexterm"/> for which a client can continue to use the nonce value. The default digest expiry value is <code class="literal">10 s</code>.</p></div><div class="section" title="auth_digest_replays"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec84"/>auth_digest_replays</h4></div></div></div><p>The <code class="literal">auth_digest_replays</code> directive can be defined in the contexts of the server and location. The validity of a cached nonce can also be specified in terms of the number of requests instead of time, by<a id="id430" class="indexterm"/> using this directive. Having a high <a id="id431" class="indexterm"/>value will increase your shared memory requirements. The default value is 20 replays per nonce.</p></div><div class="section" title="auth_digest_shm_size"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec85"/>auth_digest_shm_size</h4></div></div></div><p>The <code class="literal">auth_digest_shm_size</code> directive can only be defined in the server's context. This directive specifies the fixed size memory cache used to store information about the active authenticated requests. Once this cache<a id="id432" class="indexterm"/> is full, no further authentication will be possible until the active sessions expire. The default size is about 4 MB. The default value allows around 82,000 non-replay requests every 70 seconds.</p><p>An example configuration is as follows:</p><div class="informalexample"><pre class="programlisting">auth_digest_user_file /opt/htdigest;
auth_digest_shm_size 4m;   # the storage space allocated for tracking active sessions

location /restricted {
  auth_digest 'this is a restricted location';
  auth_digest_timeout 60s;
  auth_digest_expires 10s;
  auth_digest_replays 20;
}

location / {
  auth_digest 'restricted';
  location /img {
    auth_digest off; # this location will be accessible  }
}</pre></div></div></div></div><div class="section" title="Speeding up web pages (ngx_pagespeed)"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec35"/>Speeding up web pages (ngx_pagespeed)</h2></div></div></div><p>The <code class="literal">ngx_pagespeed</code> module optimizes the web pages and associated resources to reduce latency and bandwidth. It is capable of rewriting HTML pages and automatically eliminates deficiencies that reduce the performance of your website or web pages. This module is written by <a id="id433" class="indexterm"/>Google and is similar to Apache's <code class="literal">mod_pagespeed</code> module.</p><p>This module reduces the page's load time by automatically applying web performance best practices to pages and associated assets (CSS, JavaScript, and images). It can perform the following types of <a id="id434" class="indexterm"/>optimizations:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Image optimization</li><li class="listitem" style="list-style-type: disc">CSS and JavaScript optimization</li><li class="listitem" style="list-style-type: disc">Resource inlining</li><li class="listitem" style="list-style-type: disc">HTML rewriting</li><li class="listitem" style="list-style-type: disc">Cache lifetime extension</li></ul></div><p>In order to enable the module, you have to put p<code class="literal">agespeed On</code> in the server or the HTTP block. In addition, <a id="id435" class="indexterm"/>you should define the <code class="literal">FileCache</code> location and specify which rewrite filters you would like to enable. The following is an example configuration:</p><div class="informalexample"><pre class="programlisting">http {
  pagespeed On;
  pagespeed FileCachePath "/var/cache/ngx_pagespeed/";
  pagespeed EnableFilters combine_css,combine_javascript, add_instrumentation;
  ...
  ...
}</pre></div><p>The <code class="literal">FileCachePath</code> parameter provides the location where rewritten files are cached, and should be a valid path. The <code class="literal">EnableFilters</code> parameter defines which optimizations will be enabled for the specific location.</p><div class="section" title="Configuring handlers"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec50"/>Configuring handlers</h3></div></div></div><p>When the <code class="literal">ngx_pagespeed</code> module is configured<a id="id436" class="indexterm"/> and enabled, a default handler is automatically created, but there are additional handlers in order to monitor the module's activity in more details, which are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Statistics handler</strong></span>: This handler <a id="id437" class="indexterm"/>shows the statistics related to page or resource optimizations, including which pages have been optimized so far, as well as various latency and cache-effectiveness metrics. You can also view the summary of the current configuration that is active at the moment.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Messages handler</strong></span>: If you have enabled and specified a size for the <code class="literal">MessageBufferSize</code> parameter,<a id="id438" class="indexterm"/> this handler will contain a server-wide history of recent logging output from <code class="literal">pagespeed</code>, including messages that are omitted from the server's logfile based on its log level.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Console handler</strong></span>: This handler<a id="id439" class="indexterm"/> shows graphs of issue metrics over time.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Beacon handler</strong></span>: This handler can be used by the <code class="literal">add_instrumentation</code> filter to report the loading time of<a id="id440" class="indexterm"/> pages for your sites, which you can then view via the statistics page.</li></ul></div><p>The following is an example configuration from the module's documentation page:</p><div class="informalexample"><pre class="programlisting">pagespeed on;

# Needs to exist and be writable by nginx.
pagespeed FileCachePath /var/ngx_pagespeed_cache;

# Ensure requests for pagespeed optimized resources go to the pagespeed handler
# and no extraneous headers get set.
location ~ "\.pagespeed\.([a-z]\.)?[a-z]{2}\.[^.]{10}\.[^.]+" {
  add_header "" "";
}
location ~ "^/ngx_pagespeed_static/" { }
location ~ "^/ngx_pagespeed_beacon$" { }
location /ngx_pagespeed_statistics { allow 127.0.0.1; deny all; }
# Recent log messages. Like statistics, these are generally not to be shown to the public, so this has access controls as well.
pagespeed MessageBufferSize 100000;
location /ngx_pagespeed_message { allow 127.0.0.1; deny all; }</pre></div><p>In order to check if the module is processing your pages or not, you can check the source of a page, which you should be able to see at the <code class="literal">X-Page-Speed</code> header through the following code lines:</p><div class="informalexample"><pre class="programlisting">$ curl -I 'http://localhost /index.html/'  |  grep X-Page-Speed
X-Page-Speed: 1.6.29.5-...</pre></div><p>You can find a complete list of <a id="id441" class="indexterm"/>pagespeed filters in the online documentation available at <a class="ulink" href="https://developers.google.com/speed/pagespeed/module/using">https://developers.google.com/speed/pagespeed/module/using</a>.</p></div></div><div class="section" title="Lua scripting (ngx_lua)"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec36"/>Lua scripting (ngx_lua)</h2></div></div></div><p>If you want the ability to write scripts in your Nginx configuration file, then utilizing the power of Lua by using the <code class="literal">ngx_lua</code> module can be a great move. This is a very powerful module with<a id="id442" class="indexterm"/> a large number of uses, and provides you with a full programming capability inside the Nginx configuration. It has the following advantages and features:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">This will allow you<a id="id443" class="indexterm"/> to perform complicated processing on the incoming request before it's executed, or change the response afterwards</li><li class="listitem" style="list-style-type: disc">You can add new headers or remove the existing ones</li><li class="listitem" style="list-style-type: disc">You can perform redirects and routing based on complicated program-like logic</li><li class="listitem" style="list-style-type: disc">You can create a sophisticated logging framework entirely based on Lua scripts</li><li class="listitem" style="list-style-type: disc">You can either block or allow IP addresses</li><li class="listitem" style="list-style-type: disc">You can build your own authentication or preprocessing layer on top, without having to write your own C modules and recompiling the Nginx code</li></ul></div><p>Lua is a lightweight, embeddable scripting language, which makes it very suitable for scripting in the configuration file.</p><p>This module allows you to run the Lua code during different phases in the Nginx request handling. Before we look at more details of Lua scripting, it is worth looking at the different phases of Nginx request handling.</p><p>Each request handled by Nginx goes <a id="id444" class="indexterm"/>through the following phases:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Sl. No.</p>
</th><th style="text-align: left" valign="bottom">
<p>Nginx request-handling phase</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>1</p>
</td><td style="text-align: left" valign="top">
<p>server selection<a id="id445" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>A server block is selected based on the request.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>2</p>
</td><td style="text-align: left" valign="top">
<p>post read<a id="id446" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>This phase is executed after a request is read. This allows you to perform actions on the request before it is processed. For example, <code class="literal">HttpRealIpModule</code> can use this phase to add IP addresses in the request headers.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>3</p>
</td><td style="text-align: left" valign="top">
<p>server rewrite<a id="id447" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>During this phase, URL rewriting can take place. You can select the configuration based on variable values. The <code class="literal">HttpRewrite</code> module allows you to do so.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>4</p>
</td><td style="text-align: left" valign="top">
<p>location selection<a id="id448" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>During this phase, a location configuration block is selected or matched based on the requested URL.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>5</p>
</td><td style="text-align: left" valign="top">
<p>location rewrite<a id="id449" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>This phase allows you to do rewrites within a selected location-configuration block.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>6</p>
</td><td style="text-align: left" valign="top">
<p>preaccess<a id="id450" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>This phase allows you to carry out certain filters, that is, limit the number of requests per session.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>7</p>
</td><td style="text-align: left" valign="top">
<p>access<a id="id451" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>This phase runs authentications, such as <code class="literal">auth_basic</code> or <code class="literal">auth_digest</code>. You can also allow or deny requests based on criteria, such as IP addresses.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>8</p>
</td><td style="text-align: left" valign="top">
<p>try files<a id="id452" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>The core module's <code class="literal">try_files</code> directive is executed in this phase.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>9</p>
</td><td style="text-align: left" valign="top">
<p>content<a id="id453" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>The actual content generation takes place in this phase. All upstream modules are executed in this phase.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>10</p>
</td><td style="text-align: left" valign="top">
<p>log<a id="id454" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>During this phase, information is logged in the logfiles. Modules such as <code class="literal">access_log</code> operate within this phase.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>11</p>
</td><td style="text-align: left" valign="top">
<p>post action<a id="id455" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>During this phase, the <code class="literal">post_action</code> directive of the core module is executed, which allows you to send subrequests to a location or upstream when a request is finished, for example, logging competed requests in a remote MySQL database.</p>
</td></tr></tbody></table></div><p>The <code class="literal">nginx_lua</code> module embeds Lua via the standard Lua interpreter or LuaJIT into Nginx. Please note that you need to<a id="id456" class="indexterm"/> install Lua or LuaJIT before you can use this module. This module also has a dependency on another Nginx module called <code class="literal">ngx_devel_kit</code>. It facilitates the development of new Nginx modules. We will have a detailed look at this module in this chapter as well as in <a class="link" href="ch05.html" title="Chapter 5. Creating Your Own Module">Chapter 5</a>, <span class="emphasis"><em>Creating Your Own Module</em></span>, where we will learn to write our own Nginx module.</p><p>Using the Lua API for Nginx, you can communicate with upstream servers in a non-blocking manner in your Lua script. The Lua VM is shared across all the requests handled by a single Nginx worker process to minimize memory usage.</p><p>It is possible to use a number of upstream Nginx modules with the <code class="literal">nginx_lua</code> module. These modules are <a id="id457" class="indexterm"/>as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">lua-resty-memcached</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">lua-resty-mysql</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">lua-resty-redis</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">lua-resty-dns</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">lua-resty-upload</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">ngx_memc</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">ngx_postgres</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">ngx_redis2</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">ngx_redis</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">ngx_proxy</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">ngx_fastcgi</code></li></ul></div><p>An example configuration of the <code class="literal">ngx_lua</code> module is as <a id="id458" class="indexterm"/>follows:</p><div class="informalexample"><pre class="programlisting">  # set search paths for pure Lua external libraries (';;' is the default path):
    lua_package_path '/home/user/?.lua;/scripts/?.lua;;';
 
    # set search paths for Lua external libraries written in C (can also use ';;'):
    lua_package_cpath '/bar/for/?.so;/blah/blah/?.so;;';
 
    server {
        location /inline_concat {
            # MIME type determined by default_type:
            default_type 'text/plain';
            set $a "hello";
            set $b "world";
            # inline Lua script
            set_by_lua $res "return ngx.arg[1]..ngx.arg[2]" $a $b;
            echo $res;
        }</pre></div><div class="section" title="Explaining directives"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec51"/>Explaining directives</h3></div></div></div><p>Some of the most important <a id="id459" class="indexterm"/>directives of <code class="literal">ngx_lua</code> are as follows:</p><div class="section" title="lua_package_path"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec86"/>lua_package_path</h4></div></div></div><p>The <code class="literal">lua_package_path</code> directive is used to specify the path of the Lua scripts. This value is used by the directives such as <code class="literal">set_by_lua</code> and <code class="literal">content_by_lua</code>.</p><p>You can use the special notation $prefix or ${prefix} in the search path string to indicate the path of the<a id="id460" class="indexterm"/> server prefix <a id="id461" class="indexterm"/>usually determined by the <code class="literal">-p PATH</code> command-line option while starting the Nginx server.</p><p>The default value is taken<a id="id462" class="indexterm"/> from the <code class="literal">LUA_PATH</code> environment variable. If this variable is not defined, then the default search path is used to locate Lua scripts.</p></div><div class="section" title="set_by_lua or set_by_lua_file"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec87"/>set_by_lua or set_by_lua_file</h4></div></div></div><p>The <code class="literal">set_by_lua</code> or <code class="literal">set_by_lua_file</code> directives are used to execute a small embedded and blocked Lua script provided as a string. This script can take two parameters as an input and return the result through a <code class="literal">return</code> variable. The Nginx event loop is blocked when this code <a id="id463" class="indexterm"/>gets executed. You<a id="id464" class="indexterm"/> should, therefore, not use this directive to execute long-running codes.</p><p>Note that the following API functions are currently <a id="id465" class="indexterm"/>disabled within this context. This directive can only write out a value to a single Nginx variable at a time, as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">location /testlua {
    set_by_lua $sum '
        local a = 32
        local b = 56
        return a + b;          -- return the $sum value normally
    ';

    echo "sum = $sum
}</pre></div><p>This directive can be freely mixed with all directives of the <code class="literal">HttpRewriteModule</code>, <code class="literal">HttpSetMiscModule</code>, and <code class="literal">HttpArrayVarModule</code> modules. All these directives will be executed in the same order as they appear in the configuration file. An example configuration is given as follows:</p><div class="informalexample"><pre class="programlisting">set $num 32;
set_by_lua $num2 'tonumber(ngx.var.num) + 1';</pre></div><p>You can freely use the <code class="literal">$</code> sign inside the Lua scripts provided in this directive as the Nginx variable interpolation is disabled. This directive requires the <code class="literal">ngx_devel_kit</code> module.</p><p>The <code class="literal">set_by_lua_file</code> directive is similar to the <code class="literal">set_by_lua</code> directive. The only difference is that the Lua script here is provided in a file. This file can also contain Lua or LuaJIT bytecode<a id="id466" class="indexterm"/> instead of a text script.</p><p>When a relative path <a id="id467" class="indexterm"/>such as <code class="literal">path/file.lua</code> is given, it will be turned into an absolute path relative to the server prefix path determined by the <code class="literal">-p PATH</code> command-line option while starting the Nginx server.</p><p>By default, the Lua <a id="id468" class="indexterm"/>code cache is turned on. This means that the script file is loaded the first time. If you make changes, Nginx configuration will be reloaded. If you are in a development cycle, the code cache can be turned off by using<a id="id469" class="indexterm"/> the <code class="literal">lua_code_cache_off</code> parameter in the configuration file. The following is an example configuration:</p><div class="informalexample"><pre class="programlisting">    location /rel_file_concat {
        set $a "foo";
        set $b "bar";
        # script path relative to nginx prefix
        # $ngx_prefix/conf/concat.lua contents:
        #
        #    return ngx.arg[1]..ngx.arg[2]
        #
        set_by_lua_file $res conf/concat.lua $a $b;
        echo $res;
    }</pre></div></div><div class="section" title="content_by_lua or content_by_lua_file"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec88"/>content_by_lua or content_by_lua_file</h4></div></div></div><p>The <code class="literal">content_by_lua</code> or <code class="literal">content_by_lua_file</code> directives are used to specify a Lua script to execute for every request<a id="id470" class="indexterm"/> during the content <a id="id471" class="indexterm"/>phase. You can use API calls in this script, and the script is<a id="id472" class="indexterm"/> executed in an independent global sandbox.</p><p>Since this directive is a <a id="id473" class="indexterm"/>content handler, do not use it and the other content handler directives at the same location. For example, this directive and the <code class="literal">proxy_pass</code> directive should not be used at the same location.</p><p>The <code class="literal">content_by_lua_file</code> directive is equivalent to <code class="literal">content_by_lua</code>, except that in this directive you have to provide the path to a Lua script file instead of writing inline codes. The code in this file is loaded only once if the code cache is turned on, and the relative paths are resolved to <a id="id474" class="indexterm"/>absolute paths using<a id="id475" class="indexterm"/> the server prefix. <a id="id476" class="indexterm"/>An example configuration is shown as follows:</p><div class="informalexample"><pre class="programlisting">    location /request_body {
         # force reading request body (default off)
         lua_need_request_body on;
         client_max_body_size 50k;
         client_body_buffer_size 50k;

         content_by_lua 'ngx.print(ngx.var.request_body)';
    }
    # transparent non-blocking I/O in Lua via subrequests
    location /lua {
        # MIME type determined by default_type:
        default_type 'text/plain';

        content_by_lua '
            local res = ngx.location.capture("/some_other_location")
            if res.status == 200 then
                ngx.print(res.body)
            end';
    }</pre></div></div><div class="section" title="rewrite_by_lua or rewrite_by_lua_file"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec89"/>rewrite_by_lua or rewrite_by_lua_file</h4></div></div></div><p>The <code class="literal">rewrite_by_lua</code> or <code class="literal">rewrite_by_lua_file</code> directive executes the Lua code during the rewrite phase. <a id="id477" class="indexterm"/>The Lua code can use API calls and is run in a spawned <a id="id478" class="indexterm"/>global sandbox.</p><p>Note that this handler always<a id="id479" class="indexterm"/> runs after the standard HTTP rewrite. So,<a id="id480" class="indexterm"/> the following piece of code will<a id="id481" class="indexterm"/> not work as expected:</p><div class="informalexample"><pre class="programlisting">  location /foo {
      set $a 5; # create and initialize $a
      set $b 13; # create and initialize $b
      rewrite_by_lua 'ngx.var.b = tonumber(ngx.var.a) + 1';
      if ($b = '6') {
         rewrite ^ /bar redirect;
         break;
      }
      echo "res = $b";
  }</pre></div><p>This is because the <code class="literal">if</code> condition runs before <code class="literal">rewrite_by_lua</code> even if it is placed after <code class="literal">rewrite_by_lua</code> in the configuration script.</p><p>The correct way of doing this by using Nginx API calls is as follows:</p><div class="informalexample"><pre class="programlisting">location /foo {
    set $a 5; # create and initialize $a
    set $b 13; # create and initialize $b
    rewrite_by_lua '
        ngx.var.b = tonumber(ngx.var.a) + 1
        if tonumber(ngx.var.b) == 6 then
            return ngx.redirect("/bar");
        end
    ';

    echo "res = $b";
}</pre></div><p>The <code class="literal">rewrite_by_lua</code> code <a id="id482" class="indexterm"/>will always run at the end of the rewrite-request-processing phase unless <code class="literal">rewrite_by_lua_no_postpone</code> is turned <code class="literal">on</code>.</p><p>The <code class="literal">rewrite_by_lua_file</code> <a id="id483" class="indexterm"/>directive also runs in the rewrite phase after the standard HTTP rewrite. However, the code is executed from a Lua script file or a bytecode file as <a id="id484" class="indexterm"/>shown in the following configuration script:</p><div class="informalexample"><pre class="programlisting">    location /script {
            content_by_lua_file /path/to/script/$1.lua;
    }</pre></div></div><div class="section" title="access_by_lua or access_by_lua_file"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec90"/>access_by_lua or access_by_lua_file</h4></div></div></div><p>The <code class="literal">access_by_lua</code> or <code class="literal">access_by_lua_file</code> directive executes the Lua code during the access phase. This means<a id="id485" class="indexterm"/> that the code in this directive will run once per request, and no subrequest will be able to trigger the code.</p><p>The Lua code is run <a id="id486" class="indexterm"/>after the standard <code class="literal">HttpAccessModule</code>. Therefore, if you have any blacklisted IPs, they will be denied before this code is executed.</p><p>You can use these directives to<a id="id487" class="indexterm"/> implement more complex access mechanisms, that is, the ones that communicate with upstream servers, such as a database.</p><p>Let us now have a look at a sample ngx_lua configuration to understand the usage of access_by_lua:</p><div class="informalexample"><pre class="programlisting">    
location / {
        access_by_lua '
            local ret = ngx.location.capture("/ldap_auth")
 
            if ret.status == ngx.HTTP_OK then
                return
            end
 
            if ret.status == ngx.HTTP_FORBIDDEN then
                ngx.exit(ret.status)
            end
 
            ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
        ';
    }
        access_by_lua '
               if ngx.var.remote_addr == "10.11.60.220" then
                   ngx.exit(ngx.HTTP_FORBIDDEN)
               end ';  </pre></div><p>In the preceding example configuration, the Lua code will run the configuration for a defined location called <code class="literal">ldap_auth</code>, <a id="id488" class="indexterm"/>which will authenticate the user against an LDAP server, and based on a return value, the request either exits with a proper error code (403) or returns normally.</p><p>The <code class="literal">access_by_lua</code> directive<a id="id489" class="indexterm"/> allows you to run a Lua script or<a id="id490" class="indexterm"/> bytecode using a file. You need to specify the path of the script file in the directive.</p><p>Nginx variables can be used in the file to provide flexibility. This, however, carries some risks, and is not ordinarily recommended.</p><p>Relative file paths are <a id="id491" class="indexterm"/>converted to absolute paths using the server prefix.</p><p>It is recommended that you turn on the code cache in the production environment, so that the Lua code is loaded only once. This can provide performance benefits. However, in a development environment, you should not enable the code cache in order to avoid reloading the server every time there is a code change.</p><p>The <code class="literal">ngx_lua</code> module provides complete scripting capabilities while offering very high performance levels. This is especially true if you use the Just In Time (<span class="strong"><strong>JIT</strong></span>)compilation using LuaJIT. This allows you a very wide range of use-cases where this module can be useful.</p></div></div></div><div class="section" title="Reverse IP lookup using the GeoIP module (ngx_http_geoip_module)"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec37"/>Reverse IP lookup using the GeoIP module (ngx_http_geoip_module)</h2></div></div></div><p>The <code class="literal">ngx_http_geoip_module</code> does a reverse lookup on the IP of the client using the MaxMind IP database. It resolves the IP address to the place of origin and sets a number for the variables.</p><p>This module is not built by<a id="id492" class="indexterm"/> default; it should be enabled with the <code class="literal">--with-http_geoip_module</code> configuration parameter. As already mentioned, this module has dependency on the MaxMind GeoIP library.</p><p>You need an account with <a id="id493" class="indexterm"/>MaxMind and will also need to download several database files that map IP addresses to countries, cities, and even organizations.</p><p>One of the key applications, in addition to providing you with more information about the clients, can also be against DDOS attacks. Using the information looked up by this module, you can block or allow traffic coming from countries, cities, regions, and so on. This is a bit crude, but it works. You can use this module as a complement to <code class="literal">HttpLimitReqModule</code> and <code class="literal">HttpLimitZoneModule</code>. An example configuration is as follows:</p><div class="informalexample"><pre class="programlisting">http {
    geoip_country         countries.dat;
    geoip_city            city.dat;
    geoip_org             org.dat
    geoip_proxy           10.220.136.0/24;
    geoip_proxy           2331:0fb9::/32;
    geoip_proxy_recursive on;
    ...</pre></div><div class="section" title="Explaining directives"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec52"/>Explaining directives</h3></div></div></div><p>The following is a list of <a id="id494" class="indexterm"/>directives you can use for configuring this module:</p><div class="section" title="geoip_country"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec91"/>geoip_country</h4></div></div></div><p>The <code class="literal">geoip_country</code> directive<a id="id495" class="indexterm"/> allows you to specify the name and path of the database file that contains the IP for a country's lookup information. The following variables are available (as well as set by this module) while using this database:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">$geoip_country_code</code>: This is a two-letter country code, for example, DE or US. These codes correspond to ISO 3166-1 alpha-2 standard.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$geoip_country_code3</code>: This is a three-letter country code, for example, DEU or USA. These codes correspond to ISO 3166-1 alpha-3 standard.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$geoip_country_name</code>: This <a id="id496" class="indexterm"/>gives the complete country name, for example, Russian Federation or United States.</li></ul></div></div><div class="section" title="geoip_city"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec92"/>geoip_city</h4></div></div></div><p>The <code class="literal">geoip_city</code> directive allows <a id="id497" class="indexterm"/>you to set the name<a id="id498" class="indexterm"/> and path of a database file to lookup the city's and region's information based on the client's IP address. The following variables are available and set as well while using this<a id="id499" class="indexterm"/> database:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">$geoip_area_code</code>: This gives the telephone area code (US only) associated with the client's IP address. This field in the MaxMind database has been depreciated, so you might not get any information or get outdated information.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$geoip_city_continent_code</code>: This is a two-letter continent code, for example, EU or AS.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$geoip_city_country_code</code>: This is a two-letter country code, for example, DE or US. These codes correspond to ISO 3166-1 alpha-2 standard.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$geoip_city_country_code3</code>: This is a three-letter country code, for example, DEU or USA. These codes correspond to ISO 3166-1 alpha-3 standard.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$geoip_city_country_name</code>: This gives the country name, for example, Russian Federation or United States.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$geoip_dma_code</code>: This gives the DMA region code in the US (also known as metro code), which can be found at <a class="ulink" href="https://developers.google.com/adwords/api/docs/appendix/cities-DMAregions">https://developers.google.com/adwords/api/docs/appendix/cities-DMAregions</a>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$geoip_latitude</code>: This gives the latitudinal value of the city.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$geoip_longitude</code>: This gives the longitudinal value of the city.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$geoip_region</code>: This is a two-symbol country region code (region, territory, state, province, federal land, and the like), for example, 48 or DC.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$geoip_region_name</code>: This gives the country's region name (region, territory, state, province, federal land, and the like), for example, Bavaria or District of Columbia.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$geoip_city</code>: This gives the full city name, for example, Munich or London.</li><li class="listitem" style="list-style-type: disc"><code class="literal">$geoip_postal_code</code>: This gives the postal code information if available.</li></ul></div></div><div class="section" title="geoip_org"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec93"/>geoip_org</h4></div></div></div><p>The <code class="literal">geoip_org</code> directive allows you to specify the name and path of the database file to resolve the IP address to<a id="id500" class="indexterm"/> an organization. This can be a company name or an institution. Normally, this kind of information is available through the <code class="literal">whois</code> databases. The following variable is available and set as well while using this option:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">$geoip_org</code>: This contains the organization's name, for example, Facebook, Inc.</li></ul></div></div><div class="section" title="geoip_proxy"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec94"/>geoip_proxy</h4></div></div></div><p>The <code class="literal">geoip_proxy</code> directive allows you to specify the IP addresses or CIDR of the proxy servers that you "trust". If the client IP address matches this trusted address, the IP address sent in the <a id="id501" class="indexterm"/>HTTP header <code class="literal">X-Forwarded-For</code> is used to do the IP lookup. The <code class="literal">X-Forwarded-For</code> header is a standard header that is sent by proxy servers to reveal the real IP address of the client. If the proxy server does not choose to do so, it is essentially an anonymizer. The correctness <a id="id502" class="indexterm"/>of the IP sent in this header is purely up to the proxy server; therefore, if you trust a specific proxy server to send correct information, you can use this directive to enable lookup on the IP address sent in the <code class="literal">X-Forwarded-For</code> header.</p></div><div class="section" title="geoip_proxy_recursive"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec95"/>geoip_proxy_recursive</h4></div></div></div><p>The <code class="literal">geoip_proxy_recursive</code> directive<a id="id503" class="indexterm"/> allows you to enable recursive IP lookup. If recursive lookup is enabled, the last untrusted address sent in the <code class="literal">X-Forwarded-For</code> header will be used for the IP lookup.</p><p>If Nginx is working behind <a id="id504" class="indexterm"/>a proxy, you can also use <code class="literal">HttpRealIpModule</code>. This module allows you to change the client's IP address to a value from the request header (for example, <code class="literal">X-Real-IP</code> or <code class="literal">X-Forwarded-For</code>).</p></div></div></div><div class="section" title="Doing healthchecks"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec38"/>Doing healthchecks</h2></div></div></div><p>Here we will learn about various modules to keep a track of the healthy upstreams.</p><div class="section" title="ngx_http_healthcheck_module"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec53"/>ngx_http_healthcheck_module</h3></div></div></div><p>If your Nginx server <a id="id505" class="indexterm"/>works with a lot of upstream servers for providing various services and content, keeping track of which upstream <a id="id506" class="indexterm"/>servers are still healthy and working is very important, especially if they are third-party or external servers. This module allows you to keep track of healthy backends.</p><p>This is how it works. When an upstream server responds with a 200+ status code, and the response optionally comes back with a body, it is marked as good; otherwise, it is marked as bad. This module also<a id="id507" class="indexterm"/> has an HTTP healthcheck page where you can see the current status of the backends. This is quite similar to the <code class="literal">haproxy</code> or <code class="literal">varnish</code> healthchecks.</p><p>This module inserts<a id="id508" class="indexterm"/> a healthcheck event into Nginx's event tree. When that triggers, it starts a peer connection with the backend and sends as well as receives data. When the heathcheck is over or gets timed out, it updates the health of the backend in a shared memory area. The following<a id="id509" class="indexterm"/> is an example configuration:</p><div class="informalexample"><pre class="programlisting">http {

  upstream check_upstreams {
    server server1.com;
    server server2.com;
    healthcheck_enabled;
    healthcheck_delay 1000;
    healthcheck_timeout 1000;
    healthcheck_failcount 1;
    healthcheck_expected 'BACKEND_ALIVE';
    healthcheck_send "GET /health HTTP/1.0" 'Host: www.websitename.com';
 }
...
 location /health_status {
      healthcheck_status;
 }
...
}</pre></div></div><div class="section" title="Explaining directives"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec54"/>Explaining directives</h3></div></div></div><p>Some of the most<a id="id510" class="indexterm"/> important directives of the <code class="literal">ngx_http_healthcheck_module</code> are as follows:</p><div class="section" title="healthcheck_enabled"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec96"/>healthcheck_enabled</h4></div></div></div><p>The <code class="literal">healthcheck_enabled</code> module's <a id="id511" class="indexterm"/>context is upstream and <a id="id512" class="indexterm"/>enables health checking on the upstream servers defined in the specific upstream block. This, in the preceding example, would be <code class="literal">server1</code> and <code class="literal">server2</code>.</p></div><div class="section" title="healthcheck_delay"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec97"/>healthcheck_delay</h4></div></div></div><p>For each upstream server, the <a id="id513" class="indexterm"/>
<code class="literal">healthcheck_delay</code> directive defines the delay between two healthchecks. The default value is <code class="literal">1000 ms</code>.</p></div><div class="section" title="healthcheck_timeout"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec98"/>healthcheck_timeout</h4></div></div></div><p>The <code class="literal">healthcheck_timeout</code> directive <a id="id514" class="indexterm"/>defines the timeout value for the healthcheck operation. If the healthcheck operation is taking too long because the backend is slow in responding, the process will stop after the timeout has elapsed. The default value is <code class="literal">2000 ms</code>.</p></div><div class="section" title="healthcheck_failcount"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec99"/>healthcheck_failcount</h4></div></div></div><p>The <code class="literal">healthcheck_failcount</code> directive<a id="id515" class="indexterm"/> gives the number of good or bad healthchecks in a row it takes<a id="id516" class="indexterm"/> to switch<a id="id517" class="indexterm"/> the current health status (good to bad or bad to good). The default value is <code class="literal">2</code>.</p></div><div class="section" title="healthcheck_send"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec100"/>healthcheck_send</h4></div></div></div><p>The <code class="literal">healthcheck_send</code> directive<a id="id518" class="indexterm"/> is a required directive that allows you to decide what to send to do a healthcheck. This can be a simple HTTP <code class="literal">GET</code> command or something more complex. Each argument is appended by <code class="literal">\r\n</code> and the entire block is suffixed with another <code class="literal">\r\n</code>. The following is an<a id="id519" class="indexterm"/> example configuration:</p><div class="informalexample"><pre class="programlisting">  healthcheck_send 'GET /health HTTP/1.0'
   'Host: www.yourhost.com';</pre></div><p>Note that you probably want to end your healthcheck with some directive that closes the connection, for example, <code class="literal">Connection: close</code>.</p></div><div class="section" title="healthcheck_expected"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec101"/>healthcheck_expected</h4></div></div></div><p>The <code class="literal">healthcheck_expected</code> directive allows you to specify what to expect in return from the upstream server as a response to mark it as healthy. Any other response or no response will mark the host as down. <a id="id520" class="indexterm"/>This refers to the response in the HTTP body and not the headers. If this directive is missing, a simple response code of 200 will be enough.</p></div><div class="section" title="healthcheck_buffer"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec102"/>healthcheck_buffer</h4></div></div></div><p>The <code class="literal">healthcheck_buffer</code> directive<a id="id521" class="indexterm"/> gives the size of the buffer where the response from the backend will be temporarily stored for checking. Make sure you allocate enough memory not only for the body but also for the headers that you expect to receive back in response.</p></div></div><div class="section" title="Load balancing"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec55"/>Load balancing</h3></div></div></div><p>There are a number of third-party Nginx modules available, which allow you to distribute load among upstream servers <a id="id522" class="indexterm"/>based on a hashing mechanism or on a least-busy basis. There are various hashing mechanisms available for load balancing, some of which are available via third-party modules. Here, we will just take a brief look at some of the options available to you.</p><div class="section" title="Consistent hashing"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec103"/>Consistent hashing</h4></div></div></div><p>The <code class="literal">ngx_http_upstream_consistent_hash</code> module<a id="id523" class="indexterm"/> allows you to load balance using a consistent hash ring. Consistent hashing is a special hashing algorithm that is quite good when you have to rehash frequently because a new machine or server is added or removed from the pool.</p><p>This module is <a id="id524" class="indexterm"/>compatible with the <a id="id525" class="indexterm"/>
<code class="literal">php-memcached</code> module, and you can store values in the <code class="literal">memcached</code> cluster that this module can read from. You can find more details about this module at <a class="ulink" href="http://wiki.nginx.org/HttpUpstreamConsistentHash">http://wiki.nginx.org/HttpUpstreamConsistentHash</a>.</p><p>There is another similar module that uses the Ketama consistent hashing library to compute a hash on a configuration variable, that is, Request URI. Check out more information about this at <a class="ulink" href="http://wiki.nginx.org/HttpUpstreamKetamaCHashModule">http://wiki.nginx.org/HttpUpstreamKetamaCHashModule</a>.</p></div><div class="section" title="Least busy"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec104"/>Least busy</h4></div></div></div><p>The <code class="literal">ngx_http_upstream_fair_module</code> module <a id="id526" class="indexterm"/>allows you to do load balancing based on which upstream is least busy.</p><p>This module also provides a status page where you can view the current status of load balancing.</p><p>This module uses <a id="id527" class="indexterm"/>
<span class="strong"><strong>Weighted Least-Connection Round Robin</strong></span> (<span class="strong"><strong>WLC-RR</strong></span>) with a number of possible variations. More information on this module is available at <a class="ulink" href="http://wiki.nginx.org/HttpUpstreamFairModule">http://wiki.nginx.org/HttpUpstreamFairModule</a>.</p></div><div class="section" title="Configuration variable hashing"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl4sec105"/>Configuration variable hashing</h4></div></div></div><p>Configuration variable hashing is <a id="id528" class="indexterm"/>probably the most random hashing you can do. You can choose to do a hash on one of the available variables, that is, <code class="literal">$request_uri</code> or HTTP headers or a combination of both. This module uses CRC-32 to compute the hash on a specified variable.</p><p>More information on this is available at <a class="ulink" href="http://wiki.nginx.org/HttpUpstreamRequestHashModule">http://wiki.nginx.org/HttpUpstreamRequestHashModule</a>.</p></div></div></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec17"/>Summary</h1></div></div></div><p>In this chapter, we looked at various useful third-party Nginx modules that are not distributed with the source code by default. There are many more useful modules available that you can find on GitHub. Please do pay attention to the fact that the module is stable enough to be used in the production environment. Always do some testing first and then carefully move the modules in the production environments. The Nginx community will take no responsibility for any problems that you may encounter as a result of using these modules.</p><p>In the next chapter, we will discuss developing our own Nginx module, which will be the first step into the world of custom module development.</p></div></body></html>