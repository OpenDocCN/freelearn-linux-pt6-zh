# 前言

你将学习如何在老板因为某些页面无法加载而联系你之前，先记录问题。你将学习如何通过日志和你常用的 Linux 工具箱来找到这些问题。你还将学习如何最大程度地减少问题再次发生的概率。

Nginx 最初作为一个 Web 加速反向代理，诞生于 2000 年代初期的一家大型俄罗斯互联网公司。主要的 Web 服务器软件是 Apache 1.3，它开始在处理成千上万的相对慢速客户端时暴露出架构问题，这个问题在使用基于旧的进程模型时尤为明显。聪明的 Web 工程师们已经开始构建基于`mod_proxy` Apache 模块的二层系统，甚至在反向代理模式下使用 squid 缓存代理。

Nginx 的早期前身名为`mod_accel`，它也作为一个 Apache 模块实现。`mod_accel`模块在一些繁忙网站的管理员中获得了一些人气，但与 Nginx 后来获得的地位相比简直微不足道。两者都建立在这样的思想上：在一个繁忙网站的服务器端增加额外的代理层是件好事，它既能提供额外的灵活性，又能将服务慢速客户端的任务与实际的响应生成分离开来。

Nginx 将 `mod_proxy` 模块的理念推向极致，成为一个自给自足的独立 HTTP 服务器，旨在解决所谓的 C10K 问题，即处理 10,000 个并发连接。2016 年，这个数字看起来并不令人印象深刻，但在 2007 年，当 Nginx 首次宣称占据了 1%的 Web 市场份额时，这个数字却非常引人注目，Netcraft 的数据支持了这一点。

自那时以来，Nginx 的市场份额增长了数倍，同时 Nginx 稳步增加了新功能，依然是理想的开源成功故事项目，唯一的天才开发者将他的才华献给了开发免费优质的软件，整个互联网都能从中受益。

2011 年，一家名为 Nginx, Inc. 的商业公司成立，这为开发者（如今是一个团队）提供了更多的自由。该公司不仅提供支持服务，还提供名为 Nginx Plus 的软件特别订阅版。我们将在第六章提到一些 Nginx Plus 的功能。

到了 2016 年，Nginx 已成为许多企业的基础工具。然而，它仍然只是一个需要高手才能展现其全部潜力的工具。如果你想了解你的网页服务器发生了什么，能够编写正确的 Nginx 配置文件并读取 Nginx 日志，并且希望你的网页服务器运行得非常快，你必须成为那个高手。

# 本书内容

第一章，*搜索 Nginx 配置中的问题*，简要描述了 Nginx 配置语言，并展示了一些特殊情况和几种搜索问题的技巧。

第二章, *在日志文件中寻找问题*，介绍了日志子系统、日志语法以及在故障排除时需要查找的内容。Nginx 提供了它所执行的所有操作的详细日志。

第三章, *故障排除功能问题*，是本书的核心章节，列出了在调查问题时需要采取的步骤。你将了解人们在使用 Nginx 服务器时常遇到的各种问题。

第四章, *优化网站性能*，专门讨论与性能相关的所有内容。从详细解释 Nginx 事件驱动处理模型的基本原理开始，它还涉及缓存，并提供了关于可能的上游优化的一些建议。

第五章, *故障排除罕见的特定问题*，专门讨论了你可能遇到的几个真实案例，从一些最简单、最容易解决的案例到更复杂的问题。书中描述的案例可能不是最常见的，但它们仍然提供了有关软件内部工作原理和故障排除方法的宝贵见解。

第六章, *监控 Nginx*，专门讨论了今天可用的各种监控工具。没有良好的问题检测流程，任何系统都不完整。

第七章, *使用 Nginx 进行进一步发展*，是简短的最后一章，提供了你作为专业人士进一步发展的几个方向。整个行业发展迅速，你永远不应停滞不前。

附录, *罕见的 Nginx 错误信息*，提供了一个参考，列出了你可能在日志文件中遇到的有趣且不太常见的错误信息。

# 本书所需的内容

尽管现代版本的 Nginx 支持 Windows，但此配置不被认为是生产环境准备就绪。书中的大部分示例可以在你的 Windows 机器上运行，但我们仍然建议你使用 Linux 或 FreeBSD 服务器进行实验。

Nginx 本身非常稳定，因此自 2013 年以来发布的任何版本都足够使用。某些新特性仅在更新版本中提供，这些情况在书中会特别标注。我们始终建议在生产环境中运行稳定版的现代 Nginx。截至 2016 年年初，稳定版为 1.8.1。

# 本书的适用对象

本书适用于已经使用 Nginx 为用户提供网页的技术专家。无论你是经验丰富的系统管理员，还是刚刚入行的专业人士，本书都将帮助你以最有效的方式完成工作。

# 约定

在本书中，您将看到多种文本样式，用于区分不同类型的信息。以下是一些样式示例及其含义的解释。

文本中的代码词、数据库表名、文件夹名、文件名、文件扩展名、路径名、虚拟网址、用户输入和 Twitter 用户名将如下所示：“`error_page`指令基于著名的 HTTP 状态码安装一个 HTTP 错误处理程序。”

一块代码的设置如下：

```
...
simple_command 4 "two";
# another_simple_command 0;

special_context {
    some_special_command /new/path;
    multiline_directive param {
        1 2 3 5 8 13;
    }
    include common_parameters;
}
...
```

当我们希望吸引您注意某个代码块的特定部分时，相关行或项目将以粗体显示：

```
Cache-Control:"max-age=1800"
Content-Encoding:"gzip"
Content-Type:"text/html; charset=UTF-8"
Date:"Sun, 10 Oct 2015 13:42:34 GMT"
Expires:"Sun, 10 Oct 2015 14:12:34 GMT"
Server:"nginx"
X-Cache:"EXPIRED"
```

任何命令行输入或输出都将如下所示：

```
% sudo nginx -t
nginx: [emerg] unexpected end of file, expecting "}" in /etc/nginx/nginx.conf:1
nginx: configuration file /etc/nginx/nginx.conf test failed

```

**新术语**和**重要单词**以粗体显示。您在屏幕上看到的词汇，例如在菜单或对话框中，会以以下方式出现在文本中：“您应该有一种方法重新启动无法访问的服务器；每个理智的现代托管提供商都具备此功能，无论是通过简单的菜单项**重启**，例如在 Amazon EC2 中，还是通过完整的 IPMI 控制台访问。”

### 注意

警告或重要说明会以如下框的形式显示。

### 提示

提示和技巧会以如下形式显示。

# 读者反馈

我们总是欢迎读者的反馈。让我们知道您对本书的看法——您喜欢或不喜欢什么。读者反馈对我们非常重要，它帮助我们开发出您真正能从中获益的书籍。

若要向我们提供一般反馈，请通过电子邮件发送至`<feedback@packtpub.com>`，并在邮件主题中提及书名。

如果您在某个领域有专业知识，并且有兴趣为书籍撰写或贡献内容，请参阅我们的作者指南，网址是[www.packtpub.com/authors](http://www.packtpub.com/authors)。

# 客户支持

现在，您已成为 Packt 书籍的骄傲拥有者，我们有一些内容帮助您充分利用您的购买。

## 下载示例代码

您可以从[`www.packtpub.com`](http://www.packtpub.com)账户中下载本书的示例代码文件。如果您从其他地方购买了此书，可以访问[`www.packtpub.com/support`](http://www.packtpub.com/support)，并注册将文件直接发送到您的电子邮件。

您可以通过以下步骤下载代码文件：

1.  使用您的电子邮件地址和密码登录或注册我们的官方网站。

1.  将鼠标指针悬停在顶部的**支持**标签上。

1.  点击**代码下载与勘误**。

1.  在**搜索**框中输入书名。

1.  选择您要下载代码文件的书籍。

1.  从下拉菜单中选择您购买此书的平台。

1.  点击**代码下载**。

您还可以通过点击本书在 Packt 出版网站上的网页上的**代码文件**按钮下载代码文件。您可以通过在**搜索**框中输入书名来访问此页面。请注意，您需要登录您的 Packt 账户。

下载文件后，请确保使用最新版本的以下软件解压或提取文件夹：

+   WinRAR / 7-Zip for Windows

+   Zipeg / iZip / UnRarX for Mac

+   7-Zip / PeaZip for Linux

## 下载本书的彩色图像

我们还为您提供了一份包含本书截图/图表彩色图像的 PDF 文件。这些彩色图像将帮助您更好地理解输出结果的变化。您可以从[`www.packtpub.com/sites/default/files/downloads/NginxTroubleshooting_ColorImages.pdf`](https://www.packtpub.com/sites/default/files/downloads/NginxTroubleshooting_ColorImages.pdf)下载此文件。

## 勘误

尽管我们已经尽一切努力确保内容的准确性，但错误还是可能发生。如果您在我们的书籍中发现错误——可能是文本或代码中的错误——我们将非常感激您向我们报告。通过这样做，您可以帮助其他读者避免困扰，并帮助我们改进后续版本的书籍。如果您发现任何勘误，请通过访问[`www.packtpub.com/submit-errata`](http://www.packtpub.com/submit-errata)，选择您的书籍，点击**勘误提交表单**链接，并输入勘误的详细信息。您的勘误一旦被验证，将被接受并上传到我们的网站或添加到该书籍的勘误部分中。

要查看之前提交的勘误信息，请访问[`www.packtpub.com/books/content/support`](https://www.packtpub.com/books/content/support)，并在搜索框中输入书名。所需的信息将在**勘误**部分显示。

## 盗版

互联网上的版权盗版问题在所有媒体中都普遍存在。在 Packt，我们非常重视保护我们的版权和许可。如果您在互联网上遇到我们作品的任何非法复制，请立即提供其位置地址或网站名称，以便我们采取相应的措施。

请通过 `<copyright@packtpub.com>` 联系我们，并提供可疑盗版材料的链接。

我们感谢您在保护我们的作者和我们提供有价值内容方面的帮助。

## 问题

如果您在本书的任何方面遇到问题，可以通过 `<questions@packtpub.com>` 与我们联系，我们将尽力解决该问题。
